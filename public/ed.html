<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Learnney</title>
    <link rel="icon" type="image/png" href="https://img.icons8.com/material-rounded/48/3b82f6/double-tick.png">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Sarabun:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>

      :root {
          /* --- NEW: Azure Flow Theme --- */
          --accent-color: #3B82F6; /* blue-500 */
          --accent-hover: #2563EB; /* blue-600 */
          --accent-light: rgba(59, 130, 246, 0.1);
          --accent-darker: #1D4ED8; /* blue-700 */

          --bg-main: #f0f4f8; /* A slightly cooler grey */
          --bg-card: #ffffff;
          --bg-sidebar: #111827;
          --bg-overlay: rgba(0,0,0,0.5);
          --border-color: #e5e7eb;
          --primary-text: #1f2937;
          --secondary-text: #6b7280;
          --sidebar-text: #9ca3af;
          --sidebar-text-hover: #ffffff;
          --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1);
          --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);

          --danger-color: #ef4444; --danger-hover: #dc2626;
          --success-color: #22c55e; --warning-color: #f59e0b; --info-color: #0ea5e9;
          --font-family: 'Inter', 'Sarabun', sans-serif;
      }
      :root.dark-mode {
          /* --- NEW: Dark Mode with Glassmorphism in mind --- */
          --bg-main: #0d1117;
          --bg-card: rgba(29, 40, 57, 0.7); /* Semi-transparent for glass effect */
          --bg-sidebar: rgba(12, 17, 24, 0.85);
          --bg-overlay: rgba(0,0,0,0.6);
          --border-color: #374151;
          --primary-text: #f9fafb;
          --secondary-text: #9ca3af;
          --accent-light: rgba(59, 130, 246, 0.15);
      }

      /* --- NEW: Animations & Effects --- */
      @keyframes animated-gradient {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
      }
      @keyframes view-enter-active {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
      }
      @keyframes stagger-in {
        from { opacity: 0; transform: translateY(20px) scale(0.98); }
        to { opacity: 1; transform: translateY(0) scale(1); }
      }
      @keyframes subtle-pulse { 
        0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4); } 
        70% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); } 
        100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); } 
      }

      *, *::before, *::after { box-sizing: border-box; }
      html, body { overscroll-behavior-x: none; color: var(--primary-text); transition: background-color 0.3s ease, color 0.3s ease; }
      body { 
          font-family: var(--font-family); margin: 0; 
          background: var(--bg-main);
          background: linear-gradient(125deg, var(--bg-main), var(--accent-light), var(--bg-main));
          background-size: 400% 400%;
          animation: animated-gradient 30s ease infinite;
      }
      button, a, input, select, textarea, .list-item, .nav-btn { touch-action: manipulation; font-family: var(--font-family); }

      .app-layout { display: flex; min-height: 100vh; }
      .sidebar { 
        width: 250px; background-color: var(--bg-sidebar); padding: 1.5rem; border-right: 1px solid var(--border-color); 
        display: flex; flex-direction: column; transition: all 0.3s ease; flex-shrink: 0; position: relative;
        backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
      }
      .main-content { flex-grow: 1; padding: 2rem 3rem; overflow-y: auto; overflow-x: hidden; transition: padding 0.3s ease; max-width: 1400px; margin: 0 auto; }
      .grid-layout { display: grid; gap: 1.5rem; grid-template-columns: 1fr; }
      .full-width-card { grid-column: 1 / -1; }
      .management-layout { display: grid; grid-template-columns: 350px 1fr; gap: 1.5rem; }
      .analytics-layout { display: grid; gap: 1.5rem; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); }

      .view-content { display: none; }
      .view-content.active { display: block; animation: view-enter-active 0.5s cubic-bezier(0.215, 0.610, 0.355, 1) forwards; }

      .main-header-bar { display: flex; justify-content: space-between; align-items: center; gap: 1.5rem; margin-bottom: 2rem; }
      .page-header { display: flex; justify-content: space-between; align-items: center; margin: 0 0 2rem 0; }
      .page-header h1 { font-size: 1.75rem; font-weight: 700; margin: 0; }
      .view-description { color: var(--secondary-text); margin: -1.5rem 0 2rem 0; max-width: 800px; line-height: 1.6; }
      .sidebar-header { display: flex; align-items: center; gap: 0.75rem; font-size: 1.25rem; font-weight: 700; color: white; margin-bottom: 2.5rem; padding: 0 0.5rem; }
      .sidebar-header i { color: var(--accent-color); }
      .nav-menu { list-style: none; padding: 0; margin: 0; flex-grow: 1; }
      .nav-item button, .nav-item a { width: 100%; display: flex; align-items: center; gap: 1rem; padding: 0.75rem 1rem; margin-bottom: 0.5rem; border-radius: 6px; font-size: 0.9rem; font-weight: 500; color: var(--sidebar-text); background: none; border: none; cursor: pointer; text-align: left; transition: all 0.2s ease; text-decoration: none; }
      .nav-item button:hover, .nav-item a:hover { background-color: rgba(255,255,255,0.1); color: var(--sidebar-text-hover); transform: translateX(5px); }
      .nav-item button.active { background-color: var(--accent-color); color: white; }
      #logout-btn:hover { background-color: rgba(239, 68, 68, 0.2); color: var(--danger-color); }
      .nav-item i { width: 20px; text-align: center; }
      .sidebar-footer { margin-top: auto; padding-top: 1rem; border-top: 1px solid var(--border-color); }
      .theme-toggle-btn { width: 100%; background-color: var(--bg-card); color: var(--secondary-text); border: 1px solid var(--border-color); padding: 0.5rem; border-radius: 6px; cursor: pointer; transition: all 0.2s ease; }
      .theme-toggle-btn:hover { background-color: var(--accent-color); color: white; }
      .theme-toggle-btn .fa-sun { display: none; } .theme-toggle-btn .fa-moon { display: block; }
      :root:not(.dark-mode) .theme-toggle-btn .fa-sun { display: block; } :root:not(.dark-mode) .theme-toggle-btn .fa-moon { display: none; }

      .card { 
        background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 12px; padding: 1.5rem; 
        box-shadow: var(--shadow); transition: all 0.3s ease;
        backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
      }
      .card:hover { transform: translateY(-5px); box-shadow: var(--shadow-lg); }
      .card + .card, .banner + .card, .view-description + .card { margin-top: 1.5rem; }
      .banner + .grid-layout { margin-top: 1.5rem; }
      .card-header { display: flex; justify-content: space-between; align-items: center; gap: 0.5rem; margin-bottom: 1rem; }
      .card-header i { color: var(--secondary-text); }
      .card-header h3, .card-header h4 { margin: 0; font-size: 1rem; font-weight: 600; flex-grow: 1;}
      .card-description { color: var(--secondary-text); margin-top: 0; margin-bottom: 1rem; line-height: 1.6; font-size: 0.9rem; }
      .stats-container-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 1rem; text-align: center; padding: 0.5rem 0; }
      .stat-item { animation: stagger-in 0.5s cubic-bezier(0.215, 0.610, 0.355, 1) backwards; }
      .stat-value { font-size: 1.75rem; font-weight: 700; color: var(--primary-text); }
      .stat-label { font-size: 0.75rem; color: var(--secondary-text); text-transform: uppercase; letter-spacing: 0.5px; }

      input, select, textarea { width: 100%; box-sizing: border-box; padding: 0.6rem 0.75rem; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.9rem; background-color: var(--bg-main); color: var(--primary-text); transition: all 0.2s ease; }
      input:focus, select:focus, textarea:focus { border-color: var(--accent-color); box-shadow: 0 0 0 3px var(--accent-light); outline: none; }
      textarea { resize: vertical; }
      .form-inline { display: flex; gap: 0.5rem; margin-bottom: 1rem; }
      .form-group { margin-bottom: 1rem; }
      .form-group label { display: block; font-size: 0.85rem; font-weight: 500; margin-bottom: 0.5rem; color: var(--secondary-text); }
      .btn { padding: 0.6rem 1rem; background-color: var(--accent-color); color: white; border: none; border-radius: 6px; font-weight: 500; cursor: pointer; transition: all 0.2s ease; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; text-decoration: none; }
      .btn:hover { background-color: var(--accent-hover); transform: translateY(-2px); }
      .btn[disabled] { background-color: var(--secondary-text); opacity: 0.7; cursor: not-allowed; }
      .btn-secondary { background-color: #6b7280; } .btn-secondary:hover { background-color: #4b5563; }
      .btn-danger { background-color: var(--danger-color); } .btn-danger:hover { background-color: #dc2626; }
      .btn-warning { background-color: var(--warning-color); color: white; } .btn-warning:hover { background-color: var(--d97706); }
      .btn-success { background-color: var(--success-color); } .btn-success:hover { background-color: #16a34a; }
      .btn-icon { flex-shrink: 0; width: 38px; height: 38px; padding: 0; }
      .btn-sm { padding: 0.4rem 0.8rem; font-size: 0.8rem; }
      .search-container { position: relative; flex-grow: 1; max-width: 600px; }
      .search-container .fa-search { position: absolute; top: 50%; left: 1rem; transform: translateY(-50%); color: var(--secondary-text); pointer-events: none; z-index: 1; }
      #global-search-input { padding-left: 2.75rem; height: 40px; }
      .search-dropdown { display: none; position: absolute; top: calc(100% + 5px); left: 0; right: 0; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); z-index: 100; max-height: 300px; overflow-y: auto; backdrop-filter: blur(5px); }
      .search-dropdown.active { display: block; }
      .search-dropdown-item { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 1rem; cursor: pointer; border-bottom: 1px solid var(--border-color); }
      .search-dropdown-item:last-child { border-bottom: none; }
      .search-dropdown-item:hover { background-color: var(--bg-main); }
      .search-dropdown-item .name { font-weight: 500; }
      .search-dropdown-item .context { font-size: 0.8rem; color: var(--secondary-text); }
      .search-dropdown .empty-state { padding: 1.5rem; cursor: default; }
      .list { list-style: none; padding: 0; margin: 0; }
        .list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
            padding: 1rem 0.75rem;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.9rem;
            transition: background-color 0.2s ease, border-left 0.2s ease;
            flex-wrap: wrap;
            /* บรรทัดที่เกี่ยวกับ animation ถูกลบออกไปหมดแล้ว */
        }
      .list-item:last-child { border-bottom: none; }
      .list-item .item-info { flex-grow: 1; display: flex; align-items: center; gap: 0.75rem; min-width: 0; cursor: pointer; }
      .list-item .item-info .name { flex-grow: 1; padding: 0.25rem; border-radius: 4px; border: 1px solid transparent; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
      .list-item .item-info .edit-input { flex-grow: 1; padding: 0.2rem 0.25rem; font-size: 0.9rem; }
      .list-item .item-actions { display: flex; gap: 0.5rem; flex-shrink: 0; }
      #todays-queue-list .list-item .item-actions, .list-item:hover .item-actions { opacity: 1; visibility: visible; }
      #todays-queue-list .list-item .item-actions { margin-left: auto; }
      .list-item:hover .item-actions { opacity: 1; visibility: visible; }
      .list-item .btn-action-icon { background: none; border: none; color: var(--secondary-text); width: 32px; height: 32px; border-radius: 50%; cursor: pointer; transition: all 0.2s ease; font-size: 0.9rem; }
      .list-item .btn-action-icon:hover { color: var(--primary-text); background-color: var(--border-color); }
      .list-item:not(.editing) .edit-input { display: none; }
      .list-item.editing .name { display: none; }
      .list-item.editing .item-info { cursor: default; }
      .list-item.editing .edit-input { border-color: var(--accent-color); }
      .list-item .context { font-size: 0.8rem; color: var(--secondary-text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex-shrink: 0; padding-left: 1rem; }
      #subjects-view .list-item .context { margin-left: auto; }
      #subjects-list .list-item.active { background-color: var(--accent-color); color: white; border-radius: 6px; border-color: var(--accent-color); }
      #subjects-list .list-item.active .item-actions { opacity: 1; visibility: visible; }
      #subjects-list .list-item.active .name, #subjects-list .list-item.active .context { color: white; }
      #subjects-list .list-item.active .btn-action-icon { color: white; }
      #subjects-list .list-item.active .btn-action-icon:hover { background-color: rgba(255,255,255,0.2); }
      #topics-for-subject-list .list-item:hover, #leech-list .list-item:hover, #custom-study-subject-list .list-item:hover { background-color: var(--bg-main); }
      .empty-state { text-align: center; padding: 2rem; color: var(--secondary-text); font-style: italic; cursor: default; line-height: 1.7; animation: none; opacity: 1; transform: none; }
      .empty-state-actions { display: flex; justify-content: center; gap: 1rem; }
      #subjects-list, #topics-for-subject-list, #leech-list, #custom-study-subject-list, #achievements-list { max-height: 500px; overflow-y: auto; padding-right: 8px; }
      .list-divider { width: 100%; padding: 1rem 0.5rem 0.5rem; font-size: 0.8rem; font-weight: 600; color: var(--secondary-text); text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid var(--border-color); animation: none; opacity: 1; transform: none; }
      .list-divider:not(:first-child) { margin-top: 1rem; }
      .list-item.learning-item .item-info { cursor: pointer; }
      .list-item.learning-item .name { color: var(--primary-text); }
      .list-item.learning-item .cooldown-timer { font-size: 0.85rem; font-weight: 500; color: var(--warning-color); white-space: nowrap; }
      .modal-container { 
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
        background-color: var(--bg-overlay); z-index: 1000; backdrop-filter: blur(4px); 
        opacity: 0; pointer-events: none; transition: opacity 0.3s ease; 
        display: flex; justify-content: center; align-items: center; padding: 1rem; 
      }
      .modal-container.active { opacity: 1; pointer-events: all; }
      .modal-content { 
        background: var(--bg-card); border: 1px solid var(--border-color); 
        transform: translateY(30px) scale(0.98); opacity: 0; 
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        padding: 1.5rem 2rem; border-radius: 12px; width: 100%; max-width: 420px; 
        box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); position: relative; max-height: 90vh; 
        overflow-y: auto; text-align: center;
      }
      .modal-content.wide { max-width: 800px; text-align: left; }
      .modal-container.active .modal-content { transform: translateY(0) scale(1); opacity: 1; }
      .modal-close-btn { position: absolute; top: 0.75rem; right: 0.75rem; background: none; border: none; color: var(--secondary-text); font-size: 1.2rem; cursor: pointer; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; z-index: 10; }
      .modal-close-btn:hover { background-color: var(--border-color); }
      .modal-header-actions { display: flex; align-items: center; justify-content: space-between; gap: 1rem; margin-bottom: 0.5rem; }
      .modal-header-actions h3 { margin: 0; flex-grow: 1; }
      .modal-content p { color: var(--secondary-text); margin: 0 0 1.5rem 0; font-size: 0.9rem; line-height: 1.6; }
      #delete-subject-warning, #delete-topic-warning { text-align: center; }
      .modal-actions { display: grid; gap: 0.75rem; }
      .btn-rate { padding: 0.75rem 0.5rem; border-radius: 8px; border: 1px solid var(--border-color); background: transparent; color: var(--primary-text); cursor: pointer; font-size: 0.9rem; transition: all 0.2s ease; display: flex; flex-direction: column; align-items: center; justify-content: center; line-height: 1.3; text-align: center; }
      .btn-rate:hover { transform: translateY(-3px); box-shadow: 0 4px 10px rgba(0,0,0,0.1); border-color: currentColor; }
      .btn-rate strong { font-size: 1rem; font-weight: 700; }
      .btn-rate .rating-desc { font-size: 0.7rem; color: var(--secondary-text); font-weight: 400; margin-top: 4px; }
      .rating-again { color: var(--danger-color); } .rating-hard { color: var(--warning-color); } .rating-good { color: var(--success-color); } .rating-easy { color: var(--accent-color); }
      .checkbox-label { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background-color: var(--bg-main); border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer; transition: all 0.2s ease; }
      .checkbox-label:hover { border-color: var(--accent-color); }
      .checkbox-label:has(input:checked) { background-color: var(--accent-color); color: white; border-color: var(--accent-color); }
      .checkbox-label input[type="checkbox"] { width: 1rem; height: 1rem; flex-shrink: 0; accent-color: var(--accent-hover); }
      #reflection-options { display: flex; flex-direction: column; gap: 0.75rem; }
      .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--bg-overlay); z-index: 10000; display: flex; flex-direction:column; justify-content: center; align-items: center; backdrop-filter: blur(4px); transition: opacity 0.3s ease; color: white; gap: 1rem; }
      .spinner { width: 50px; height: 50px; border: 5px solid rgba(255,255,255,0.3); border-top: 5px solid var(--accent-color); border-radius: 50%; animation: spin 1s linear infinite; }
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
      .toast-container { position: fixed; top: 20px; right: 20px; z-index: 10001; display: flex; flex-direction: column; gap: 10px; }
      .toast { background-color: var(--primary-text); color: var(--bg-card); padding: 1rem 1.5rem; border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); display: flex; align-items: center; gap: 1rem; animation: toast-in-right 0.5s ease; user-select: none; }
      .toast.success { background-color: #22c55e; color: white; }
      .toast.error { background-color: #ef4444; color: white; }
      .toast.info { background-color: #0ea5e9; color: white; }
      .toast.achievement { background: linear-gradient(45deg, #f59e0b, #fde047); color: #422006; font-weight: 600; border: 1px solid #fde047; }
      .toast.achievement .fa-trophy { color: #b45309; }
      @keyframes toast-in-right { from { transform: translateX(120%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
      @keyframes toast-out-right { to { transform: translateX(120%); opacity: 0; } }
      .countdown-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 1.5rem; padding: 1rem 0; }
      .countdown-item { background-color: var(--bg-main); padding: 1.5rem; border-radius: 12px; border: 1px solid var(--border-color); text-align: center; transition: all 0.3s ease; }
      .countdown-item:hover { transform: translateY(-5px); box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
      .dark-mode .countdown-item:hover { border-color: var(--accent-color); }
      .countdown-title { display: block; font-size: 1.1rem; font-weight: 600; color: var(--accent-color); margin-bottom: 1.5rem; letter-spacing: 0.5px; }
      .countdown-timer { display: flex; justify-content: center; gap: 1rem; }
      .countdown-timer > div { display: flex; flex-direction: column; align-items: center; justify-content: center; background-color: var(--bg-card); border-radius: 8px; width: 75px; height: 75px; box-shadow: var(--shadow); border: 1px solid transparent; }
      .countdown-timer span[data-unit] { font-family: 'Roboto Mono', 'Fira Code', monospace; font-size: 2.25rem; font-weight: 700; color: var(--primary-text); line-height: 1.1; }
      .countdown-timer label { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1px; color: var(--secondary-text); margin-top: 4px; }
      .chart-wrapper { position: relative; height: 300px; width:100%; margin: 1rem auto 0 auto; }
      .history-list { list-style: none; padding: 0; margin: 0; max-height: 250px; overflow-y: auto; text-align: left; }
      .history-list li { padding: 0.75rem 1rem; border-radius: 6px; }
      .history-list li:not(:last-child) { margin-bottom: 0.75rem; }
      .history-list li.rating-again { border-left: 4px solid var(--danger-color); background-color: rgba(239, 68, 68, 0.05); }
      .history-list li.rating-hard { border-left: 4px solid var(--warning-color); background-color: rgba(245, 158, 11, 0.05); }
      .history-list li.rating-good { border-left: 4px solid var(--success-color); background-color: rgba(34, 197, 94, 0.05); }
      .history-list li.rating-easy { border-left: 4px solid var(--accent-color); background-color: var(--accent-light); }
      @media (max-width: 1200px) { .management-layout { grid-template-columns: 300px 1fr; } }
      @media (max-width: 992px) { .main-content { padding: 1.5rem 2rem; } .management-layout { grid-template-columns: 1fr; } }
      @media (max-width: 768px) { .sidebar { position: fixed; left: -250px; z-index: 1100; height: 100%; } .main-content { padding: 1.5rem; } .main-header-bar { flex-direction: column; align-items: stretch; } .page-header h1 { font-size: 1.5rem; } }
      .details-primary-info, .details-secondary-info { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin: 1.5rem 0; }
      .details-primary-info .stat-card { background-color: var(--bg-main); border: 1px solid var(--border-color); border-radius: 8px; padding: 1rem; display: flex; align-items: center; gap: 1rem; }
      .details-primary-info .stat-card i { font-size: 1.75rem; color: var(--accent-color); }
      .details-primary-info .stat-card label { font-size: 0.8rem; color: var(--secondary-text); margin-bottom: 0.25rem; display: block; }
      .details-primary-info .stat-card span { font-size: 1.1rem; font-weight: 600; color: var(--primary-text); }
      .details-section-divider { display: flex; align-items: center; gap: 1rem; color: var(--secondary-text); font-size: 0.8rem; text-transform: uppercase; margin: 2rem 0 1rem 0; }
      .details-section-divider hr { flex-grow: 1; border: none; border-top: 1px solid var(--border-color); }
      .history-list li { display: flex; justify-content: space-between; align-items: center; }
      .history-item-rating { font-weight: 600; }
      .history-item-details { font-size: 0.8rem; color: var(--secondary-text); margin-top: 4px; }
      .history-item-date { font-size: 0.85rem; color: var(--secondary-text); text-align: right; }
      .tooltip { position: relative; cursor: pointer; color: var(--secondary-text); }
      .tooltip .fa-circle-info { font-size: 0.9em; margin-left: 4px; }
      .tooltip::after { content: attr(data-tooltip); position: absolute; bottom: 125%; left: 50%; transform: translateX(-50%); background-color: #333; color: #fff; padding: 0.5rem 0.75rem; border-radius: 6px; font-size: 0.8rem; white-space: nowrap; opacity: 0; visibility: hidden; transition: opacity 0.2s ease, visibility 0.2s ease; z-index: 10; width: max-content; max-width: 300px; text-align: center;}
      .dark-mode .tooltip::after { background-color: var(--bg-main); color: var(--primary-text); border: 1px solid var(--border-color); }
      .tooltip:hover::after { opacity: 1; visibility: visible; }
      .priority-indicator { display: inline-block; width: 24px; text-align: center; font-size: 1.1rem; }
      .list-item.priority-urgent { border-left: 4px solid var(--danger-color); background-color: rgba(239, 68, 68, 0.05); }
      .list-item.priority-high { border-left: 4px solid var(--warning-color); background-color: rgba(245, 158, 11, 0.05); }
      .header-actions-wrapper { display: flex; align-items: center; gap: 0.5rem; flex-shrink: 0; flex-wrap: wrap; }
      .user-profile-pill { display: flex; align-items: center; gap: 0.6rem; background-color: var(--bg-card); padding: 0.5rem 0.9rem; border-radius: 20px; font-size: 0.85rem; font-weight: 500; color: var(--secondary-text); border: 1px solid var(--border-color); transition: all 0.2s ease; cursor: pointer; }
      .user-profile-pill:hover { background-color: var(--bg-main); border-color: var(--accent-color); color: var(--primary-text); }
      .user-profile-pill i { color: var(--accent-color); }
      .user-profile-pill span { max-width: 150px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
      #orientation-lock { display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background-color: var(--bg-main); color: var(--primary-text); z-index: 20000; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 2rem; }
      #orientation-lock i { font-size: 4rem; margin-bottom: 1.5rem; color: var(--accent-color); }
      #orientation-lock p { font-size: 1.2rem; font-weight: 500; line-height: 1.6; max-width: 400px; }

      #layout-toggle-btn { position: absolute; top: 1.25rem; right: -16px; width: 32px; height: 32px; background-color: var(--bg-sidebar); color: var(--sidebar-text-hover); border: 1px solid var(--border-color); border-radius: 50%; cursor: pointer; z-index: 1200; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease; }
      #layout-toggle-btn:hover { background-color: var(--accent-color); transform: scale(1.1); }
      .top-nav-container { display: none; align-items: center; gap: 1rem; padding-bottom: 1rem; margin-bottom: 1.5rem; border-bottom: 1px solid var(--border-color); }
      .app-layout.header-mode .sidebar { width: 0; padding-left: 0; padding-right: 0; overflow: hidden; border-right: none; }
      .app-layout.header-mode .sidebar > * { opacity: 0; pointer-events: none; }
      .app-layout.header-mode .top-nav-container { display: flex; }
      .app-layout.header-mode #layout-toggle-btn { position: static; flex-shrink: 0; background-color: var(--bg-card); color: var(--primary-text); border-color: var(--border-color); }
      .top-nav-container .nav-menu { display: flex; flex-direction: row; align-items: center; flex-grow: 1; gap: 0.5rem; }
      .top-nav-container .nav-item { margin: 0; }
      .top-nav-container .nav-item button, .top-nav-container .nav-item a { width: auto; margin-bottom: 0; padding: 0.5rem 1rem; color: var(--primary-text); }
      .top-nav-container .nav-item button:hover, .top-nav-container .nav-item a:hover { background-color: var(--border-color); color: var(--primary-text); }
      .top-nav-container .nav-item button.active { background-color: var(--accent-color); color: white; }
      .top-nav-container .nav-item a#logout-btn:hover { color: var(--danger-color); background-color: rgba(239, 68, 68, 0.1); }
      .top-nav-container .sidebar-footer { display: none; }
      .fab-container { position: fixed; bottom: 2rem; right: 2rem; z-index: 999; display: flex; flex-direction: column-reverse; align-items: center; pointer-events: none; }
      .fab-main-btn { background-color: var(--accent-color); color: white; width: 56px; height: 56px; border-radius: 50%; border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.2); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: transform 0.3s ease, background-color 0.3s ease; }
      .fab-main-btn i { font-size: 1.5rem; transition: transform 0.3s ease; }
      .fab-container.active .fab-main-btn { transform: rotate(45deg); background-color: var(--accent-hover); }
      .fab-options { display: flex; flex-direction: column; align-items: center; list-style: none; padding: 0; margin: 0; margin-bottom: 1rem; opacity: 0; visibility: hidden; transform: translateY(10px); transition: opacity 0.3s ease, visibility 0.3s ease, transform 0.3s ease; }
      .fab-container.active .fab-options { opacity: 1; visibility: visible; transform: translateY(0); }
      .fab-options li { margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.75rem; justify-content: flex-end; width: 100%; }
      .fab-label { background-color: var(--bg-card); color: var(--primary-text); padding: 0.4rem 0.8rem; border-radius: 4px; box-shadow: var(--shadow); font-size: 0.85rem; font-weight: 500; white-space: nowrap; }
      .fab-btn-sm { width: 40px; height: 40px; border-radius: 50%; border: none; background-color: var(--bg-card); color: var(--primary-text); box-shadow: var(--shadow); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background-color 0.2s; }
      .fab-btn-sm:hover { background-color: var(--border-color); }
      .fab-main-btn, .fab-options li { pointer-events: auto; }
      .analytics-filter-container { display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem; max-width: 400px; }
      .analytics-filter-container label { margin-bottom: 0; flex-shrink: 0; }
      #reason-details-card { transition: all 0.3s ease; border-left: 4px solid var(--info-color); }
      #reason-details-list { max-height: 400px; overflow-y: auto; }
      #reason-details-list .list-item { padding: 0.75rem; border-radius: 6px; transition: background-color 0.2s ease; }
      #reason-details-list .list-item:hover { background-color: var(--bg-main); }
      #reason-details-list .list-item .context { font-size: 0.85rem; margin-left: auto; padding-left: 1rem; background-color: var(--bg-main); padding: 0.2rem 0.6rem; border-radius: 12px; color: var(--secondary-text); }
      .list-item.overdue { border-left: 4px solid var(--danger-color); background-color: rgba(239, 68, 68, 0.05); }
      .list-item.overdue .name::before { content: " "; color: var(--danger-color); font-weight: bold; }
      .dashboard-alert { grid-column: 1 / -1; background-color: rgba(239, 68, 68, 0.1); border: 1px solid var(--danger-color); border-left: 4px solid var(--danger-color); color: var(--danger-color); padding: 1rem 1.5rem; border-radius: 8px; margin-bottom: 1.5rem; font-weight: 500; display: flex; align-items: center; gap: 1rem; animation: view-enter-active 0.4s ease forwards; }
      .dark-mode .dashboard-alert { background-color: rgba(239, 68, 68, 0.15); }
      .review-category-bar { display: flex; flex-wrap: wrap; gap: 0.75rem;  margin: 0.5rem 0 1rem 0; padding-bottom: 5px; }
      .review-cat-btn { padding: 0.5rem 1rem; border-radius: 8px; border: none; background-color: var(--bg-main); color: var(--primary-text); font-size: 0.875rem; font-weight: 500; cursor: pointer; transition: background-color 0.2s ease, color 0.2s ease; }
      .dark-mode .review-cat-btn { background-color: var(--border-color); }
      .review-cat-btn:hover { background-color: var(--border-color); }
      .dark-mode .review-cat-btn:hover { background-color: #4b5563; }
      .review-cat-btn.active { background-color: var(--primary-text); color: var(--bg-card); }
      .review-cat-btn:first-child { padding: 0; width: 38px; height: 38px; display: flex; align-items: center; justify-content: center; }

      /* --- NEW: Topic Type Switcher Styles --- */
      .topic-type-switcher { display: flex; gap: 0.5rem; margin-bottom: 1.5rem; }
      .topic-type-switcher label { flex: 1; text-align: center; padding: 0.6rem; border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer; transition: all 0.2s ease; }
      .topic-type-switcher input[type="radio"] { display: none; }
      .topic-type-switcher input[type="radio"]:checked + label { background-color: var(--accent-color); color: white; border-color: var(--accent-color); }
      .topic-type-switcher label:hover { border-color: var(--accent-hover); }

      /* --- NEW: Flashcard display styles --- */
      .flashcard-display { border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden;}
      .flashcard-front, .flashcard-back { padding: 1rem 1.5rem; line-height: 1.7; white-space: pre-wrap; word-wrap: break-word; }
      .flashcard-front strong, .flashcard-back strong { display: block; margin-bottom: 0.5rem; font-size: 0.8rem; color: var(--secondary-text); text-transform: uppercase; }
      .flashcard-front { border-bottom: 1px dashed var(--border-color); }

      /* --- Review Session Styles --- */
      #review-session-modal .modal-content { max-width: 700px; text-align: left; }
      .review-content-area { min-height: 150px; display: flex; align-items: center; justify-content: center; padding: 1rem; text-align: left; line-height: 1.7; white-space: pre-wrap; word-wrap: break-word; font-size: 1.1rem; }
      #review-bulk-progress { font-size: 0.9rem; font-weight: 500; color: var(--secondary-text); text-align: center; margin-bottom: 1rem; }
          .history-item-rating + .tooltip {
              margin-left: 0.75rem;
              display: inline-flex;
              align-items: center;
              color: var(--secondary-text);
          }
          .history-item-rating + .tooltip i {
              font-size: 0.9em;
          }

      /* --- Heatmap Styles (Adjusted for Blue Theme) --- */
      .heatmap-container { display: grid; grid-template-rows: repeat(7, 1fr); grid-auto-flow: column; grid-auto-columns: min-content; gap: 4px; padding-bottom: 1rem; overflow-x: auto; scrollbar-width: thin; }
      .heatmap-day { width: 14px; height: 14px; background-color: var(--border-color); border-radius: 3px; position: relative; }
      .heatmap-day[data-count] { cursor: pointer; }
      .heatmap-day[data-count="0"] { background-color: var(--border-color); }
      .dark-mode .heatmap-day[data-count="0"] { background-color: #374151; }
      .heatmap-day.level-1 { background-color: #BFDBFE; } .dark-mode .heatmap-day.level-1 { background-color: #1E3A8A; } /* blue-200, blue-900 */
      .heatmap-day.level-2 { background-color: #93C5FD; } .dark-mode .heatmap-day.level-2 { background-color: #1E40AF; } /* blue-300, blue-800 */
      .heatmap-day.level-3 { background-color: #60A5FA; } .dark-mode .heatmap-day.level-3 { background-color: #1D4ED8; } /* blue-400, blue-700 */
      .heatmap-day.level-4 { background-color: #3B82F6; } .dark-mode .heatmap-day.level-4 { background-color: #2563EB; } /* blue-500, blue-600 */
      .heatmap-day .heatmap-tooltip { display: none; position: absolute; bottom: 120%; left: 50%; transform: translateX(-50%); background-color: #333; color: white; padding: 5px 10px; border-radius: 5px; font-size: 0.8rem; white-space: nowrap; z-index: 100; pointer-events: none; }
      .dark-mode .heatmap-day .heatmap-tooltip { background-color: var(--bg-card); color: var(--primary-text); border: 1px solid var(--border-color); }
      .heatmap-day:hover .heatmap-tooltip { display: block; }
      .heatmap-labels { display: flex; justify-content: space-between; font-size: 0.75rem; color: var(--secondary-text); padding: 0.5rem 0; }
      .heatmap-legend { display: flex; align-items: center; justify-content: flex-end; gap: 0.5rem; font-size: 0.8rem; color: var(--secondary-text); margin-top: 1rem; }
      .heatmap-legend .box { width: 12px; height: 12px; border-radius: 2px; }

      /* --- FIXED: Calendar View Styles (v2) --- */
      .calendar-nav-controls {
          display: flex;
          flex-wrap: wrap; /* FIX: Allow controls to wrap on smaller screens */
          align-items: center;
          gap: 0.75rem;
          width: 100%;
          justify-content: flex-end; /* Align to the right by default */
          padding: 0.5rem 0;
      }
      @media (min-width: 600px) {
          .calendar-nav-controls {
              justify-content: center; /* Center on larger screens */
          }
          #calendar-today-btn {
              position: absolute;
              left: 0;
          }
      }

      .calendar-nav-controls .btn {
          flex-shrink: 0; /* Prevent buttons from shrinking */
      }
      .calendar-nav-controls .btn-icon {
          width: 38px;
          height: 38px;
          padding: 0;
      }

      .calendar-grid-container {
          display: grid;
          /* FIX: Use minmax for robust column sizing */
          grid-template-columns: repeat(7, minmax(0, 1fr));
          gap: 5px;
          padding: 1rem 0;
      }

      .calendar-day-header {
          font-weight: 600;
          text-align: center;
          padding: 0.5rem 0;
          color: var(--secondary-text);
          font-size: 0.85rem;
      }

      .calendar-day {
          border: 1px solid var(--border-color);
          border-radius: 8px;
          min-height: 120px;
          background-color: var(--bg-card);
          transition: all 0.2s ease;
          display: flex;
          flex-direction: column;
          position: relative;
          cursor: pointer;
          overflow: hidden; /* FIX: Prevent content from spilling out */
      }
      .calendar-day:hover {
          transform: translateY(-3px);
          box-shadow: var(--shadow);
          border-color: var(--accent-color);
      }

      .calendar-day.other-month {
          background-color: var(--bg-main);
          opacity: 0.6;
          cursor: default;
      }
      .dark-mode .calendar-day.other-month {
          background-color: #161b22;
      }
      .calendar-day.other-month:hover {
          transform: none;
          box-shadow: none;
          border-color: var(--border-color);
      }
      .calendar-day.weekend {
          background-color: var(--bg-main);
      }
      .dark-mode .calendar-day.weekend {
          background-color: rgba(29, 40, 57, 0.4);
      }

      .calendar-day.today {
          border: 2px solid var(--accent-color);
          background-color: var(--accent-light);
      }
      .calendar-day.today .day-number {
          background-color: var(--accent-color);
          color: white;
          font-weight: 700;
      }

      .calendar-day-header-content {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 0.5rem;
          flex-shrink: 0;
      }

      .day-number {
          font-weight: 500;
          font-size: 0.8rem;
          width: 24px;
          height: 24px;
          border-radius: 50%;
          display: flex;
          align-items: center;
          justify-content: center;
          transition: all 0.2s ease;
      }

      .day-event-dots {
          display: flex;
          gap: 4px;
      }
      .event-dot {
          width: 6px;
          height: 6px;
          border-radius: 50%;
      }
      .event-dot.normal { background-color: var(--accent-color); }
      .event-dot.flashcard { background-color: #8b5cf6; } /* purple-500 */

      .calendar-topics-list {
          list-style: none;
          padding: 0 0.5rem;
          margin: 0;
          font-size: 0.75rem;
          flex-grow: 1;
          overflow: hidden; 
          line-height: 1.5;
      }

      .calendar-topics-list li {
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
          padding: 2px 0;
      }
      .calendar-topics-list .topic-item::before {
          content: '•';
          margin-right: 6px;
          color: var(--secondary-text);
      }

      .calendar-day-more {
          font-size: 0.75rem;
          font-weight: 600;
          color: var(--accent-hover);
          margin: auto 0.5rem 0.5rem 0.5rem;
          text-align: right;
          flex-shrink: 0;
      }

      /* --- Gamification & Custom Study Styles --- */
      .achievement-item { display: flex; align-items: center; gap: 1.5rem; opacity: 0.5; filter: grayscale(80%); transition: all 0.3s ease; }
      .achievement-item.unlocked { opacity: 1; filter: grayscale(0%); }
      .achievement-item .icon { font-size: 3rem; color: var(--warning-color); flex-shrink: 0; width: 60px; text-align: center; }
      .achievement-item.unlocked .icon { text-shadow: 0 0 15px rgba(245, 158, 11, 0.5); }
      .achievement-item .details h4 { margin: 0 0 0.25rem 0; }
      .achievement-item .details p { margin: 0; font-size: 0.9rem; }
      .achievement-item .date { margin-left: auto; font-size: 0.85rem; color: var(--secondary-text); white-space: nowrap; }

      #custom-study-subject-list .list-item { padding: 0.5rem; cursor: pointer; }
      #custom-study-subject-list .list-item .item-info { gap: 1rem; }
      #custom-study-subject-list .list-item input[type="checkbox"] { width: 1.2rem; height: 1.2rem; }

      .subject-ranking-item { display: flex; align-items: center; gap: 1rem; }
      .subject-ranking-item .rank { font-size: 1.2rem; font-weight: 700; color: var(--secondary-text); width: 30px; text-align: center; }
      .subject-ranking-item .details { flex-grow: 1; }
      .subject-ranking-item .details .name { font-weight: 600; }
      .subject-ranking-item .details .score { font-size: 0.85rem; color: var(--secondary-text); }
      .subject-ranking-item .score-bar { width: 100px; height: 8px; background-color: var(--border-color); border-radius: 4px; overflow: hidden; }
      .subject-ranking-item .score-bar-fill { height: 100%; background-color: var(--danger-color); transition: width 0.5s ease; }


      /* --- MASTER STYLES --- */
      .mastery-rank { font-size: 0.8rem; font-weight: 600; padding: 0.2rem 0.6rem; border-radius: 12px; text-transform: uppercase; letter-spacing: 0.5px; }
      .rank-novice { background-color: #f3f4f6; color: #4b5563; } .dark-mode .rank-novice { background-color: #4b5563; color: #d1d5db; }
      .rank-adept { background-color: #dbeafe; color: #1e40af; } .dark-mode .rank-adept { background-color: #1e3a8a; color: #93c5fd; }
      .rank-expert { background-color: #d1fae5; color: #065f46; } .dark-mode .rank-expert { background-color: #064e3b; color: #a7f3d0; }
      .rank-master { background-color: var(--accent-light); color: var(--accent-hover); }
      .rank-grandmaster { 
        background: linear-gradient(45deg, #0ea5e9, #3B82F6, #8b5cf6); 
        color: white; 
        animation: subtle-pulse 2s infinite, animated-gradient 10s ease infinite;
        background-size: 200% 200%;
      }
      #daily-goal-progress-bar { width: 100%; height: 8px; background-color: var(--border-color); border-radius: 4px; overflow: hidden; }
      #daily-goal-progress-fill { width: 0%; height: 100%; background-color: var(--success-color); border-radius: 4px; transition: width 0.5s ease; }
      #daily-goal-text { font-size: 0.85rem; color: var(--secondary-text); }
      .ai-analysis-container { margin-top: 1.5rem; padding: 1rem; border-radius: 8px; background-color: var(--bg-main); border-left: 4px solid var(--info-color); }
      .ai-analysis-container h4 { margin-top: 0; font-size: 1rem; color: var(--info-color); }
      .ai-analysis-container p { font-size: 0.9rem; line-height: 1.7; margin-bottom: 0; color: var(--primary-text); }


.card-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(240px,1fr)); gap:1rem; }
.review-card { background:#fff; border-radius:12px; padding:1rem; border:1px solid #e6e9ee; box-shadow:0 1px 3px rgba(16,24,40,0.06); display:flex; flex-direction:column; gap:0.6rem; }
.review-card:hover { transform:translateY(-6px); box-shadow:0 10px 20px rgba(16,24,40,0.12); }
.review-card .meta { display:flex; justify-content:space-between; align-items:center; gap:0.5rem; }
.review-card h3 { margin:0; font-size:1rem; font-weight:700; }
.review-card p { margin:0; color:#6b7280; font-size:0.9rem; }
.review-card .tag { font-size:0.8rem; padding:0.25rem 0.5rem; border-radius:8px; border:1px solid #e6e9ee; background:#f6f9fb; color:#111827; }
.review-card .actions { display:flex; gap:0.5rem; margin-top:auto; }
.review-card .btn-ghost { padding:0.55rem; border-radius:10px; border:1px solid #e6e9ee; background:transparent; cursor:pointer; font-weight:600; }

</style>
</head>
<body>
    <script>
        // ป้องกันการคลิกขวา
        document.addEventListener('contextmenu', function(e) {
            e.preventDefault();
        });

        // ป้องกันการกดปุ่มเพื่อเปิด Developer Tools
        document.onkeydown = function(e) {
            // ปุ่ม F12
            if(e.keyCode == 123) { return false; }
            // Ctrl+Shift+I (Windows/Linux)
            if(e.ctrlKey && e.shiftKey && e.keyCode == 'I'.charCodeAt(0)) { return false; }
            // Ctrl+Shift+C
            if(e.ctrlKey && e.shiftKey && e.keyCode == 'C'.charCodeAt(0)) { return false; }
            // Ctrl+Shift+J
            if(e.ctrlKey && e.shiftKey && e.keyCode == 'J'.charCodeAt(0)) { return false; }
            // Ctrl+U
            if(e.ctrlKey && e.keyCode == 'U'.charCodeAt(0)) { return false; }
            // Command+Option+I (Mac)
            if(e.metaKey && e.altKey && e.keyCode == 'I'.charCodeAt(0)) { return false; }
        };
    </script>

    <div id="loading-overlay" class="loading-overlay" style="display: flex;">
        <div class="spinner"></div>
        <span>กำลังโหลด...</span>
    </div>
    <div id="app-container" style="display: none;">
        <audio id="notification-sound" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_1e31d789a9.mp3?filename=message-incoming-132126.mp3" preload="auto"></audio>
        <audio id="achievement-sound" src="https://cdn.pixabay.com/download/audio/2022/11/17/audio_85d2075b36.mp3?filename=success-fanfare-trumpets-6185.mp3" preload="auto"></audio>

    </div>

    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>

    <script>
        /*
            ================================================
            === คำแนะนำสำหรับผู้ใช้งานใหม่ (Instructions) ===
            ================================================

            1. สร้างโปรเจกต์ใหม่บน Firebase ของคุณเอง

            2. นำค่า config จากโปรเจกต์ Firebase ของคุณ มาใส่แทนที่ object 'firebaseConfig' ทั้งหมดข้างล่างนี้

            3. นำกฎ (Rules) จากไฟล์ firestore.rules ไปใส่ในการตั้งค่า Firestore Security Rules ในโปรเจกต์ Firebase ของคุณ


        const firebaseConfig = {
            apiKey: "...",
            authDomain: "...",

        };*/
    const firebaseConfig = {
        apiKey: "AIzaSyBnwFv0EZ3w9Eefj5KyJfhHX8sG2mtqQKE",
        authDomain: "learnney-website.firebaseapp.com",
        projectId: "learnney-website",
        storageBucket: "learnney-website.appspot.com",
        messagingSenderId: "538185783655",
        appId: "1:538185783655:web:ce277fc81c9930a907f7c2"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    class StudyService {
        constructor(userId) { if (!userId) { throw new Error("StudyService requires a userId."); } this.userId = userId; this.MAX_SUBJECTS = 100; this.MAX_TOPICS = 2000; this.userDocRef = db.collection('users').doc(this.userId); this.subjectsCollection = this.userDocRef.collection('subjects'); this.topicsCollection = this.userDocRef.collection('topics'); this.FSRS_PARAMS = { request_retention: 0.9, w: [0.4, 0.6, 2.4, 5.8, 4.93, 0.94, 0.86, 0.01, 1.49, 0.14, 0.94, 2.18, 0.05, 0.34, 1.26, 0.29, 2.61] }; this.DECAY = -0.5; this.FACTOR = (Math.pow(this.FSRS_PARAMS.request_retention, 1 / this.DECAY) - 1); this.subjects = []; this.topics = []; this.reviewsToday = { date: new Date().toISOString().slice(0, 10), count: 0, completedDue: 0 }; this.customCountdowns = []; this.streakData = { current: 0, lastDate: null }; this.settings = { dailyReviewGoal: 20, newTopicsPerDay: 0 }; this.dailyLearning = { date: new Date().toISOString().slice(0, 10), newTopicsStarted: 0 }; this.achievements = {}; }
        async loadDataFromFirestore() { try { const [subjectsSnapshot, topicsSnapshot, userDoc] = await Promise.all([ this.subjectsCollection.get(), this.topicsCollection.get(), this.userDocRef.get() ]); this.subjects = subjectsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); this.topics = topicsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data(), stability: doc.data().stability || 0, difficulty: doc.data().difficulty || 0, nextReview: doc.data().nextReview?.toDate(), lastReview: doc.data().lastReview?.toDate(), createdAt: doc.data().createdAt?.toDate() || new Date(), reviewHistory: doc.data().reviewHistory || [], reflectionHistory: doc.data().reflectionHistory || [] })); const userData = userDoc.data() || {}; const todayStr = new Date().toISOString().slice(0, 10); if (userData?.reviewsToday?.date === todayStr) { this.reviewsToday = userData.reviewsToday; } else { this.reviewsToday = { date: todayStr, count: 0, completedDue: 0 }; } if (userData?.dailyLearning?.date === todayStr) { this.dailyLearning = userData.dailyLearning; } else { this.dailyLearning = { date: todayStr, newTopicsStarted: 0 }; } this.streakData = userData.streakData || { current: 0, lastDate: null }; this.settings = { ...this.settings, ...(userData.settings || {}) }; if (userData.customCountdowns && userData.customCountdowns.length > 0) { this.customCountdowns = userData.customCountdowns; } else { this.customCountdowns = [{ id: 'tgat', name: 'TGAT/TPAT', targetDate: '2025-12-07T09:00:00' }, { id: 'alevel', name: 'A-LEVEL', targetDate: '2026-03-14T09:00:00' }]; } this.achievements = userData.achievements || {}; await this.saveMetadata(); } catch (error) { console.error("Error loading data from Firestore:", error); } }
        async saveMetadata() { try { await this.userDocRef.set({ reviewsToday: this.reviewsToday, streakData: this.streakData, settings: this.settings, dailyLearning: this.dailyLearning, achievements: this.achievements }, { merge: true }); } catch (error) { console.error("Error saving metadata:", error); } }
        async saveCustomCountdowns(countdowns) { this.customCountdowns = countdowns; try { await this.userDocRef.update({ customCountdowns: this.customCountdowns }); return { success: true }; } catch (error) { console.error("Error saving countdowns:", error); return { success: false, message: 'ไม่สามารถบันทึกข้อมูลได้' }; } }
        async saveSettings(newSettings) { this.settings = { ...this.settings, ...newSettings }; await this.saveMetadata(); }
        getSettings() { return this.settings; }
        getCustomCountdowns() { return this.customCountdowns; }

        async runDailyTasks() { const todayStr = new Date().toISOString().slice(0, 10); if (this.dailyLearning.date !== todayStr) { this.dailyLearning = { date: todayStr, newTopicsStarted: 0 }; } const { newTopicsPerDay } = this.settings; if (!newTopicsPerDay || newTopicsPerDay <= 0) return { startedCount: 0 }; const needed = newTopicsPerDay - this.dailyLearning.newTopicsStarted; if (needed <= 0) return { startedCount: 0 }; const pendingTopics = this.topics.filter(t => t.state === 'Pending').sort((a,b) => (a.createdAt || 0) - (b.createdAt || 0)); const topicsToStart = pendingTopics.slice(0, needed); if (topicsToStart.length === 0) return { startedCount: 0 }; for (const topic of topicsToStart) { await this.startLearningTopic(topic.id); } this.dailyLearning.newTopicsStarted += topicsToStart.length; await this.saveMetadata(); return { startedCount: topicsToStart.length }; }
        async updateStreak() { const today = new Date(); const todayStr = today.toISOString().slice(0, 10); if (this.streakData.lastDate === todayStr) { return; } const yesterday = new Date(today); yesterday.setDate(today.getDate() - 1); const yesterdayStr = yesterday.toISOString().slice(0, 10); if (this.streakData.lastDate === yesterdayStr) { this.streakData.current += 1; } else { this.streakData.current = 1; } this.streakData.lastDate = todayStr; await this.saveMetadata(); }
        getStreak() { return this.streakData.current; }

        async incrementReviewsToday(isDueReview) { this.reviewsToday.count++; if (isDueReview) { this.reviewsToday.completedDue = (this.reviewsToday.completedDue || 0) + 1; } await this.updateStreak(); await this.saveMetadata(); }
        // ใน class StudyService
        async addSubject(name) {
            if (this.subjects.length >= this.MAX_SUBJECTS) {
                return { success: false, message: `สร้างบทเรียนได้สูงสุด ${this.MAX_SUBJECTS} บทเรียนเท่านั้น` };
            }
            const trimmedName = name.trim();
            if (!trimmedName) {
                return { success: false, message: 'ชื่อบทเรียนห้ามว่างเปล่า' };
            }

            // --- ⭐ START: ปรับปรุงการตรวจสอบชื่อซ้ำ (แบบไม่สนตัวพิมพ์เล็ก/ใหญ่) ---
            const isDuplicate = this.subjects.some(
                subject => subject.name.toLowerCase() === trimmedName.toLowerCase()
            );

            if (isDuplicate) {
                return { success: false, message: 'มีบทเรียนชื่อนี้อยู่แล้ว' };
            }
            // --- ⭐ END: สิ้นสุดการปรับปรุง ---

            // หมายเหตุ: การเช็คกับ Firestore โดยตรงยังคงมีอยู่เพื่อป้องกัน Race Condition
            // แต่การเช็คจากข้อมูลในเครื่องก่อนจะให้ Feedback ที่เร็วกว่า
            const querySnapshot = await this.subjectsCollection.where("name", "==", trimmedName).get();
            if (!querySnapshot.empty) {
                return { success: false, message: 'มีบทเรียนชื่อนี้อยู่แล้ว' };
            }

            const docRef = await this.subjectsCollection.add({ name: trimmedName });
            const newSubject = { id: docRef.id, name: trimmedName };
            this.subjects.push(newSubject);
            return { success: true, subject: newSubject };
        }
        async editSubject(id, newName) { const trimmedName = newName.trim(); if (!trimmedName) return { success: false, message: 'ชื่อบทเรียนห้ามว่างเปล่า' }; const querySnapshot = await this.subjectsCollection.where("name", "==", trimmedName).get(); if (!querySnapshot.empty && querySnapshot.docs[0].id !== id) { return { success: false, message: 'มีบทเรียนชื่อนี้อยู่แล้ว' }; } await this.subjectsCollection.doc(id).update({ name: trimmedName }); const subject = this.subjects.find(s => s.id === id); if (subject) subject.name = trimmedName; return { success: true }; }
        async deleteSubject(id) { const topicsSnapshot = await this.topicsCollection.where("subjectId", "==", id).get(); const batch = db.batch(); topicsSnapshot.forEach(doc => { batch.delete(doc.ref); }); await batch.commit(); await this.subjectsCollection.doc(id).delete(); this.topics = this.topics.filter(t => t.subjectId !== id); this.subjects = this.subjects.filter(s => s.id !== id); }
        // ใน class StudyService
        async addTopic(topicData) {
            if (this.topics.length >= this.MAX_TOPICS) {
                return { success: false, message: `สร้างหัวข้อได้สูงสุด ${this.MAX_TOPICS} หัวข้อเท่านั้น` };
            }

            const { name, subjectId, type, content, front, back } = topicData;
            const trimmedName = name.trim();

            // --- ⭐ START: เพิ่มส่วนตรวจสอบชื่อซ้ำ (แบบไม่สนตัวพิมพ์เล็ก/ใหญ่) ---
            const isDuplicate = this.topics.some(
                topic => topic.subjectId === subjectId && topic.name.toLowerCase() === trimmedName.toLowerCase()
            );

            if (isDuplicate) {
                return { success: false, message: 'มีหัวข้อชื่อนี้อยู่ในบทเรียนนี้แล้ว' };
            }
            // --- ⭐ END: สิ้นสุดการตรวจสอบ ---

            if (!trimmedName || !subjectId || !type) {
                return { success: false, message: 'ข้อมูลหัวข้อไม่ครบถ้วน' };
            }

            const newTopicBase = {
                name: trimmedName,
                subjectId: subjectId,
                type: type,
                stability: 0,
                difficulty: 0,
                state: 'Pending',
                lastReview: null,
                nextReview: null,
                createdAt: firebase.firestore.Timestamp.now(),
                reviewHistory: [],
                reflectionHistory: [],
            };

            let newTopicPayload;
            if (type === 'flashcard') {
                newTopicPayload = { ...newTopicBase, front: front || '', back: back || '' };
            } else { // 'normal'
                newTopicPayload = { ...newTopicBase, content: content || '' };
            }

            const docRef = await this.topicsCollection.add(newTopicPayload);
            const newTopic = {
                id: docRef.id,
                ...newTopicPayload,
                nextReview: null,
                createdAt: newTopicPayload.createdAt.toDate()
            };
            this.topics.push(newTopic);
            return { success: true, topic: newTopic };
        }
        async startLearningTopic(topicId) {
            const topicIndex = this.topics.findIndex(t => t.id === topicId);
            if (topicIndex === -1) return { success: false, message: 'ไม่พบหัวข้อ' };

            const topic = this.topics[topicIndex];
            if (topic.state !== 'Pending') return { success: false, message: 'หัวข้อนี้อยู่ในคิวทบทวนแล้ว' };

            const now = new Date();
            const updates = {
                state: 'New',
                nextReview: firebase.firestore.Timestamp.fromDate(now)
            };

            await this.topicsCollection.doc(topicId).update(updates);

            topic.state = 'New';
            topic.nextReview = now;

            return { success: true };
        }
        async pauseTopic(topicId) {
            const topicIndex = this.topics.findIndex(t => t.id === topicId);
            if (topicIndex === -1) return { success: false, message: 'ไม่พบหัวข้อ' };

            const updates = {
                state: 'Pending',
                nextReview: null,
                lastReview: null,
                stability: 0,
                difficulty: 0
            };

            await this.topicsCollection.doc(topicId).update(updates);
            const topic = this.topics[topicIndex];
            Object.assign(topic, { state: 'Pending', nextReview: null, lastReview: null, stability: 0, difficulty: 0 });
            return { success: true };
        }
        async pauseAllActiveTopicsInSubject(subjectId) {
            const batch = db.batch();
            const topicsToPause = this.topics.filter(t => t.subjectId === subjectId && t.state !== 'Pending');

            if (topicsToPause.length === 0) {
                return { success: true, message: 'ไม่มีหัวข้อที่ต้องหยุดพัก' };
            }

            const updates = { state: 'Pending', nextReview: null, lastReview: null, stability: 0, difficulty: 0 };
            topicsToPause.forEach(topic => {
                const docRef = this.topicsCollection.doc(topic.id);
                batch.update(docRef, updates);
                Object.assign(topic, updates);
            });

            await batch.commit();
            return { success: true };
        }
        async editTopic(id, newName) { const trimmedName = newName.trim(); if (!trimmedName) return { success: false, message: 'ชื่อหัวข้อห้ามว่างเปล่า' }; const topic = this.getTopicById(id); if (!topic) return { success: false, message: 'ไม่พบหัวข้อ' }; const querySnapshot = await this.topicsCollection.where("subjectId", "==", topic.subjectId).where("name", "==", trimmedName).get(); if (!querySnapshot.empty && querySnapshot.docs[0].id !== id) { return { success: false, message: 'มีหัวข้อชื่อนี้ในบทเรียนเดียวกันแล้ว' }; } await this.topicsCollection.doc(id).update({ name: trimmedName }); topic.name = trimmedName; return { success: true }; }
        async deleteTopic(id) { await this.topicsCollection.doc(id).delete(); this.topics = this.topics.filter(t => t.id !== id); }

        async updateTopicData(id, dataToUpdate) {
            if (typeof dataToUpdate !== 'object' || dataToUpdate === null) {
                return { success: false, message: 'ข้อมูลอัปเดตไม่ถูกต้อง' };
            }
            try {
                await this.topicsCollection.doc(id).update(dataToUpdate);
                const topic = this.getTopicById(id);
                if (topic) {
                    Object.assign(topic, dataToUpdate);
                }
                return { success: true };
            } catch (error) {
                console.error("Error updating topic data:", error);
                return { success: false, message: 'ไม่สามารถบันทึกข้อมูลได้' };
            }
        }
async updateTopicRating(id, ratingStr) {
            const topicIndex = this.topics.findIndex(t => t.id === id);
            if (topicIndex === -1) return;
            let topic = this.topics[topicIndex];
            const isDueReview = topic.state === 'New' || topic.state === 'Learning' || topic.state === 'Review';
            const ratingMap = { again: 1, hard: 2, good: 3, easy: 4 };
            const rating = ratingMap[ratingStr];
            const w = this.FSRS_PARAMS.w;
            const now = new Date();
            const lastReviewDate = topic.lastReview || topic.createdAt;
            const elapsed_days = Math.max(0, (now.getTime() - lastReviewDate.getTime()) / (1000 * 3600 * 24));
            const retrievability = Math.pow(1 + elapsed_days / (9 * (topic.stability || 0.1)), this.DECAY);
            const oldState = topic.state;
            if (oldState === 'New') { topic.difficulty = w[4] - w[5] * (rating - 3); topic.stability = w[rating - 1]; } else { const currentDifficulty = topic.difficulty || 5; const currentStability = topic.stability || 0.1; topic.difficulty = currentDifficulty - w[6] * (rating - 3); topic.difficulty = Math.min(Math.max(1, topic.difficulty), 10); if (rating === 1) { topic.stability = w[11] * Math.pow(topic.difficulty, -w[12]) * (Math.pow(currentStability + 1, w[13]) - 1) * Math.exp((1 - retrievability) * w[14]); } else { topic.stability = currentStability * (1 + Math.exp(w[8]) * (11 - topic.difficulty) * Math.pow(currentStability, -w[9]) * (Math.exp((1 - retrievability) * w[10]) - 1)); } } topic.stability = Math.max(0.1, topic.stability); if (rating === 1) { topic.state = 'Relearning'; } else if (oldState !== 'Review') { topic.state = rating >= 3 ? 'Review' : 'Learning'; } const nextReviewDate = new Date(); if (topic.state === 'Learning' || topic.state === 'Relearning') { const intervalMinutes = rating === 1 ? 5 : 10; nextReviewDate.setMinutes(now.getMinutes() + intervalMinutes); } else { const intervalDays = Math.max(1, Math.round(topic.stability * this.FACTOR)); nextReviewDate.setDate(now.getDate() + intervalDays); } topic.lastReview = now; topic.nextReview = nextReviewDate;
            const historyEntry = { date: now.toISOString(), rating: ratingStr, stability: topic.stability, difficulty: topic.difficulty, state: topic.state };
            await this.topicsCollection.doc(id).update({
                stability: topic.stability, difficulty: topic.difficulty, state: topic.state,
                lastReview: firebase.firestore.Timestamp.fromDate(topic.lastReview),
                nextReview: firebase.firestore.Timestamp.fromDate(topic.nextReview),
                reviewHistory: firebase.firestore.FieldValue.arrayUnion(historyEntry)
            });
            const updatedDoc = await this.topicsCollection.doc(id).get();
            if (updatedDoc.exists) {
                this.topics[topicIndex] = { id: updatedDoc.id, ...updatedDoc.data(), nextReview: updatedDoc.data().nextReview?.toDate(), lastReview: updatedDoc.data().lastReview?.toDate(), createdAt: updatedDoc.data().createdAt?.toDate() || new Date(), reviewHistory: updatedDoc.data().reviewHistory || [], reflectionHistory: updatedDoc.data().reflectionHistory || [] };
            }
            await this.incrementReviewsToday(isDueReview);
            return { rating: ratingStr, date: topic.lastReview };
        }
        async logReflection(topicId, reviewDate, rating, reasons, notes) { 
            const topic = this.getTopicById(topicId); 
            if (topic) { 
                const reflectionEntry = { 
                    date: reviewDate.toISOString(), 
                    rating, 
                    reasons: reasons || [],
                    notes: notes || ''
                };
                const topicInCache = this.topics.find(t => t.id === topicId);
                if (topicInCache) {
                    if (!topicInCache.reflectionHistory) {
                        topicInCache.reflectionHistory = [];
                    }
                    topicInCache.reflectionHistory.push(reflectionEntry);
                }
                await this.topicsCollection.doc(topicId).update({ 
                    reflectionHistory: firebase.firestore.FieldValue.arrayUnion(reflectionEntry) 
                }); 
            } 
        }
        async moveTopic(topicId, newSubjectId) { if (!topicId || !newSubjectId) return { success: false, message: 'ข้อมูลไม่ถูกต้อง' }; try { await this.topicsCollection.doc(topicId).update({ subjectId: newSubjectId }); const topic = this.getTopicById(topicId); if (topic) topic.subjectId = newSubjectId; return { success: true }; } catch (error) { console.error("Error moving topic:", error); return { success: false, message: 'ไม่สามารถย้ายหัวข้อได้' }; } }
        getLeeches() {
            return this.topics.filter(topic => {
                const totalReviews = topic.reviewHistory || [];
                if (totalReviews.length < 3) return false;
                const totalAgainCount = totalReviews.filter(r => r.rating === 'again').length;
                const lastSevenReviews = totalReviews.slice(-7);
                const recentAgainCount = lastSevenReviews.filter(r => r.rating === 'again').length;
                if (recentAgainCount >= 3) return true;
                const lastReview = totalReviews[totalReviews.length - 1];
                if (totalAgainCount >= 6 && lastReview.rating !== 'easy' && lastReview.rating !== 'good') return true;
                return false;
            });
        }
        getAllSubjects() { return [...this.subjects].sort((a, b) => a.name.localeCompare(b.name, 'th')); }
        getSubjectById(id) { return this.subjects.find(s => s.id === id); }
        getSubjectNameById(id) { return this.subjects.find(s => s.id === id)?.name || 'N/A'; }
        getTopicById(id) { return this.topics.find(t => t.id === id); }
        getAllTopics() { return [...this.topics]; }
        getTodaysReviewCount() { return this.reviewsToday.count; }
        getDueTopics(date = new Date()) {
            const now = new Date(date);
            const startOfToday = new Date();
            startOfToday.setHours(0, 0, 0, 0);

            return this.topics
                .filter(topic => topic.state !== 'Pending' && topic.nextReview && topic.nextReview <= now)
                .map(topic => {
                    const isOverdue = topic.nextReview < startOfToday;
                    return { ...topic, isOverdue };
                })
                .sort((a, b) => a.nextReview - b.nextReview);
        }
        getDueFlashcards() {
            return this.getDueTopics().filter(topic => topic.type === 'flashcard');
        }
        getLearningTopics() { const now = new Date(); const endOfToday = new Date(); endOfToday.setHours(23, 59, 59, 999); return this.topics.filter(topic => { const state = topic.state; if (state !== 'Learning' && state !== 'Relearning') return false; if (!topic.nextReview) return false; return topic.nextReview > now && topic.nextReview <= endOfToday; }).sort((a,b) => a.nextReview - b.nextReview); }
        searchTopics(query) { const lowerCaseQuery = query.trim().toLowerCase(); if (!lowerCaseQuery) return []; return this.topics.filter(topic => topic.name.toLowerCase().includes(lowerCaseQuery) || (topic.front || "").toLowerCase().includes(lowerCaseQuery) ).map(topic => ({...topic, subjectName: this.getSubjectNameById(topic.subjectId)})).sort((a,b) => a.name.localeCompare(b.name, 'th')); }
        getCoachInsights() {
            if (this.getAllTopics().length === 0) {
                return { advice: "ยินดีต้อนรับ! เริ่มต้นด้วยการเพิ่มบทเรียนและหัวข้อแรกของคุณ" };
            }
            const dueTopics = this.getDueTopics();
            const overdueTopics = dueTopics.filter(t => t.isOverdue);
            const learningTopics = this.getLearningTopics();

            if (overdueTopics.length > 5) {
                return { advice: `มีหัวข้อที่เลยกำหนดทบทวนมากถึง ${overdueTopics.length} รายการ! รีบทบทวนด่วนเพื่อป้องกันการลืม!` };
            }
            if (dueTopics.length > 0) {
                return { advice: `มี ${dueTopics.length} หัวข้อรอให้คุณทบทวน เริ่มเลย!` };
            }
            if (learningTopics.length > 0) {
                return { advice: "ดีมาก! รออีกสักครู่แล้วหัวข้อที่กำลังเรียนรู้จะกลับมาให้ทบทวน" };
            }
            if (this.getTodaysReviewCount() > 10) {
                return { advice: `สุดยอดมาก วันนี้ทบทวนไป ${this.getTodaysReviewCount()} ครั้งแล้ว! พักผ่อนบ้างนะ` };
            }
            if (this.getLeeches().length > 0) {
                return { advice: "มี 'หัวข้อที่ต้องเน้น' ที่ต้องจัดการ ลองเข้าไปดูและทบทวนเป็นพิเศษนะ" };
            }
            return { advice: "ยอดเยี่ยม! ไม่มีหัวข้อค้างทบทวนสำหรับวันนี้ เติมความรู้ใหม่ๆ ได้เลย" };
        }
        getTopicPriority(topic) { if (topic.state === 'Learning' || topic.state === 'Relearning') return { level: 1, key: 'urgent', icon: '🔥' }; if (this.getLeeches().some(leech => leech.id === topic.id)) return { level: 2, key: 'high', icon: '💀' }; if ((topic.stability || 0) < 21) return { level: 3, key: 'standard', icon: '' }; return { level: 4, key: 'general', icon: '' }; }
        getSubjectInsights(subjectId) { const subjectTopics = this.topics.filter(t => t.subjectId === subjectId); if (subjectTopics.length === 0) return { stateDistribution: { new: 0, learning: 0, review: 0 }, hardestTopic: null, nextReviewTopic: null }; const stateDistribution = { new: 0, learning: 0, review: 0 }; subjectTopics.forEach(topic => { let state = (topic.state || 'New').toLowerCase(); if (state === 'pending') { stateDistribution.new++; } else if (state === 'relearning' || state === 'learning') { stateDistribution.learning++; } else if (state === 'review') { stateDistribution.review++; } else { stateDistribution.new++; } }); const hardestTopic = [...subjectTopics].sort((a, b) => (b.difficulty || 0) - (a.difficulty || 0))[0]; const nextReviewTopic = [...subjectTopics].filter(t => t.nextReview).sort((a, b) => new Date(a.nextReview) - new Date(b.nextReview))[0]; return { stateDistribution, hardestTopic, nextReviewTopic }; }
        getForgetReasonStats(subjectId = null) {
            const reasonMap = {};
            const topicsToScan = subjectId 
                ? this.topics.filter(t => t.subjectId === subjectId) 
                : this.topics;

            topicsToScan.forEach(topic => {
                (topic.reflectionHistory || []).forEach(reflection => {
                    (reflection.reasons || []).forEach(reason => {
                        const trimmedReason = reason.trim();
                        if (trimmedReason) {
                            reasonMap[trimmedReason] = (reasonMap[trimmedReason] || 0) + 1;
                        }
                    });
                });
            });
            return reasonMap;
        }
        getTopicsByReason(reason, subjectId = null) {
            const topicsToScan = subjectId
                ? this.topics.filter(t => t.subjectId === subjectId)
                : this.topics;

            return topicsToScan.filter(topic => {
                const reflections = (topic.reflectionHistory || []).filter(r => (r.reasons || []).includes(reason));
                if (reflections.length === 0) return false;

                const lastReasonDate = new Date(reflections[reflections.length - 1].date);

                const subsequentReviews = (topic.reviewHistory || [])
                    .filter(review => new Date(review.date) > lastReasonDate)
                    .slice(-2); // Check last 2 reviews after the reflection

                // If not enough reviews after, it's not "solved" yet.
                if (subsequentReviews.length < 2) return true;

                // If any of the last 2 reviews were bad, it's not "solved".
                const isSolved = subsequentReviews.every(r => r.rating === 'good' || r.rating === 'easy');

                return !isSolved;
            });
        }
        getStatsBySubject() { const data = { labels: [], new: [], learning: [], review: [] }; this.getAllSubjects().forEach(subject => { data.labels.push(subject.name); const insights = this.getSubjectInsights(subject.id); data.new.push(insights.stateDistribution.new); data.learning.push(insights.stateDistribution.learning); data.review.push(insights.stateDistribution.review); }); return data; }
        getFutureReviewForecast(days = 30) {
            const labels = [];
            const forecast = {
                urgent: [], high: [], normal: []
            };
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            for (let i = 0; i < days; i++) {
                const date = new Date(today);
                date.setDate(today.getDate() + i);
                labels.push(date.toLocaleDateString('th-TH', { month: 'short', day: 'numeric' }));
                const endOfDay = new Date(date);
                endOfDay.setHours(23, 59, 59, 999);
                const dueTopicsOnDate = this.topics.filter(topic => topic.nextReview && new Date(topic.nextReview) >= date && new Date(topic.nextReview) <= endOfDay);
                let urgentCount = 0;
                let highCount = 0;
                let normalCount = 0;
                dueTopicsOnDate.forEach(topic => {
                    const priority = this.getTopicPriority(topic);
                    switch (priority.key) {
                        case 'urgent': urgentCount++; break;
                        case 'high': highCount++; break;
                        default: normalCount++; break;
                    }
                });
                forecast.urgent.push(urgentCount);
                forecast.high.push(highCount);
                forecast.normal.push(normalCount);
            }
            return {
                labels: labels,
                datasets: [
                    { label: 'ต้องเน้น (Leech)', data: forecast.high, backgroundColor: 'var(--danger-color)', },
                    { label: 'เร่งด่วน (Learning)', data: forecast.urgent, backgroundColor: 'var(--warning-color)', },
                    { label: 'ปกติ', data: forecast.normal, backgroundColor: 'var(--accent-color)', }
                ]
            };
        }
        getHistoricalPerformanceData(topicId) {
            const topic = this.getTopicById(topicId);
            if (!topic || !topic.reviewHistory || topic.reviewHistory.length < 2) {
                return null; // Not enough data to plot a trend
            }

            const history = [...topic.reviewHistory].sort((a, b) => new Date(a.date) - new Date(b.date));

            const labels = history.map(review => new Date(review.date));
            const data = history.map(review => review.stability);

            return {
                labels: labels,
                datasets: [{
                    label: 'ค่าความคงทน (Stability)',
                    data: data,
                    borderColor: 'var(--accent-color)',
                    backgroundColor: 'var(--accent-light)',
                    fill: false,
                    tension: 0.1
                }]
            };
        }
        getReviewActivityForHeatmap() {
            const activity = {}; // { 'YYYY-MM-DD': count }
            this.topics.forEach(topic => {
                (topic.reviewHistory || []).forEach(review => {
                    const dateStr = new Date(review.date).toISOString().slice(0, 10);
                    activity[dateStr] = (activity[dateStr] || 0) + 1;
                });
            });
            return activity;
        }
        getMasteryTrendData() {
            const history = [];
            this.topics.forEach(topic => {
                (topic.reviewHistory || []).forEach(review => {
                    history.push({
                        date: new Date(review.date),
                        stability: review.stability
                    });
                });
            });

            if (history.length < 2) return null; // Not enough data

            history.sort((a, b) => a.date - b.date);
            const trendData = [];
            const trendLabels = [];
            for(let i=0; i<history.length; i++) {
                trendLabels.push(history[i].date);
                const avg = history.slice(0, i+1).reduce((sum, h) => sum + h.stability, 0) / (i+1);
                trendData.push(avg);
            }

            return {
                labels: trendLabels,
                datasets: [{
                    label: 'ค่าความคงทนเฉลี่ย',
                    data: trendData,
                    borderColor: 'var(--success-color)',
                    backgroundColor: 'rgba(34, 197, 94, 0.1)',
                    fill: false,
                    tension: 0.2
                }]
            };
        }
        getDailyGoalStats() {
            const goal = this.settings.dailyReviewGoal;
            const completed = this.getTodaysReviewCount();
            return { completed, total: goal };
        }
        getRecommendedDailyGoal() {
            const activeTopics = this.topics.filter(t => t.state !== 'Pending' && t.state !== 'New').length;
            if (activeTopics < 10) {
                return {
                    value: 10,
                    reason: "ในช่วงเริ่มต้น แนะนำให้ตั้งเป้าหมายน้อยๆ ก่อน ลองเริ่มที่ <strong>10 ครั้ง/วัน</strong> เพื่อสร้างความคุ้นเคย"
                };
            }

            let suggestion = Math.round(activeTopics * 0.15); // Suggest reviewing 15% of active cards

            // Round to nearest 5, and clamp between 10 and 100 for safety.
            let finalSuggestion = Math.round(suggestion / 5) * 5;
            finalSuggestion = Math.max(10, Math.min(finalSuggestion, 100));

            return {
                value: finalSuggestion,
                reason: `จากจำนวนหัวข้อที่เรียนอยู่ ${activeTopics} รายการ ระบบแนะนำที่ <strong>${finalSuggestion} ครั้ง/วัน</strong> เพื่อให้การเรียนรู้สม่ำเสมอและไม่หนักเกินไป`
            };
        }
        getSubjectMastery(subjectId) {
            const subjectTopics = this.topics.filter(t => t.subjectId === subjectId && t.state !== 'Pending' && t.state !== 'New');
            if (subjectTopics.length < 3) {
                return { rank: 'Novice', avgStability: 0, cssClass: 'rank-novice' };
            }
            const avgStability = subjectTopics.reduce((sum, t) => sum + t.stability, 0) / subjectTopics.length;

            if (avgStability < 7) return { rank: 'Novice', avgStability, cssClass: 'rank-novice' };
            if (avgStability < 21) return { rank: 'Adept', avgStability, cssClass: 'rank-adept' };
            if (avgStability < 60) return { rank: 'Expert', avgStability, cssClass: 'rank-expert' };
            if (avgStability < 180) return { rank: 'Master', avgStability, cssClass: 'rank-master' };
            return { rank: 'Grandmaster', avgStability, cssClass: 'rank-grandmaster' };
        }
        getAIAnalysisForLeech(topicId) {
            const topic = this.getTopicById(topicId);
            if (!topic) return "ไม่พบข้อมูลหัวข้อ";

            const history = topic.reviewHistory || [];
            const reflections = topic.reflectionHistory || [];

            let insights = [];

            const againCount = history.filter(r => r.rating === 'again').length;
            if (againCount > 4) {
                insights.push(`มีการตอบผิด (Again) ในหัวข้อนี้ถึง ${againCount} ครั้ง ซึ่งเป็นสัญญาณว่าอาจมีปัญหาความเข้าใจพื้นฐาน`);
            }

            const confusedCount = reflections.filter(r => r.reasons.includes('สับสนกับหัวข้ออื่น (Confused)')).length;
            if (confusedCount > 1) {
                insights.push(`คุณบันทึกว่า 'สับสนกับหัวข้ออื่น' หลายครั้ง อาจจะต้องทบทวนหัวข้อนี้ควบคู่ไปกับหัวข้อที่คล้ายกันเพื่อหาจุดแตกต่าง`);
            }

            const conceptIssueCount = reflections.filter(r => r.reasons.includes('ยังไม่เข้าใจแนวคิดหลัก (Concept Issue)')).length;
            if (conceptIssueCount > 0) {
                insights.push(`คุณเคยบันทึกว่า 'ยังไม่เข้าใจแนวคิดหลัก' การกลับไปอ่านเนื้อหาหรือสรุปแก่นสำคัญอีกครั้งอาจช่วยได้`);
            }

            if (topic.difficulty > 7) {
                insights.push(`ค่าความยาก (Difficulty) ของหัวข้อนี้ค่อนข้างสูง (${topic.difficulty.toFixed(2)}) แสดงว่าสมองของคุณมองว่าหัวข้อนี้ซับซ้อนเป็นพิเศษ`);
            }

            if (history.length > 2) {
                const lastGoodReview = history.slice().reverse().find(r => r.rating === 'good');
                const lastAgainReview = history.slice().reverse().find(r => r.rating === 'again');
                if (lastGoodReview && lastAgainReview && new Date(lastAgainReview.date) > new Date(lastGoodReview.date)) {
                    insights.push(`ดูเหมือนว่าแม้จะเคยตอบ 'Good' ได้ แต่ก็ยังกลับมาลืมในภายหลัง อาจเป็นเพราะเว้นช่วงนานเกินไป หรือความจำยังไม่แข็งแรงพอ`);
                }
            }

            if (insights.length === 0) {
                return "หัวข้อนี้ถูกตอบผิดบ่อยครั้ง แต่ยังไม่มีรูปแบบที่ชัดเจนจากการวิเคราะห์ ลองทบทวนเนื้อหาอีกครั้งและให้ความสำคัญเป็นพิเศษ";
            }

            return "ข้อสังเกตจาก AI Coach:\n- " + insights.join('\n- ');
        }
        async unlockAchievement(id) {
            if (this.achievements[id]) return null; // Already unlocked

            this.achievements[id] = { unlockedAt: new Date().toISOString() };
            await this.saveMetadata();
            return id;
        }

        getUnlockedAchievements() {
            return this.achievements;
        }
        getCustomStudyTopics(filters) {
            const { subjectIds, filterType } = filters;
            let filteredTopics = this.topics.filter(t => t.state !== 'Pending');

            if (subjectIds && subjectIds.length > 0) {
                filteredTopics = filteredTopics.filter(t => subjectIds.includes(t.subjectId));
            }

            switch(filterType) {
                case 'leech':
                    const leechIds = this.getLeeches().map(l => l.id);
                    return filteredTopics.filter(t => leechIds.includes(t.id));
                case 'not_mature':
                    return filteredTopics.filter(t => (t.stability || 0) < 21);
                case 'all':
                default:
                    return filteredTopics;
            }
        }
        getSubjectRankings() {
            const subjectScores = this.subjects.map(subject => {
                const subjectTopics = this.topics.filter(t => t.subjectId === subject.id);
                const reviewedTopics = subjectTopics.filter(t => t.reviewHistory && t.reviewHistory.length > 0);

                if (reviewedTopics.length === 0) {
                    return { ...subject, score: 0, totalReviews: 0 };
                }

                let totalAgain = 0;
                let totalHard = 0;
                let totalReviews = 0;

                reviewedTopics.forEach(topic => {
                    topic.reviewHistory.forEach(review => {
                        totalReviews++;
                        if (review.rating === 'again') totalAgain++;
                        if (review.rating === 'hard') totalHard++;
                    });
                });

                // Score: 'again' is twice as bad as 'hard'. Higher score is worse.
                const score = totalReviews > 0 ? ((totalAgain * 2) + totalHard) / totalReviews : 0;

                return { ...subject, score: score, totalReviews };
            });

            // Sort by score descending (higher score is harder)
            return subjectScores.sort((a, b) => b.score - a.score);
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        auth.onAuthStateChanged(async (user) => {
            const loadingOverlay = document.getElementById('loading-overlay');
            const appContainer = document.getElementById('app-container');
            try {
                if (user) {
                    loadingOverlay.querySelector('span').textContent = 'กำลังโหลดข้อมูล...';
                    await initializeApp(user);
                    loadingOverlay.style.display = 'none';
                    appContainer.style.display = 'block';
                } else {
                    if (!window.location.pathname.includes('login.html')) {
                        window.location.href = 'login.html';
                    }
                }
            } catch (error) {
                console.error("Fatal error during app initialization:", error);
                document.body.innerHTML = `<div style="font-family: sans-serif; padding: 2rem; text-align: center; color: #D32F2F; background-color: #FFEBEE; border: 1px solid #FFCDD2; margin: 1rem; border-radius: 8px;"><h1>เกิดข้อผิดพลาดร้ายแรง</h1><p>ไม่สามารถโหลดแอปพลิเคชันได้</p><p style="font-weight: bold; margin-top: 1rem;">ข้อความ Error:</p><pre style="text-align: left; background-color: #FFF; padding: 1rem; border-radius: 4px; border: 1px solid #CCC; white-space: pre-wrap; word-wrap: break-word;">${error.stack || error.message}</pre></div>`;
            }
        });

        async function initializeApp(user) {
            const appContainer = document.getElementById('app-container');
            appContainer.innerHTML = `
                <div id="toast-container"></div>
                <div class="fab-container" id="fab-container">
                    <ul class="fab-options">
                        <li>
                            <span class="fab-label">เพิ่มหัวข้อ</span>
                            <button class="fab-btn-sm" id="fab-add-topic" title="เพิ่มหัวข้อใหม่">
                                <i class="fas fa-file-alt"></i>
                            </button>
                        </li>
                        <li>
                            <span class="fab-label">เพิ่มบทเรียน</span>
                            <button class="fab-btn-sm" id="fab-add-subject" title="เพิ่มบทเรียนใหม่">
                                <i class="fas fa-book"></i>
                            </button>
                        </li>
                    </ul>
                    <button class="fab-main-btn" id="fab-main-btn">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
                <div id="app-layout" class="app-layout header-mode">
                    <aside class="sidebar">
                        <button id="layout-toggle-btn" title="ย่อแถบเมนู">
                            <i class="fas fa-angle-double-left"></i>
                        </button>

                            <div class="header-actions-wrapper">
                                <button id="custom-study-btn" class="btn btn-icon btn-secondary" title="ทบทวนพิเศษ" style="background-color: transparent; border: 1px solid var(--border-color); color: var(--secondary-text);"><i class="fas fa-star-of-life"></i></button>
                                <button id="achievements-btn" class="btn btn-icon btn-secondary" title="เหรียญตรา" style="background-color: transparent; border: 1px solid var(--border-color); color: var(--secondary-text);"><i class="fas fa-trophy"></i></button>
                                <button id="settings-btn" class="btn btn-icon btn-secondary" title="ตั้งค่า" style="background-color: transparent; border: 1px solid var(--border-color); color: var(--secondary-text);"><i class="fas fa-cog"></i></button>
                                <div class="user-profile-pill" title="${user.email}">
                                    <i class="fas fa-user-circle"></i>
                                    <span>${user.displayName || user.email}</span>
                                </div>
                            </div>
                        </div>
                        <div id="dashboard-view" class="view-content active">
                            <header class="page-header"><h1>Dashboard</h1></header>
                            <div id="dashboard-alert-container"></div>
                            <div class="grid-layout">
                                <section class="card full-width-card"><div class="card-header"><h3><i class="fa-solid fa-hourglass-half"></i> นับถอยหลังวันสอบ</h3><button id="edit-countdown-btn" class="btn btn-secondary btn-sm"><i class="fas fa-pencil-alt"></i> แก้ไข</button></div><div id="countdown-container" class="countdown-container"></div></section>
                                <section class="card full-width-card">
                                    <div class="card-header">
                                        <h3><i class="fa-solid fa-bullseye"></i> เป้าหมายทบทวนรายวัน</h3>
                                    </div>
                                    <div id="daily-goal-progress-bar">
                                        <div id="daily-goal-progress-fill"></div>
                                    </div>
                                    <div id="daily-goal-text" style="text-align: right; margin-top: 0.5rem;">0 / 0</div>
                                </section>

                                <section id="coach-card" class="card full-width-card"><div class="card-header"><h3><i class="fa-solid fa-lightbulb"></i> คำแนะนำจากระบบ</h3></div><div id="coach-advice-content" class="coach-content"></div></section>
                                <section class="card full-width-card" id="key-stats">
                                    <div class="stats-container-grid">
                                        <div class="stat-item" style="--animation-order: 1;"><span class="stat-value" id="stats-due-value">0</span><span class="stat-label">พร้อมทบทวนแล้ว</span></div>
                                        <div class="stat-item" style="--animation-order: 2;"><span class="stat-value" id="stats-learning-value">0</span><span class="stat-label">รออยู่ในคิว</span></div>
                                        <div class="stat-item" style="--animation-order: 3;"><span class="stat-value" id="stats-reviews-today-value">0</span><span class="stat-label">ทบทวนไปแล้ว</span></div>
                                        <div class="stat-item" style="--animation-order: 4;"><span id="streak-stat-item"><span class="stat-value" id="stats-streak-value">0</span><span class="stat-label">วันต่อเนื่อง 🔥</span></span></div>
                                    </div>
                                </section>
                                <section class="card full-width-card" id="todays-review">
                                    <div class="card-header">
                                        <h3><i class="fa-solid fa-star"></i>ทบทวนวันนี้</h3>
                                        <div class="header-actions-wrapper" id="review-header-actions">
                                            <button id="bulk-review-flashcards-btn" class="btn btn-sm" style="display: none;"><i class="fa-solid fa-layer-group"></i> ทบทวน Flashcard ทั้งหมด</button>
                                            <button id="view-forecast-btn" class="btn btn-secondary btn-sm"><i class="fa-solid fa-chart-line"></i> ดูพยากรณ์</button>
                                            <button id="sort-queue-btn" class="btn btn-secondary btn-sm"><i class="fa-solid fa-clock"></i> เรียงตามเวลา</button>
                                        </div>
                                    </div>
                                    <div class="review-category-bar"></div>
                                    <ul id="todays-queue-list" class="card-grid" class="list"></ul>
                                </section>
                            </div>
                        </div>
                        <div id="subjects-view" class="view-content"><header class="page-header"><h1>บทเรียนและหัวข้อ</h1></header><div class="management-layout"><section class="card"><div class="card-header"><h3><i class="fa-solid fa-book-open"></i>บทเรียนทั้งหมด</h3></div><ul id="subjects-list" class="list"></ul></section>
                        <section class="card subject-details-card">
                            <div id="subject-mastery-container" style="display: none; margin-bottom: 1rem;"></div>
                            <div class="card-header"><h3><i class="fa-solid fa-list-ul"></i>หัวข้อในบทเรียนนี้</h3><div id="subject-actions-container"></div></div><ul id="topics-for-subject-list" class="list"></ul></section></div></div>
                        <div id="calendar-view" class="view-content">
                            <header class="page-header">
                                <h1><i class="fa-solid fa-calendar-alt"></i> ปฏิทินทบทวน</h1>
                            </header>
                            <p class="view-description">ปฏิทินนี้จะแสดงหัวข้อประเภท Normal ทั้งหมดที่มีกำหนดการทบทวนในแต่ละวัน ช่วยให้คุณวางแผนการเรียนรู้ได้ล่วงหน้า</p>
                            <div class="card full-width-card">
                                <div class="card-header" id="calendar-header">
                                    <div class="calendar-nav-controls">
                                        <button id="calendar-today-btn" class="btn btn-secondary">วันนี้</button>
                                        <button id="prev-month-btn" class="btn btn-icon"><i class="fas fa-chevron-left"></i></button>
                                        <button id="next-month-btn" class="btn btn-icon"><i class="fas fa-chevron-right"></i></button>
                                        <select id="calendar-month-select" class="form-control" style="width: auto;"></select>
                                        <select id="calendar-year-select" class="form-control" style="width: auto;"></select>
                                    </div>
                                </div>
                                <div id="calendar-day-headers" class="calendar-grid-container" style="padding-bottom: 0;"></div>
                                <div id="calendar-grid" class="calendar-grid-container"></div>
                            </div>
                        </div>
<div id="trouble-zone-view" class="view-content"><header class="page-header"><h1><i class="fa-solid fa-skull-crossbones"></i> โซนอันตราย (Leeches)</h1></header><p class="view-description">หัวข้อที่แสดงที่นี่คือหัวข้อที่คุณตอบผิด (Again) บ่อยครั้งในช่วงล่าสุด หรือมีประวัติการตอบผิดสะสมสูงมาก ควรให้ความสำคัญเป็นพิเศษ</p><div class="card full-width-card"><ul id="leech-list" class="list"></ul></div></div>
                        <div id="analytics-view" class="view-content">
                            <header class="page-header"><h1><i class="fa-solid fa-chart-pie"></i> สถิติการเรียนรู้</h1></header>
                            <div class="analytics-layout">
                                <section class="card">
                                    <div class="card-header">
                                        <h3><i class="fa-solid fa-ranking-star"></i> บทเรียนสุดหิน (Hardest Subjects)</h3>
                                    </div>
                                    <p class="card-description" style="margin-top: -0.5rem;">จัดอันดับตามเปอร์เซ็นต์การตอบผิด (Again/Hard) เพื่อให้รู้ว่าควรเน้นบทไหน</p>
                                    <ul id="subject-rankings-list" class="list"></ul>
                                </section>
                                <section class="card">
                                    <div class="card-header">
                                        <h3><i class="fa-solid fa-brain"></i> สถิติเหตุผลการลืม</h3>
                                    </div>
                                    <div class="analytics-filter-container">
                                        <label for="analytics-subject-filter">กรองตามบทเรียน:</label>
                                        <select id="analytics-subject-filter"></select>
                                    </div>
                                    <div class="chart-wrapper">
                                        <canvas id="forget-reasons-chart"></canvas>
                                    </div>
                                </section>
                                <section id="reason-details-card" class="card" style="display: none;">
                                    <div class="card-header">
                                        <h4 id="reason-details-title"></h4>
                                    </div>
                                     <p class="card-description" style="margin-top: -0.5rem;">รายการนี้จะแสดงเฉพาะหัวข้อที่ "ยังแก้ปัญหาไม่ได้" (ยังตอบถูกต่อเนื่องไม่ถึง 2 ครั้งล่าสุด)</p>
                                    <ul id="reason-details-list" class="list"></ul>
                                </section>
                                <section class="card full-width-card">
                                    <div class="card-header">
                                        <h3><i class="fa-solid fa-calendar-days"></i> ปฏิทินการทบทวน (ปีที่ผ่านมา)</h3>
                                    </div>
                                    <div id="review-heatmap-container"></div>
                                    <div class="heatmap-legend">
                                        <span>น้อย</span>
                                        <div class="box level-1"></div>
                                        <div class="box level-2"></div>
                                        <div class="box level-3"></div>
                                        <div class="box level-4"></div>
                                        <span>มาก</span>
                                    </div>
                                </section>

                                <section class="card">
                                    <div class="card-header">
                                        <h3><i class="fa-solid fa-arrow-trend-up"></i> แนวโน้มความจำระยะยาว</h3>
                                    </div>
                                    <p class="card-description" style="margin-top: -0.5rem;">กราฟแสดงค่าความคงทน (Stability) เฉลี่ยของทุกหัวข้อที่เคยทบทวน เพื่อดูพัฒนาการโดยรวม</p>
                                    <div class="chart-wrapper">
                                        <canvas id="mastery-trend-chart"></canvas>
                                    </div>
                                </section>

                                <section class="card">
                                    <div class="card-header">
                                        <h3><i class="fa-solid fa-book"></i> ภาพรวมรายบทเรียน</h3>
                                    </div>
                                    <div class="chart-wrapper">
                                        <canvas id="subjects-overview-chart-in-analytics"></canvas>
                                    </div>
                                </section>

                            </div>
                        </div>
                    </main>
                </div>
<div id="review-session-modal" class="modal-container"><div class="modal-content"><button class="modal-close-btn" aria-label="Close modal"><i class="fas fa-times"></i></button><div id="review-bulk-progress"></div><h3 id="review-topic-name">...</h3><div id="review-content-area" class="review-content-area"></div><div id="review-actions-area" style="margin-top: 1.5rem;"><button id="review-show-answer-btn" class="btn" style="width: 100%;">แสดงคำตอบ</button><div id="review-rating-buttons" class="modal-actions" style="grid-template-columns: 1fr 1fr; gap: 0.75rem;"><button class="btn-rate rating-again" data-rating="again"><strong>Again</strong><span class="rating-desc">จำไม่ได้เลย</span></button><button class="btn-rate rating-hard" data-rating="hard"><strong>Hard</strong><span class="rating-desc">ยาก, ลังเล</span></button><button class="btn-rate rating-good" data-rating="good"><strong>Good</strong><span class="rating-desc">จำได้ดี</span></button><button class="btn-rate rating-easy" data-rating="easy"><strong>Easy</strong><span class="rating-desc">ง่ายมาก</span></button></div></div></div></div>
<div id="reflection-modal" class="modal-container"><div class="modal-content wide"><button class="modal-close-btn" aria-label="Close modal"><i class="fas fa-times"></i></button><h3 id="modal-reflection-topic-name">...</h3><p>การเข้าใจสาเหตุที่ลืม จะช่วยให้การเรียนรู้ดีขึ้นในระยะยาว</p><form id="reflection-form"><div class="form-group"><label>ทำไมถึงจำหัวข้อนี้ไม่ได้? (เลือกได้มากกว่า 1 ข้อ)</label><div id="reflection-options"><label class="checkbox-label"><input type="checkbox" name="reason" value="แค่ลืมเฉยๆ (Forgot)"><span>แค่ลืมเฉยๆ (Forgot)</span></label><label class="checkbox-label"><input type="checkbox" name="reason" value="สับสนกับหัวข้ออื่น (Confused)"><span>สับสนกับหัวข้ออื่น (Confused)</span></label><label class="checkbox-label"><input type="checkbox" name="reason" value="ยังไม่เข้าใจแนวคิดหลัก (Concept Issue)"><span>ยังไม่เข้าใจแนวคิดหลัก (Concept Issue)</span></label><label class="checkbox-label"><input type="checkbox" name="reason" value="สะเพร่า/ทำพลาดง่ายๆ (Careless Mistake)"><span>สะเพร่า/ทำพลาดง่ายๆ (Careless Mistake)</span></label></div></div><div class="form-group"><label for="reflection-notes">บันทึกเพิ่มเติม (หรือระบุเหตุผลอื่น)</label><textarea id="reflection-notes" rows="3" placeholder="บันทึกเพิ่มเติมเกี่ยวกับความผิดพลาดนี้ (จะไม่ถูกนับในสถิติ)"></textarea></div><button type="submit" id="reflection-submit-btn" class="btn" style="width:100%;">บันทึกผล</button></form></div></div>
<div id="topic-details-modal" class="modal-container"><div class="modal-content wide"><button class="modal-close-btn" aria-label="Close modal"><i class="fas fa-times"></i></button><div class="modal-header-actions"><h3 id="modal-details-topic-name">...</h3></div><div class="details-primary-info"><div class="stat-card primary"><i class="fa-solid fa-calendar-check"></i><div><label>กำหนดทบทวนรอบถัดไป</label><span id="details-next-review"></span></div></div><div class="stat-card primary"><i class="fa-solid fa-brain"></i><div><label>สถานะ</label><span id="details-state"></span></div></div></div><div class="details-section-divider"><hr><span>ข้อมูลขั้นสูง</span><hr></div><div class="details-secondary-info"><div class="stat-card secondary"><i class="fa-solid fa-shield-halved"></i><div><label>ความคงทน (วัน) <span class="tooltip" data-tooltip="ค่าที่บ่งบอกว่าความจำนี้จะอยู่ในหัวของคุณได้นานแค่ไหน (หน่วยเป็นวัน) ยิ่งค่าสูง แสดงว่ายิ่งจำได้แม่น"><i class="fa-solid fa-circle-info"></i></span></label><span id="details-stability"></span></div></div><div class="stat-card secondary"><i class="fa-solid fa-puzzle-piece"></i><div><label>ระดับความยาก <span class="tooltip" data-tooltip="ค่าที่บ่งบอกความซับซ้อนของหัวข้อ ยิ่งค่าสูง แสดงว่าสมองของคุณมองว่าหัวข้อนี้ยากที่จะจำ"><i class="fa-solid fa-circle-info"></i></span></label><span id="details-difficulty"></span></div></div></div><div id="leech-status-container" style="margin-top: 1rem;"></div><div id="ai-analysis-output" style="display:none;"></div><div class="details-section-divider"><hr><span>ประวัติการทบทวน</span><hr></div><ul id="details-history-list" class="history-list" style="margin-top: 1rem;"></ul><div class="modal-actions" style="margin-top: 1rem; justify-content: flex-start; gap: 0.5rem;"><button id="ai-coach-btn" class="btn btn-sm" style="display: none; background-color: var(--info-color);"><i class="fas fa-robot"></i> AI วิเคราะห์</button><button id="view-history-chart-btn" class="btn btn-secondary btn-sm"><i class="fas fa-chart-line"></i> ดูประวัติความจำ</button></div><div id="history-chart-container" style="display: none; margin-top: 1rem;"><div class="chart-wrapper" style="height: 250px;"><canvas id="topic-history-chart"></canvas></div></div><div class="details-section-divider"><hr><span>เนื้อหา</span><hr></div><div id="details-content-wrapper" style="margin-top: 1rem; text-align: left;"><div id="details-content-normal-container"><div id="details-content-display" style="white-space: pre-wrap; word-wrap: break-word; padding: 0.5rem; min-height: 50px;"></div><textarea id="details-content-edit" class="form-control" rows="8" style="display: none; width: 100%; font-size: 0.9rem;" placeholder="เพิ่มเนื้อหา สรุป หรือโน้ตย่อ..."></textarea></div><div id="details-content-flashcard-container"><div id="details-flashcard-display"></div><div id="details-flashcard-edit" style="display: none;"><div class="form-group"><label for="details-flashcard-front-edit">Front</label><textarea id="details-flashcard-front-edit" class="form-control" rows="4"></textarea></div><div class="form-group"><label for="details-flashcard-back-edit">Back</label><textarea id="details-flashcard-back-edit" class="form-control" rows="4"></textarea></div></div></div></div><div class="modal-actions" style="margin-top: 1.5rem; display: flex; justify-content: flex-end;"><button id="details-edit-content-btn" class="btn btn-secondary"><i class="fas fa-pencil-alt"></i> แก้ไขเนื้อหา</button><button id="details-save-content-btn" class="btn" style="display: none;"><i class="fas fa-save"></i> บันทึกเนื้อหา</button></div></div></div>
<div id="add-topic-modal" class="modal-container"><div class="modal-content" style="max-width: 500px; text-align: left;"><button class="modal-close-btn" aria-label="Close modal"><i class="fas fa-times"></i></button><h3><i class="fas fa-plus-circle"></i> เพิ่มหัวข้อใหม่</h3><form id="add-topic-form-modal"><div class="form-group"><label for="topic-subject-select">เลือกบทเรียน</label><select id="topic-subject-select" required></select></div><div class="form-group"><label>ประเภทหัวข้อ</label><div class="topic-type-switcher"><input type="radio" id="topic-type-normal" name="topic-type" value="normal" checked><label for="topic-type-normal">Normal</label><input type="radio" id="topic-type-flashcard" name="topic-type" value="flashcard"><label for="topic-type-flashcard">Flashcard</label></div></div><div class="form-group"><label for="new-topic-name-modal">ชื่อหัวข้อ</label><input type="text" id="new-topic-name-modal" required></div><div id="add-topic-content-normal" class="form-group"><label for="new-topic-content">เนื้อหา</label><textarea id="new-topic-content" rows="4" placeholder="ใส่เนื้อหา สรุป หรือคำถามที่นี่..."></textarea></div><div id="add-topic-content-flashcard" style="display: none;"><div class="form-group"><label for="new-topic-front">Front</label><textarea id="new-topic-front" rows="3" placeholder="คำถาม / คำศัพท์..."></textarea></div><div class="form-group"><label for="new-topic-back">Back</label><textarea id="new-topic-back" rows="3" placeholder="คำตอบ / ความหมาย..."></textarea></div></div><button type="submit" class="btn" style="width: 100%;">เพิ่มหัวข้อ</button></form></div></div>
<div id="add-subject-modal" class="modal-container"><div class="modal-content" style="max-width: 500px; text-align: left;"><button class="modal-close-btn" aria-label="Close modal"><i class="fas fa-times"></i></button><h3><i class="fas fa-plus-circle"></i> เพิ่มบทเรียนใหม่</h3><form id="add-subject-form-modal"><div class="form-group"><label for="new-subject-name-modal">ชื่อบทเรียน</label><input type="text" id="new-subject-name-modal" required></div><button type="submit" class="btn" style="width: 100%;">เพิ่มบทเรียน</button></form></div></div>
<div id="delete-subject-modal" class="modal-container"><div class="modal-content" style="max-width: 500px;"><button class="modal-close-btn" aria-label="Close modal"><i class="fas fa-times"></i></button><h3 style="color: var(--danger-color);"><i class="fas fa-triangle-exclamation"></i> ยืนยันการลบบทเรียน</h3><p id="delete-subject-warning"></p><div class="form-group" style="text-align: left; margin-top: 1.5rem;"><label for="delete-subject-input">เพื่อยืนยัน โปรดพิมพ์ชื่อบทเรียนด้านล่าง:</label><input type="text" id="delete-subject-input" autocomplete="off"></div><button id="delete-subject-confirm-btn" class="btn btn-danger" style="width: 100%;" disabled>ยืนยันการลบอย่างถาวร</button></div></div>
<div id="delete-topic-modal" class="modal-container"><div class="modal-content" style="max-width: 500px;"><button class="modal-close-btn" aria-label="Close modal"><i class="fas fa-times"></i></button><h3 style="color: var(--danger-color);"><i class="fas fa-triangle-exclamation"></i> ยืนยันการลบหัวข้อ</h3><p id="delete-topic-warning"></p><div class="form-group" style="text-align: left; margin-top: 1.5rem;"><label for="delete-topic-input">เพื่อยืนยัน โปรดพิมพ์ชื่อหัวข้อด้านล่าง:</label><input type="text" id="delete-topic-input" autocomplete="off"></div><button id="delete-topic-confirm-btn" class="btn btn-danger" style="width: 100%;" disabled>ยืนยันการลบอย่างถาวร</button></div></div>
<div id="move-topic-modal" class="modal-container"><div class="modal-content"><button class="modal-close-btn" aria-label="Close modal"><i class="fas fa-times"></i></button><h3><i class="fas fa-right-left"></i> ย้ายหัวข้อ</h3><p id="move-topic-name">...</p><form id="move-topic-form"><div class="form-group" style="text-align: left;"><label for="move-topic-select">ย้ายไปยังบทเรียน:</label><select id="move-topic-select" required></select></div><div class="modal-actions" style="grid-template-columns: 1fr 1fr;"><button type="button" class="btn btn-secondary" data-action="close-modal">ยกเลิก</button><button type="submit" class="btn">ยืนยัน</button></div></form></div></div>
<div id="welcome-modal" class="modal-container"><div class="modal-content"><h3 style="font-size: 1.6rem; font-weight: 700;">บอกลาการอ่านแล้วลืม!</h3><p style="font-size: 1rem; line-height: 1.7;"><b>Learnney</b> ใช้หลักการ <b>Spaced Repetition</b> ที่พิสูจน์แล้วทางวิทยาศาสตร์เข้ามาแก้ปัญหานี้</p><div class="modal-actions" style="margin-top: 1.5rem;"><button id="start-onboarding-btn" class="btn" style="padding: 0.8rem 1rem; font-size: 1rem;">เข้าใจแล้ว เริ่มใช้งานเลย!</button></div></div></div>
<div id="edit-countdown-modal" class="modal-container"><div class="modal-content wide"><button class="modal-close-btn" aria-label="Close modal"><i class="fas fa-times"></i></button><h3><i class="fas fa-edit"></i> แก้ไขเวลานับถอยหลัง</h3><p>คุณสามารถเพิ่ม ลบ และตั้งค่าวัน-เวลาที่ต้องการนับถอยหลังได้ที่นี่</p><form id="edit-countdown-form" style="margin-top: 1.5rem;"><div id="countdown-editor-list" style="max-height: 40vh; overflow-y: auto; padding-right: 10px;"></div><button type="button" id="add-new-countdown-btn" class="btn btn-secondary" style="margin-top: 1rem;"><i class="fas fa-plus"></i> เพิ่มรายการใหม่</button><div class="modal-actions" style="margin-top: 1.5rem;"><button type="submit" class="btn" style="width: 100%;">บันทึกการเปลี่ยนแปลง</button></div></form></div></div>
<div id="forecast-modal" class="modal-container"><div class="modal-content wide"><button class="modal-close-btn" aria-label="Close modal"><i class="fas fa-times"></i></button><h3><i class="fa-solid fa-chart-line"></i> พยากรณ์การทบทวนล่วงหน้า</h3><p>กราฟนี้แสดงจำนวนหัวข้อโดยประมาณที่จะต้องทบทวนในแต่ละวัน 30 วันข้างหน้า</p><div class="chart-wrapper" style="height: 400px; margin-top: 1rem;"><canvas id="forecast-chart"></canvas></div></div></div>
<div id="settings-modal" class="modal-container"><div class="modal-content" style="max-width: 500px; text-align: left;"><button class="modal-close-btn" aria-label="Close modal"><i class="fas fa-times"></i></button><h3><i class="fas fa-cog"></i> ตั้งค่า</h3><form id="settings-form"><div class="form-group"><label for="daily-goal-input">เป้าหมายการทบทวนรายวัน</label><input type="number" id="daily-goal-input" min="1" step="1" required><div id="daily-goal-recommendation" style="font-size: 0.85rem; color: var(--secondary-text); background-color: var(--bg-main); padding: 0.75rem; border-radius: 6px; margin-top: 0.75rem; display: none; line-height: 1.6;"></div></div><div class="form-group"><label for="new-topics-per-day-input">จำนวนหัวข้อใหม่ต่อวัน<span class="tooltip" data-tooltip="ระบบจะดึงหัวข้อจาก 'รอดำเนินการ' มาเริ่มเรียนให้อัตโนมัติทุกวัน ตั้งค่าเป็น 0 เพื่อปิด"><i class="fa-solid fa-circle-info"></i></span></label><input type="number" id="new-topics-per-day-input" min="0" step="1" required></div><button type="submit" class="btn" style="width: 100%;">บันทึก</button></form></div></div>
<div id="confirm-action-modal" class="modal-container"><div class="modal-content" style="max-width: 500px;"><button class="modal-close-btn" aria-label="Close modal"><i class="fas fa-times"></i></button><h3 id="confirm-action-title" style="color: var(--warning-color);"></h3><p id="confirm-action-message"></p><div class="modal-actions" style="grid-template-columns: 1fr 1fr; margin-top: 1.5rem;"><button id="confirm-action-cancel-btn" class="btn btn-secondary">ยกเลิก</button><button id="confirm-action-confirm-btn" class="btn">ยืนยัน</button></div></div></div>
<div id="achievements-modal" class="modal-container"><div class="modal-content wide"><button class="modal-close-btn" aria-label="Close modal"><i class="fas fa-times"></i></button><h3><i class="fas fa-trophy"></i> เหรียญตราความสำเร็จ</h3><ul id="achievements-list" class="list" style="margin-top: 1.5rem;"></ul></div></div>
<div id="custom-study-modal" class="modal-container"><div class="modal-content wide"><button class="modal-close-btn" aria-label="Close modal"><i class="fas fa-times"></i></button><h3><i class="fas fa-star-of-life"></i> ทบทวนพิเศษ</h3><p>สร้างเซสชันการทบทวนแบบกำหนดเองตามเงื่อนไขที่คุณต้องการ</p><form id="custom-study-form" style="margin-top: 1.5rem;"><div class="form-group"><label>1. เลือกบทเรียน (หรือไม่เลือกเพื่อทบทวนทุกบทเรียน)</label><ul id="custom-study-subject-list" class="list"></ul></div><div class="form-group"><label for="custom-study-filter-type">2. กรองหัวข้อเพิ่มเติม</label><select id="custom-study-filter-type"><option value="all">ทุกหัวข้อ</option><option value="leech">เฉพาะ Leech (ที่ต้องเน้น)</option><option value="not_mature">เฉพาะหัวข้อที่ยังไม่แม่น (Stability < 21 วัน)</option></select></div><button type="submit" class="btn" style="width: 100%;"><i class="fas fa-play-circle"></i> เริ่มทบทวน</button></form></div></div>
<div id="daily-detail-modal" class="modal-container">
    <div class="modal-content wide">
        <button class="modal-close-btn" aria-label="Close modal"><i class="fas fa-times"></i></button>
        <h3 id="daily-detail-modal-title">หัวข้อสำหรับวันที่...</h3>
        <ul id="daily-detail-modal-list" class="list" style="margin-top: 1.5rem; max-height: 60vh; overflow-y: auto;"></ul>
    </div>
</div>
    `;

            const service = new StudyService(user.uid);
            await service.loadDataFromFirestore();
            window.service = service;
            runFullAppLogic(service, user);
        }
function runFullAppLogic(service, user) {
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    const notificationSound = document.getElementById('notification-sound');
    const achievementSound = document.getElementById('achievement-sound');
    let isAudioUnlocked = false;

    const ACHIEVEMENT_DEFINITIONS = {
        'streak7': { name: 'นักเดินทาง 7 วัน', description: 'รักษา Streak การทบทวนต่อเนื่องครบ 7 วัน', icon: 'fa-solid fa-calendar-week' },
        'streak30': { name: 'นักสำรวจรายเดือน', description: 'รักษา Streak การทบทวนต่อเนื่องครบ 30 วัน', icon: 'fa-solid fa-calendar-days' },
        'streak100': { name: 'ตำนาน 100 วัน', description: 'รักษา Streak การทบทวนต่อเนื่องครบ 100 วัน', icon: 'fa-solid fa-monument' },
        'leechSlayer': { name: 'ผู้พิชิต Leech', description: 'แก้ปัญหา Leech (หัวข้อที่ตอบผิดบ่อย) ได้สำเร็จ 1 หัวข้อ', icon: 'fa-solid fa-skull-crossbones' },
        'review100': { name: 'มาราธอน', description: 'ทบทวนครบ 100 ครั้งในวันเดียว', icon: 'fa-solid fa-person-running' },
        'topic50': { name: 'นักสร้างสรรค์', description: 'สร้างหัวข้อครบ 50 หัวข้อ', icon: 'fa-solid fa-lightbulb' },
    };

    // --- START: โค้ดปลดล็อคเสียงที่แก้ไขแล้ว ---
    const unlockAudio = () => {
        if (isAudioUnlocked || !audioContext) { // ถ้าปลดล็อคแล้ว หรือไม่มี audio context ให้หยุดทำงาน
            document.body.removeEventListener('click', unlockAudio);
            document.body.removeEventListener('touchstart', unlockAudio);
            return;
        }

        // พยายามปลุก AudioContext ให้ทำงาน ซึ่งเป็นเป้าหมายหลัก
        if (audioContext.state === 'suspended') {
            audioContext.resume().then(() => {
                console.log("AudioContext resumed successfully."); // แจ้งให้เรารู้ใน console ว่าสำเร็จ
                isAudioUnlocked = true;
                // เมื่อสำเร็จแล้ว ก็ลบตัวดักฟังออกไป จะได้ไม่ทำงานซ้ำ
                document.body.removeEventListener('click', unlockAudio);
                document.body.removeEventListener('touchstart', unlockAudio);
            }).catch(e => {
                // ถ้ามีปัญหา ให้แสดง error ใน console เราจะได้รู้
                console.error("Failed to resume AudioContext:", e);
            });
        } else {
            // ถ้า state ไม่ใช่ suspended แสดงว่ามันพร้อมใช้งานอยู่แล้ว
            isAudioUnlocked = true;
            document.body.removeEventListener('click', unlockAudio);
            document.body.removeEventListener('touchstart', unlockAudio);
        }
    };
    // --- END: โค้ดปลดล็อคเสียงที่แก้ไขแล้ว ---

    document.body.addEventListener('click', unlockAudio);
    document.body.addEventListener('touchstart', unlockAudio);

    const updateLiveCooldowns = () => {
        const cooldownElements = document.querySelectorAll('[data-cooldown-target]');
        if (cooldownElements.length === 0) return;
        let needsRefresh = false;
        cooldownElements.forEach(el => {
            const targetDate = new Date(el.dataset.cooldownTarget);
            const now = new Date();
            const diffSeconds = Math.round((targetDate.getTime() - now.getTime()) / 1000);
            if (diffSeconds <= 0) {
                el.closest('.list-item')?.remove();
                needsRefresh = true;
            } else {
                const minutes = Math.floor(diffSeconds / 60);
                const seconds = diffSeconds % 60;
                const timerSpan = el.querySelector('span');
                if(timerSpan) {
                   timerSpan.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                }
            }
        });
        if (needsRefresh) {
            if (notificationSound && isAudioUnlocked) {
                notificationSound.currentTime = 0;
                notificationSound.play().catch(e => {});
            }
            showToast('มีหัวข้อพร้อมให้ทบทวนแล้ว!', 'info');
            renderDashboardQueue();
            renderDashboardStats();
            renderDailyGoal();
        }
    };
    setInterval(updateLiveCooldowns, 1000);

    let currentTopicIdForModal = null, selectedSubjectId = null, isSortedByPriority = true, currentReflectionData = {}, activeCharts = {}, currentReviewFilter = 'all', goalAlreadyCelebrated = false;
    let bulkReviewQueue = [];
    let currentBulkReviewIndex = 0;
    let calendarDate = new Date(); // State for calendar view

    const ui = {
        logoutBtn: document.getElementById('logout-btn'), themeToggleBtn: document.getElementById('theme-toggle-btn'),
        navButtons: document.querySelectorAll('.nav-btn'), views: document.querySelectorAll('.view-content'),
        globalSearchInput: document.getElementById('global-search-input'), searchDropdown: document.getElementById('search-results-dropdown'),
        dashboard: { 
            view: document.getElementById('dashboard-view'), 
            countdownContainer: document.getElementById('countdown-container'), 
            editCountdownBtn: document.getElementById('edit-countdown-btn'), 
            coachAdviceContent: document.getElementById('coach-advice-content'), 
            due: document.getElementById('stats-due-value'), 
            learning: document.getElementById('stats-learning-value'), 
            reviewsToday: document.getElementById('stats-reviews-today-value'), 
            streak: document.getElementById('stats-streak-value'),
            todaysQueueList: document.getElementById('todays-queue-list'), 
            sortQueueBtn: document.getElementById('sort-queue-btn'), 
            viewForecastBtn: document.getElementById('view-forecast-btn'),
            dailyGoalProgressFill: document.getElementById('daily-goal-progress-fill'),
            dailyGoalText: document.getElementById('daily-goal-text'),
            bulkReviewBtn: document.getElementById('bulk-review-flashcards-btn'),
        },
        subjects: { 
            view: document.getElementById('subjects-view'), 
            list: document.getElementById('subjects-list'), 
            topicsList: document.getElementById('topics-for-subject-list'), 
            subjectActionsContainer: document.getElementById('subject-actions-container'),
            masteryContainer: document.getElementById('subject-mastery-container')
        },
        calendar: {
            view: document.getElementById('calendar-view'),
            grid: document.getElementById('calendar-grid'),
            monthYear: document.getElementById('calendar-month-select'), // Changed to select
            prevBtn: document.getElementById('prev-month-btn'),
            nextBtn: document.getElementById('next-month-btn'),
        },
        troubleZone: { view: document.getElementById('trouble-zone-view'), leechList: document.getElementById('leech-list') },
        analytics: { 
            view: document.getElementById('analytics-view'),
            subjectRankingsList: document.getElementById('subject-rankings-list'),
            forgetReasonChart: document.getElementById('forget-reasons-chart'), 
            subjectsOverviewChart: document.getElementById('subjects-overview-chart-in-analytics'),
            subjectFilter: document.getElementById('analytics-subject-filter'),
            reasonDetailsCard: document.getElementById('reason-details-card'),
            reasonDetailsTitle: document.getElementById('reason-details-title'),
            reasonDetailsList: document.getElementById('reason-details-list'),
            reviewHeatmapContainer: document.getElementById('review-heatmap-container'),
            masteryTrendChart: document.getElementById('mastery-trend-chart')
        },
        headerActions: {
            achievementsBtn: document.getElementById('achievements-btn'),
            customStudyBtn: document.getElementById('custom-study-btn'),
        },
        fab: { container: document.getElementById('fab-container'), mainBtn: document.getElementById('fab-main-btn'), addTopicBtn: document.getElementById('fab-add-topic'), addSubjectBtn: document.getElementById('fab-add-subject') },
        modals: {
            reviewSession: document.getElementById('review-session-modal'),
            reviewTopicName: document.getElementById('review-topic-name'),
            reviewContentArea: document.getElementById('review-content-area'),
            reviewShowAnswerBtn: document.getElementById('review-show-answer-btn'),
            reviewRatingButtons: document.getElementById('review-rating-buttons'),
            reviewBulkProgress: document.getElementById('review-bulk-progress'),

            reflection: document.getElementById('reflection-modal'), reflectionName: document.getElementById('modal-reflection-topic-name'), reflectionForm: document.getElementById('reflection-form'), reflectionNotes: document.getElementById('reflection-notes'),
            topicDetails: document.getElementById('topic-details-modal'), detailsTopicName: document.getElementById('modal-details-topic-name'), detailsNextReview: document.getElementById('details-next-review'), detailsState: document.getElementById('details-state'), detailsStability: document.getElementById('details-stability'), detailsDifficulty: document.getElementById('details-difficulty'), leechStatusContainer: document.getElementById('leech-status-container'), detailsHistoryList: document.getElementById('details-history-list'), detailsContentNormalContainer: document.getElementById('details-content-normal-container'), detailsContentDisplay: document.getElementById('details-content-display'), detailsContentEdit: document.getElementById('details-content-edit'), detailsContentFlashcardContainer: document.getElementById('details-content-flashcard-container'), detailsFlashcardDisplay: document.getElementById('details-flashcard-display'), detailsFlashcardEdit: document.getElementById('details-flashcard-edit'), detailsEditContentBtn: document.getElementById('details-edit-content-btn'), detailsSaveContentBtn: document.getElementById('details-save-content-btn'), aiCoachBtn: document.getElementById('ai-coach-btn'), aiAnalysisOutput: document.getElementById('ai-analysis-output'),
            viewHistoryChartBtn: document.getElementById('view-history-chart-btn'),
            historyChartContainer: document.getElementById('history-chart-container'),
            topicHistoryChart: document.getElementById('topic-history-chart'),
            addTopic: document.getElementById('add-topic-modal'), addTopicForm: document.getElementById('add-topic-form-modal'), addTopicSelect: document.getElementById('topic-subject-select'), addTopicInput: document.getElementById('new-topic-name-modal'),
            addSubject: document.getElementById('add-subject-modal'), addSubjectForm: document.getElementById('add-subject-form-modal'), addSubjectInput: document.getElementById('new-subject-name-modal'),
            welcome: document.getElementById('welcome-modal'),
            editCountdown: document.getElementById('edit-countdown-modal'), editCountdownForm: document.getElementById('edit-countdown-form'),
            deleteSubject: document.getElementById('delete-subject-modal'), deleteSubjectWarning: document.getElementById('delete-subject-warning'), deleteSubjectInput: document.getElementById('delete-subject-input'), deleteSubjectConfirmBtn: document.getElementById('delete-subject-confirm-btn'),
            deleteTopic: document.getElementById('delete-topic-modal'), deleteTopicWarning: document.getElementById('delete-topic-warning'), deleteTopicInput: document.getElementById('delete-topic-input'), deleteTopicConfirmBtn: document.getElementById('delete-topic-confirm-btn'),
            moveTopic: document.getElementById('move-topic-modal'), moveTopicName: document.getElementById('move-topic-name'), moveTopicForm: document.getElementById('move-topic-form'), moveTopicSelect: document.getElementById('move-topic-select'),
            forecast: document.getElementById('forecast-modal'),
            settings: document.getElementById('settings-modal'), settingsForm: document.getElementById('settings-form'),
            confirmAction: document.getElementById('confirm-action-modal'),
            achievements: document.getElementById('achievements-modal'),
            achievementsList: document.getElementById('achievements-list'),
            customStudy: document.getElementById('custom-study-modal'),
            customStudyForm: document.getElementById('custom-study-form'),
            customStudySubjects: document.getElementById('custom-study-subject-list'),
            customStudyFilterType: document.getElementById('custom-study-filter-type')
        }
    };
    const appLayout = document.getElementById('app-layout');
    const sidebar = document.querySelector('.sidebar');
    const topNavContainer = document.getElementById('top-nav-container');
    const navMenu = document.querySelector('.nav-menu');
    const layoutToggleBtn = document.getElementById('layout-toggle-btn');
    function setLayoutMode(activateHeaderMode) { const toggleIcon = layoutToggleBtn.querySelector('i'); if (activateHeaderMode) { appLayout.classList.add('header-mode'); topNavContainer.appendChild(layoutToggleBtn); topNavContainer.appendChild(navMenu); toggleIcon.classList.remove('fa-angle-double-left'); toggleIcon.classList.add('fa-angle-double-right'); layoutToggleBtn.title = 'ขยายแถบเมนู'; } else { appLayout.classList.remove('header-mode'); sidebar.insertBefore(navMenu, sidebar.querySelector('.sidebar-footer')); sidebar.appendChild(layoutToggleBtn); toggleIcon.classList.remove('fa-angle-double-right'); toggleIcon.classList.add('fa-angle-double-left'); layoutToggleBtn.title = 'ย่อแถบเมนู'; } }
    layoutToggleBtn.addEventListener('click', () => { const shouldBeHeader = !appLayout.classList.contains('header-mode'); setLayoutMode(shouldBeHeader); localStorage.setItem('learnney-layout-mode', shouldBeHeader ? 'header' : 'sidebar'); });
    function initializeLayout() { const savedMode = localStorage.getItem('learnney-layout-mode'); if (savedMode === 'header') { setLayoutMode(true); } }

    const showToast = (message, type = 'info') => { 
        if (type === 'achievement') {
            const achievementDef = ACHIEVEMENT_DEFINITIONS[message];
            if(!achievementDef) return;
            message = `ปลดล็อก: ${achievementDef.name}!`;
            const toast = document.createElement('div'); 
            toast.className = `toast achievement`; 
            toast.innerHTML = `<i class="fas fa-trophy"></i> <span>${message}</span>`;
            document.getElementById('toast-container').appendChild(toast);
            if (achievementSound && isAudioUnlocked) {
                achievementSound.currentTime = 0;
                achievementSound.play().catch(e => {});
            }
            setTimeout(() => { toast.style.animation = 'toast-out-right .5s ease forwards'; toast.addEventListener('animationend', () => toast.remove()); }, 5500);
            return;
        }
        const toast = document.createElement('div'); toast.className = `toast ${type}`; toast.innerHTML = `<i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-times-circle' : 'fa-info-circle'}"></i> <span>${message}</span>`; document.getElementById('toast-container').appendChild(toast); setTimeout(() => { toast.style.animation = 'toast-out-right .5s ease forwards'; toast.addEventListener('animationend', () => toast.remove()); }, 4500); 
    };
    const formatDate = (date) => { if (!date) return 'N/A'; const d = new Date(date); if (isNaN(d)) return 'N/A'; const today = new Date(); today.setHours(0,0,0,0); const tomorrow = new Date(today); tomorrow.setDate(today.getDate() + 1); const dCopy = new Date(d); dCopy.setHours(0,0,0,0); if (dCopy.getTime() === today.getTime()) return 'วันนี้'; if (dCopy.getTime() === tomorrow.getTime()) return 'พรุ่งนี้'; return d.toLocaleDateString('th-TH', { year: 'numeric', month: 'short', day: 'numeric' }); };
    const formatCooldown = (date) => {
        if (!date) return 'N/A';
        const d = new Date(date);
        if (isNaN(d)) return 'N/A';
        const now = new Date();
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const tomorrow = new Date(today);
        tomorrow.setDate(today.getDate() + 1);
        const d_dateOnly = new Date(d.getFullYear(), d.getMonth(), d.getDate());
        const timeString = d.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
        if (d_dateOnly.getTime() === today.getTime()) { return timeString; }
        if (d_dateOnly.getTime() === tomorrow.getTime()) { return `พรุ่งนี้ ${timeString}`; }
        const dateString = d.toLocaleDateString('th-TH', { day: 'numeric', month: 'short' });
        return `${dateString} ${timeString}`;
    };
    const createEmptyState = (message, showActions = false) => { let html = `<li class="empty-state">${message}`; if (showActions) { html += `<div class="empty-state-actions" style="margin-top: 1rem;"><button class="btn btn-sm" data-action="welcome-add-subject"><i class="fas fa-plus"></i> เพิ่มบทเรียนใหม่</button></div>`; } html += `</li>`; return html; };
    const debounce = (func, delay) => { let timeout; return function(...args) { const context = this; clearTimeout(timeout); timeout = setTimeout(() => func.apply(context, args), delay); }; };
    const openModal = (modal) => { if (modal) modal.classList.add('active'); };
    const closeModal = (modal) => { if(modal) { modal.classList.remove('active'); } else { document.querySelectorAll('.modal-container.active').forEach(m => m.classList.remove('active')); } };
    const destroyChart = (chartId) => { if (activeCharts[chartId]) { activeCharts[chartId].destroy(); delete activeCharts[chartId]; } };
    const createChart = (canvasId, type, data, options) => { destroyChart(canvasId); const ctx = document.getElementById(canvasId)?.getContext('2d'); if (ctx) { activeCharts[canvasId] = new Chart(ctx, { type, data, options }); } };
    const typewriterEffect = (element, text, speed = 30) => {
        element.innerHTML = "";
        let i = 0;
        function type() {
            if (i < text.length) {
                element.innerHTML += text.charAt(i);
                i++;
                setTimeout(type, speed);
            }
        }
        type();
    };
    function showConfirmationModal({ title, message, confirmText = 'ยืนยัน', cancelText = 'ยกเลิก', confirmClass = 'btn-warning', onConfirm }) { const modal = ui.modals.confirmAction; modal.querySelector('#confirm-action-title').innerHTML = title; modal.querySelector('#confirm-action-message').innerHTML = message; const confirmBtn = modal.querySelector('#confirm-action-confirm-btn'); const cancelBtn = modal.querySelector('#confirm-action-cancel-btn'); confirmBtn.textContent = confirmText; cancelBtn.textContent = cancelText; confirmBtn.className = 'btn'; confirmBtn.classList.add(confirmClass); openModal(modal); const confirmHandler = () => { closeModal(modal); onConfirm(); }; const cancelHandler = () => { closeModal(modal); }; confirmBtn.addEventListener('click', confirmHandler, { once: true }); cancelBtn.addEventListener('click', cancelHandler, { once: true }); modal.querySelector('.modal-close-btn').addEventListener('click', cancelHandler, { once: true }); }
    function refreshAllUI(viewToSwitch = null) {
        const todayStr = new Date().toISOString().slice(0, 10);
        if(service.reviewsToday.date !== todayStr) {
            goalAlreadyCelebrated = false; // Reset celebration for the new day
        }

        const currentView = viewToSwitch || document.querySelector('.view-content.active')?.id.replace('-view', '') || 'dashboard';
        renderDashboardStats();
        renderReviewCategoryBar();
        renderDailyGoal();
        switchView(currentView, true);
    }

    async function checkAllAchievements(trigger, data = {}) {
        const unlockedAchievements = service.getUnlockedAchievements();

        // Streak
        const streak = service.getStreak();
        if (streak >= 7 && !unlockedAchievements['streak7']) { const id = await service.unlockAchievement('streak7'); if(id) showToast(id, 'achievement'); }
        if (streak >= 30 && !unlockedAchievements['streak30']) { const id = await service.unlockAchievement('streak30'); if(id) showToast(id, 'achievement'); }
        if (streak >= 100 && !unlockedAchievements['streak100']) { const id = await service.unlockAchievement('streak100'); if(id) showToast(id, 'achievement'); }

        // Creation
        if (service.getAllTopics().length >= 50 && !unlockedAchievements['topic50']) {
            const id = await service.unlockAchievement('topic50'); if(id) showToast(id, 'achievement');
        }

        if (trigger === 'REVIEW_COMPLETE') {
            // Reviews in one day
            if (service.getTodaysReviewCount() >= 100 && !unlockedAchievements['review100']) {
                const id = await service.unlockAchievement('review100'); if(id) showToast(id, 'achievement');
            }
            // Leech slayer
            const wasLeech = data.wasLeech;
            const isNotLeechNow = !service.getLeeches().some(l => l.id === data.topicId);
            if (wasLeech && isNotLeechNow && !unlockedAchievements['leechSlayer']) {
                const id = await service.unlockAchievement('leechSlayer'); if(id) showToast(id, 'achievement');
            }
        }
    }


    function switchView(viewId, isRefresh = false) {
        if (!isRefresh) {
            document.querySelectorAll('.list-item.editing').forEach(el => el.classList.remove('editing'));
        }
        ui.views.forEach(v => v.classList.remove('active'));
        const newView = document.getElementById(`${viewId}-view`);
        if (newView) newView.classList.add('active');

        // Also update top nav if in header mode
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.toggle('active', b.dataset.view === viewId));

        switch (viewId) {
            case 'dashboard':
                renderDashboardAlerts();
                renderReviewCategoryBar();
                renderDashboardQueue();
                break;
            case 'subjects':
                renderSubjectsPage();
                break;
            case 'calendar':
                calendarDate = new Date(); // Reset to today when view is opened
                renderCalendarView();
                break;
            case 'trouble-zone':
                renderTroubleZone();
                break;
            case 'analytics':
                renderAnalytics();
                break;
        }
    }

    function initiateReview(topicId) {
        const topic = service.getTopicById(topicId);
        if (!topic) return;

        currentTopicIdForModal = topicId;
        ui.modals.reviewTopicName.textContent = topic.name;

        // Reset states
        ui.modals.reviewShowAnswerBtn.style.display = 'none';
        ui.modals.reviewRatingButtons.style.display = 'none';
        ui.modals.reviewContentArea.innerHTML = '';

        // Bulk review progress
        if (bulkReviewQueue.length > 0) {
            ui.modals.reviewBulkProgress.style.display = 'block';
            ui.modals.reviewBulkProgress.textContent = `ใบที่ ${currentBulkReviewIndex + 1} / ${bulkReviewQueue.length}`;
        } else {
            ui.modals.reviewBulkProgress.style.display = 'none';
        }

        if (topic.type === 'flashcard') {
            ui.modals.reviewContentArea.innerHTML = topic.front || '<i>- ว่าง -</i>';
            ui.modals.reviewShowAnswerBtn.style.display = 'block';
        } else { // Normal topic
            ui.modals.reviewContentArea.textContent = topic.content || '...';
            ui.modals.reviewRatingButtons.style.display = 'grid';
        }

        openModal(ui.modals.reviewSession);
    }
function startBulkReview(topicQueue) {
        bulkReviewQueue = topicQueue;
        if (bulkReviewQueue.length > 0) {
            currentBulkReviewIndex = 0;
            initiateReview(bulkReviewQueue[0].id);
        }
    }

    function advanceBulkReview() {
        currentBulkReviewIndex++;
        if (currentBulkReviewIndex < bulkReviewQueue.length) {
            const nextTopicId = bulkReviewQueue[currentBulkReviewIndex].id;
            initiateReview(nextTopicId);
        } else {
            // Finished
            closeModal(ui.modals.reviewSession);
            showToast(`ทบทวนต่อเนื่องเสร็จสิ้น!`, 'success');
            bulkReviewQueue = [];
            currentBulkReviewIndex = 0;
            refreshAllUI();
        }
    }


    function renderReviewCategoryBar() {
        const container = document.querySelector('.review-category-bar');
        if (!container) return;

        const subjects = service.getAllSubjects();
        let staticFiltersHTML = `
            <button class="review-cat-btn" data-filter="all" data-action="reset-view" title="รีเซ็ตมุมมอง"><i class="fas fa-compass"></i></button>
            <button class="review-cat-btn" data-filter="all">ทั้งหมด</button>
            <button class="review-cat-btn" data-filter="urgent">เร่งด่วน</button>
            <button class="review-cat-btn" data-filter="leech">โซนอันตราย</button>
            <button class="review-cat-btn" data-filter="overdue">เลยกำหนด</button>
        `;

        let subjectFiltersHTML = subjects.map(subject => 
            `<button class="review-cat-btn" data-filter="${subject.id}">${subject.name}</button>`
        ).join('');

        container.innerHTML = staticFiltersHTML + subjectFiltersHTML;

        const currentActiveButton = container.querySelector(`[data-filter="${currentReviewFilter}"]`);
        if (currentActiveButton) {
            container.querySelector('.active')?.classList.remove('active');
            container.querySelectorAll(`[data-filter="${currentReviewFilter}"]`).forEach(btn => btn.classList.add('active'));
        } else {
            container.querySelector('[data-filter="all"]').classList.add('active');
            currentReviewFilter = 'all';
        }
    }
    function renderDashboardStats() { 
        const dueTopics = service.getDueTopics(); 
        ui.dashboard.due.textContent = dueTopics.length; 
        ui.dashboard.learning.textContent = service.getLearningTopics().length; 
        ui.dashboard.reviewsToday.textContent = service.getTodaysReviewCount(); 
        ui.dashboard.streak.textContent = service.getStreak();
        ui.dashboard.coachAdviceContent.innerHTML = `<p>${service.getCoachInsights().advice}</p>`; 
    }

    function renderDashboardAlerts() {
        const container = document.getElementById('dashboard-alert-container');
        if (!container) return;
        const overdueTopics = service.getDueTopics().filter(t => t.isOverdue);
        if (overdueTopics.length > 0) {
            container.innerHTML = `<div class="dashboard-alert"><i class="fas fa-exclamation-triangle"></i><span>คุณมีหัวข้อที่เกินกำหนดทบทวน ${overdueTopics.length} รายการ!</span></div>`;
        } else {
            container.innerHTML = '';
        }
    }

    function renderDailyGoal() {
        const { completed, total } = service.getDailyGoalStats();
        if (total <= 0) {
            ui.dashboard.dailyGoalProgressFill.style.width = '0%';
            ui.dashboard.dailyGoalText.textContent = 'ตั้งเป้าหมายการทบทวนรายวันในเมนูตั้งค่า ⚙️';
            return;
        }
        const percentage = Math.min(100, (completed / total) * 100);
        ui.dashboard.dailyGoalProgressFill.style.width = `${percentage}%`;
        ui.dashboard.dailyGoalText.textContent = `${completed} / ${total} ครั้ง`;

        if (percentage === 100 && !goalAlreadyCelebrated) {
            showToast('สุดยอด! คุณทำตามเป้าหมายของวันนี้สำเร็จแล้ว!', 'success');
            goalAlreadyCelebrated = true; // Mark as celebrated
            // Trigger confetti
            const canvas = document.createElement('canvas');
            canvas.style.position = 'fixed';
            canvas.style.top = '0';
            canvas.style.left = '0';
            canvas.style.width = '100%';
            canvas.style.height = '100%';
            canvas.style.zIndex = '10002';
            canvas.style.pointerEvents = 'none';
            document.body.appendChild(canvas);
            const myConfetti = confetti.create(canvas, { resize: true });
            myConfetti({
                particleCount: 150,
                spread: 180,
                origin: { y: 0.6 },
                colors: ['#3B82F6', '#22C55E', '#F59E0B', '#FFFFFF']
            });
            setTimeout(() => document.body.removeChild(canvas), 4000);
        }
    }

    function renderDashboardQueue() { 
        let dueTopics = service.getDueTopics(); 
        let learningTopics = service.getLearningTopics(); 

        const dueFlashcards = service.getDueFlashcards();
        if (dueFlashcards.length > 1) {
            ui.dashboard.bulkReviewBtn.style.display = 'inline-flex';
        } else {
            ui.dashboard.bulkReviewBtn.style.display = 'none';
        }

        const isSubjectFilter = service.getSubjectById(currentReviewFilter);

        if (isSubjectFilter) {
            dueTopics = dueTopics.filter(t => t.subjectId === currentReviewFilter);
            learningTopics = learningTopics.filter(t => t.subjectId === currentReviewFilter);
        } else {
            switch (currentReviewFilter) {
                case 'urgent':
                    const urgentStates = ['Learning', 'Relearning'];
                    dueTopics = dueTopics.filter(t => urgentStates.includes(t.state));
                    break;
                case 'leech':
                    const leechIds = service.getLeeches().map(l => l.id);
                    dueTopics = dueTopics.filter(t => leechIds.includes(t.id));
                    learningTopics = learningTopics.filter(t => leechIds.includes(t.id));
                    break;
                case 'overdue':
                    dueTopics = dueTopics.filter(t => t.isOverdue);
                    learningTopics = []; // Overdue filter only shows due cards
                    break;
                case 'all':
                default:
                    break;
            }
        }

        dueTopics.sort((a, b) => {
            if (a.isOverdue !== b.isOverdue) return a.isOverdue ? -1 : 1;
            if (isSortedByPriority) {
                const priorityA = service.getTopicPriority(a).level;
                const priorityB = service.getTopicPriority(b).level;
                if (priorityA !== priorityB) return priorityA - priorityB;
            }
            return new Date(a.nextReview) - new Date(b.nextReview);
        });

        let html = ''; 
        if (dueTopics.length > 0) { 
            html += `<li class="list-divider"><i class="fa-solid fa-star" style="color: var(--accent-color);"></i> พร้อมทบทวน</li>`; 
            html += dueTopics.map((t, index) => { 
                const priority = service.getTopicPriority(t); 
                const overdueClass = t.isOverdue ? 'overdue' : '';
                const topicTypeIcon = t.type === 'flashcard' ? '<i class="fa-solid fa-chalkboard" style="margin-right: 4px; color: var(--info-color);"></i>' : '';
                return `<li class="list-item priority-${priority.key} ${overdueClass}" data-topic-id="${t.id}" style="--animation-order: ${index};"><div class="item-info" data-action="open-topic-details"><span class="priority-indicator">${priority.icon}</span><span class="name">${topicTypeIcon}${t.name}</span><span class="context">${service.getSubjectNameById(t.subjectId)}</span></div><div class="item-actions"><button class="btn btn-sm review-now-btn" data-topic-id="${t.id}"><i class="fas fa-star"></i> ทบทวน</button></div></li>`; 
            }).join(''); 
        } 
        if (learningTopics.length > 0) {
            html += `<li class="list-divider"><i class="fa-solid fa-hourglass-start" style="color: var(--warning-color);"></i> กำลังเรียนรู้ (รอทบทวน)</li>`;
            html += learningTopics.map((t, index) => `<li class="list-item learning-item" data-topic-id="${t.id}" style="--animation-order: ${dueTopics.length + index};"><div class="item-info" data-action="open-topic-details"><span class="name">${t.name}</span><span class="context">${service.getSubjectNameById(t.subjectId)}</span></div><div class="cooldown-timer" data-cooldown-target="${t.nextReview.toISOString()}"><i class="fa-solid fa-clock"></i> <span>--:--</span></div></li>`).join('');
        }

        if (html === '') { 
            let emptyMessage = 'เยี่ยมมาก! ไม่มีหัวข้อที่ต้องทบทวนในขณะนี้';
            if (currentReviewFilter !== 'all') {
                emptyMessage = 'ไม่พบหัวข้อที่ตรงกับฟิลเตอร์นี้';
            } else if (service.getAllTopics().length === 0) {
                emptyMessage = 'ยังไม่มีหัวข้อในระบบเลย<br>คุณต้องการเริ่มต้นอย่างไร?';
            }
            ui.dashboard.todaysQueueList.innerHTML = createEmptyState(emptyMessage, service.getAllTopics().length === 0); 
        } else { 
            ui.dashboard.todaysQueueList.innerHTML = html; 
        } 
    }

    function renderSubjectsPage() { 
        const subjects = service.getAllSubjects(); 
        ui.subjects.list.innerHTML = subjects.length > 0 ? subjects.map((s, index) => `<li class="list-item" data-item-type="subject" data-item-id="${s.id}" style="--animation-order: ${index};"><div class="item-info" data-action="select-subject"><span class="name">${s.name}</span><input type="text" class="edit-input" value="${s.name}" /></div><div class="item-actions"><button class="btn-action-icon edit-btn" data-action="edit-item" title="แก้ไขชื่อ"><i class="fas fa-pencil-alt"></i></button><button class="btn-action-icon delete-btn" data-action="delete-subject" title="ลบบทเรียน"><i class="fas fa-trash-alt"></i></button></div></li>`).join('') : createEmptyState('ยังไม่มีบทเรียน<br>เพิ่มบทเรียนแรกของคุณโดยใช้ปุ่ม + มุมขวาล่าง'); 

        let subjectIdToRender = selectedSubjectId; 
        if (selectedSubjectId) { 
            const selectedLi = ui.subjects.list.querySelector(`[data-item-id="${selectedSubjectId}"]`); 
            if (selectedLi) { 
                selectedLi.classList.add('active'); 
            } else { 
                selectedSubjectId = null; 
                subjectIdToRender = null; 
            } 
        } 

        if (subjectIdToRender) { 
            renderTopicsForSelectedSubject(); 
            renderSubjectMastery(subjectIdToRender);
            ui.subjects.masteryContainer.style.display = 'block';
        } else { 
            ui.subjects.topicsList.innerHTML = createEmptyState('เลือกบทเรียนเพื่อดูหัวข้อทั้งหมด'); 
            ui.subjects.subjectActionsContainer.innerHTML = ''; 
            ui.subjects.masteryContainer.style.display = 'none';
        } 
    }

    function renderSubjectMastery(subjectId) {
        const mastery = service.getSubjectMastery(subjectId);
        ui.subjects.masteryContainer.innerHTML = `
            <div class="card-header">
                <h3><i class="fa-solid fa-graduation-cap"></i> ระดับความเชี่ยวชาญ</h3>
            </div>
            <div style="text-align: center; padding: 1rem;">
                <span class="mastery-rank ${mastery.cssClass}">${mastery.rank}</span>
                <p class="card-description" style="margin-top: 0.5rem; margin-bottom:0;">ค่าความคงทนเฉลี่ย: ${mastery.avgStability.toFixed(2)} วัน</p>
            </div>
        `;
    }

    function renderTopicsForSelectedSubject() {
        const topics = service.getAllTopics()
            .filter(t => t.subjectId === selectedSubjectId)
            .sort((a, b) => a.name.localeCompare(b.name, 'th'));

        const hasActiveTopics = topics.some(t => t.state !== 'Pending');
        if (hasActiveTopics) {
            ui.subjects.subjectActionsContainer.innerHTML = `<button class="btn btn-warning btn-sm" data-action="pause-all-in-subject" title="หยุดพักหัวข้อทั้งหมดในบทเรียนนี้"><i class="fas fa-pause"></i> หยุดพักทั้งหมด</button>`;
        } else {
            ui.subjects.subjectActionsContainer.innerHTML = '';
        }

        ui.subjects.topicsList.innerHTML = topics.length > 0
            ? topics.map((t, index) => {
                const isPending = t.state === 'Pending' || !t.nextReview;
                const topicTypeIcon = t.type === 'flashcard' ? '<i class="fa-solid fa-chalkboard" style="margin-right: 4px; color: var(--info-color);"></i>' : '';
                let actionsAndContextHTML = '';
                if (isPending) {
                    actionsAndContextHTML = `
                        <span class="context">รอดำเนินการ</span>
                        <div class="item-actions">
                            <button class="btn btn-sm btn-success" data-action="start-learning" data-topic-id="${t.id}"><i class="fas fa-play"></i> เริ่มเรียน</button>
                            <button class="btn-action-icon delete-btn" data-action="delete-topic" title="ลบหัวข้อ"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    `;
                } else {
                    actionsAndContextHTML = `
                        <span class="context">ทบทวน: ${formatDate(t.nextReview)}</span>
                        <div class="item-actions">
                            <button class="btn-action-icon" data-action="pause-topic" title="หยุดพัก (กลับไปรอดำเนินการ)"><i class="fas fa-pause-circle"></i></button>
                            <button class="btn-action-icon edit-btn" data-action="edit-item" title="แก้ไขชื่อ"><i class="fas fa-pencil-alt"></i></button>
                            <button class="btn-action-icon" data-action="move-topic" title="ย้ายหัวข้อ"><i class="fa-solid fa-right-left"></i></button>
                            <button class="btn-action-icon delete-btn" data-action="delete-topic" title="ลบหัวข้อ"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    `;
                }
                return `
                    <li class="list-item" data-item-type="topic" data-item-id="${t.id}" style="--animation-order: ${index};">
                        <div class="item-info" data-action="open-topic-details">
                            <span class="name">${topicTypeIcon}${t.name}</span>
                            <input type="text" class="edit-input" value="${t.name}" />
                        </div>
                        ${actionsAndContextHTML}
                    </li>`;
            }).join('')
            : createEmptyState('ยังไม่มีหัวข้อในบทเรียนนี้');
    }

    // --- START: NEW Calendar Functions ---
    function renderCalendarView() {
        const year = calendarDate.getFullYear();
        const month = calendarDate.getMonth();

        // Populate Month/Year selectors
        const monthSelect = document.getElementById('calendar-month-select');
        const yearSelect = document.getElementById('calendar-year-select');

        if (monthSelect.options.length === 0) {
            const thaiMonths = ["มกราคม", "กุมภาพันธ์", "มีนาคม", "เมษายน", "พฤษภาคม", "มิถุนายน", "กรกฎาคม", "สิงหาคม", "กันยายน", "ตุลาคม", "พฤศจิกายน", "ธันวาคม"];
            monthSelect.innerHTML = thaiMonths.map((m, i) => `<option value="${i}">${m}</option>`).join('');
            const currentYear = new Date().getFullYear();
            let yearOptions = '';
            for (let y = currentYear - 5; y <= currentYear + 5; y++) {
                yearOptions += `<option value="${y}">${y + 543}</option>`;
            }
            yearSelect.innerHTML = yearOptions;
        }
        monthSelect.value = month;
        yearSelect.value = year;

        // Prepare topics for the month
        // Prepare topics for the month
        const topicsByDay = new Map();
                const today = new Date();
                today.setHours(0, 0, 0, 0); // ทำให้เป็นเวลาเที่ยงคืนเพื่อการเปรียบเทียบที่แม่นยำ

        service.getAllTopics().forEach(topic => {
                    if (!topic.nextReview) return; // ข้ามหัวข้อที่ไม่มีกำหนดทบทวน

                    let displayDate = new Date(topic.nextReview);

                    // ⭐ นี่คือส่วนตรรกะใหม่: ถ้าเลยกำหนด ให้ย้ายมาแสดงที่วันนี้
                    if (displayDate < today) {
                        displayDate = today;
                    }

                    // ตรวจสอบว่าวันที่ (ที่อาจถูกแก้ไขแล้ว) อยู่ในเดือนที่แสดงผลปัจจุบันหรือไม่
        if (displayDate.getFullYear() === year && displayDate.getMonth() === month) {
                        const dayOfMonth = displayDate.getDate();
        if (!topicsByDay.has(dayOfMonth)) {
        topicsByDay.set(dayOfMonth, []);
        }
        topicsByDay.get(dayOfMonth).push(topic);
        }
        });

        const firstDayOfMonth = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const grid = ui.calendar.grid;
        const dayHeadersGrid = document.getElementById('calendar-day-headers');

        // --- Build Header HTML (Robust way) ---
        const dayHeaders = ['อา', 'จ', 'อ', 'พ', 'พฤ', 'ศ', 'ส'];
        dayHeadersGrid.innerHTML = dayHeaders.map(day => `<div class="calendar-day-header">${day}</div>`).join('');

        // --- Build Calendar Grid HTML (Robust way) ---
        let calendarHtml = '';

        // Add padding for days before the 1st
        for (let i = 0; i < firstDayOfMonth; i++) {
            calendarHtml += `<div class="calendar-day other-month"></div>`;
        }

        // Add actual days
        for (let day = 1; day <= daysInMonth; day++) {
            const currentDate = new Date(year, month, day);
            const today = new Date();
            const isToday = today.getDate() === day && today.getMonth() === month && today.getFullYear() === year;
            const isWeekend = currentDate.getDay() === 0 || currentDate.getDay() === 6;

            // --- FIX THE TIMEZONE BUG ---
            const localDateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;

            let classes = 'calendar-day';
            if (isToday) classes += ' today';
            if (isWeekend) classes += ' weekend';

            let topicsForThisDay = topicsByDay.get(day) || [];
            topicsForThisDay = topicsForThisDay.filter(topic => topic.type === 'normal');
            const eventDotsHtml = topicsForThisDay.length > 0 ? [...new Set(topicsForThisDay.map(t => t.type || 'normal'))].map(type => `<div class="event-dot ${type}"></div>`).join('') : '';

            const maxTopicsToShow = 3;
            const topicsListHtml = topicsForThisDay.slice(0, maxTopicsToShow).map(t => `<li class="topic-item" title="${t.name}">${t.name}</li>`).join('');
            const moreLinkHtml = topicsForThisDay.length > maxTopicsToShow ? `<div class="calendar-day-more" data-action="show-daily-details">+${topicsForThisDay.length - maxTopicsToShow} เพิ่มเติม</div>` : '';

            calendarHtml += `
                <div class="${classes}" data-date="${localDateString}">
                    <div class="calendar-day-header-content">
                        <span class="day-number">${day}</span>
                        <div class="day-event-dots">${eventDotsHtml}</div>
                    </div>
                    <ul class="calendar-topics-list">${topicsListHtml}</ul>
                    ${moreLinkHtml}
                </div>
            `;
        }

        // Set the HTML once
        grid.innerHTML = calendarHtml;
    }

    function renderDailyDetailModal(dateString) {
        // เพิ่ม T12:00:00 เพื่อบังคับให้เป็นเวลาเที่ยงวันในเขตเวลาท้องถิ่น
        const date = new Date(dateString + 'T12:00:00');
        const modal = document.getElementById('daily-detail-modal');
        const title = document.getElementById('daily-detail-modal-title');
        const list = document.getElementById('daily-detail-modal-list');

        title.textContent = `หัวข้อสำหรับวันที่ ${date.toLocaleDateString('th-TH', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}`;

        const topics = service.getAllTopics().filter(t => 
            t.nextReview && t.nextReview.toISOString().slice(0, 10) === dateString && t.type === 'normal'
        ).sort((a,b) => a.nextReview - b.nextReview);

        if (topics.length > 0) {
            list.innerHTML = topics.map(t => {
                const topicTypeIcon = t.type === 'flashcard' ? '<i class="fa-solid fa-chalkboard" style="margin-right: 8px; color: #8b5cf6;"></i>' : '<i class="fa-solid fa-file-alt" style="margin-right: 8px; color: var(--accent-color);"></i>';
                return `
                <li class="list-item" data-topic-id="${t.id}" data-action="open-topic-details" style="cursor: pointer;">
                    <div class="item-info">
                        ${topicTypeIcon}
                        <span class="name">${t.name}</span>
                    </div>
                    <span class="context">${service.getSubjectNameById(t.subjectId)}</span>
                </li>
                `
            }).join('');
        } else {
            list.innerHTML = createEmptyState("ไม่มีหัวข้อที่ต้องทบทวนในวันนี้");
        }

        openModal(modal);
    }
    // --- END: NEW Calendar Functions ---

    function renderTroubleZone() {
        const leeches = service.getLeeches();
        if (leeches.length === 0) {
            ui.troubleZone.leechList.innerHTML = createEmptyState('ยอดเยี่ยม! ตอนนี้คุณไม่มีหัวข้อในโซนอันตราย');
            return;
        }
        const now = new Date();
        const html = leeches.map((t, index) => {
            const againCount = (t.reviewHistory || []).filter(r => r.rating === 'again').length;
            const contextText = `${service.getSubjectNameById(t.subjectId)} | ตอบผิด ${againCount} ครั้ง`;
            const isDue = t.nextReview && new Date(t.nextReview) <= now;
            let actionHtml = '';
            if (isDue) {
                actionHtml = `<div class="item-actions"><button class="btn btn-sm btn-warning review-now-btn" data-topic-id="${t.id}"><i class="fas fa-skull-crossbones"></i> ทบทวนด่วน</button></div>`;
            } else {
                const cooldownText = formatCooldown(t.nextReview);
                actionHtml = `<div class="cooldown-timer" style="margin-left: auto;"><i class="fa-solid fa-clock"></i> <span>${cooldownText}</span></div>`;
            }
            return `<li class="list-item priority-high" data-topic-id="${t.id}" style="--animation-order: ${index};"><div class="item-info" data-action="open-topic-details"><span class="name">${t.name}</span><span class="context">${contextText}</span></div>${actionHtml}</li>`;
        }).join('');
        ui.troubleZone.leechList.innerHTML = html;
    }

    function renderAnalytics() {
        ui.analytics.reasonDetailsCard.style.display = 'none';
        const subjects = service.getAllSubjects();
        ui.analytics.subjectFilter.innerHTML = '<option value="all">ทุกบทเรียน</option>' + subjects.map(s => `<option value="${s.id}">${s.name}</option>`).join('');

        renderSubjectRankings();
        renderReviewHeatmap();
        renderMasteryTrendChart();

        const drawForgetChart = (subjectId = null) => {
            const forgetData = service.getForgetReasonStats(subjectId);
            const labels = Object.keys(forgetData);
            const data = Object.values(forgetData);
            const backgroundColors = ['#3B82F6', '#f59e0b', '#ef4444', '#10b981', '#6b7280', '#f97316', '#14b8a6'];
            if (labels.length > 0) {
                createChart('forget-reasons-chart', 'doughnut', {
                    labels,
                    datasets: [{ label: 'เหตุผลการลืม', data, backgroundColor: labels.map((_, i) => backgroundColors[i % backgroundColors.length]) }]
                }, {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom', labels: { color: getComputedStyle(document.documentElement).getPropertyValue('--primary-text') } } },
                    onClick: (event, elements) => {
                        if (elements.length > 0) {
                            const chartElement = elements[0];
                            const reason = activeCharts['forget-reasons-chart'].data.labels[chartElement.index];
                            const currentSubjectId = ui.analytics.subjectFilter.value === 'all' ? null : ui.analytics.subjectFilter.value;
                            renderReasonDetailsCard(reason, currentSubjectId);
                        }
                    }
                });
            } else {
                destroyChart('forget-reasons-chart');
                const chartWrapper = document.getElementById('forget-reasons-chart').closest('.chart-wrapper');
                chartWrapper.innerHTML = '<canvas id="forget-reasons-chart"></canvas><div class="empty-state" style="padding-top: 5rem;">ยังไม่มีข้อมูลการสะท้อนผล</div>';
            }
        };
        const subjectData = service.getStatsBySubject();
        if(subjectData.labels.length > 0){
            createChart('subjects-overview-chart-in-analytics', 'bar', {
                labels: subjectData.labels,
                datasets: [
                  { label: 'Pending',  data: subjectData.new,      backgroundColor: '#a5baef' }, // สีน้ำเงิน (เหมือนในรูป)
                  { label: 'Learning', data: subjectData.learning, backgroundColor: '#f5d674' }, // สีส้ม (เหมือนในรูป)
                  { label: 'Review',   data: subjectData.review,   backgroundColor: '#adcb8f' }  // สีเขียว (เหมือนในรูป)
                ]
            }, { responsive: true, maintainAspectRatio: false, scales: { x: { stacked: true, ticks: { color: getComputedStyle(document.documentElement).getPropertyValue('--secondary-text') } }, y: { stacked: true, beginAtZero: true, ticks: { color: getComputedStyle(document.documentElement).getPropertyValue('--secondary-text') } } }, plugins: { legend: { labels: { color: getComputedStyle(document.documentElement).getPropertyValue('--primary-text') } } } });
        } else {
            destroyChart('subjects-overview-chart-in-analytics');
            const chartWrapper = document.getElementById('subjects-overview-chart-in-analytics').closest('.chart-wrapper');
            chartWrapper.innerHTML = '<canvas id="subjects-overview-chart-in-analytics"></canvas><div class="empty-state" style="padding-top: 5rem;">ยังไม่มีข้อมูลบทเรียน</div>';
        }

        drawForgetChart();
        ui.analytics.subjectFilter.addEventListener('change', (e) => {
            const subjectId = e.target.value === 'all' ? null : e.target.value;
            drawForgetChart(subjectId);
            ui.analytics.reasonDetailsCard.style.display = 'none';
        });
    }
                        function renderReasonDetailsCard(reason, subjectId) {
                            const topics = service.getTopicsByReason(reason, subjectId);
                            const card = ui.analytics.reasonDetailsCard;
                            ui.analytics.reasonDetailsTitle.innerHTML = `<i class="fa-solid fa-list-ul"></i> หัวข้อที่ลืมเพราะ: <strong>${reason}</strong>`;
                            if (topics.length > 0) {
                                ui.analytics.reasonDetailsList.innerHTML = topics.map((topic, index) => `
                                    <li class="list-item" data-topic-id="${topic.id}" data-action="open-topic-details" style="cursor: pointer; --animation-order: ${index};">
                                        <div class="item-info">
                                            <span class="name">${topic.name}</span>
                                        </div>
                                        <span class="context">${service.getSubjectNameById(topic.subjectId)}</span>
                                    </li>
                                `).join('');
                            } else {
                                ui.analytics.reasonDetailsList.innerHTML = createEmptyState('ไม่พบหัวข้อสำหรับเหตุผลนี้ (หรืออาจเป็นเพราะคุณแก้ปัญหาได้หมดแล้ว)');
                            }
                            card.style.display = 'block';
                            card.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                        }

                        function renderReviewHeatmap() {
                            const container = ui.analytics.reviewHeatmapContainer;
                            if (!container) return;

                            const activityData = service.getReviewActivityForHeatmap();
                            if (Object.keys(activityData).length === 0) {
                                container.innerHTML = `<div class="empty-state">ยังไม่มีประวัติการทบทวน</div>`;
                                return;
                            }

                            const endDate = new Date();
                            const startDate = new Date();
                            startDate.setDate(endDate.getDate() - 365);

                            const dates = {};
                            for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                                const dateStr = d.toISOString().slice(0, 10);
                                dates[dateStr] = { count: activityData[dateStr] || 0 };
                            }

                            let html = '<div class="heatmap-container">';
                            let currentDay = new Date(startDate);
                            // Pad start
                            for(let i=0; i < currentDay.getDay(); i++) {
                                html += '<div class="heatmap-day empty" style="animation:none; opacity:1;"></div>';
                            }

                            for (const dateStr in dates) {
                                const data = dates[dateStr];
                                const count = data.count;
                                let level = 0;
                                if (count > 0 && count <= 2) level = 1;
                                else if (count > 2 && count <= 5) level = 2;
                                else if (count > 5 && count <= 10) level = 3;
                                else if (count > 10) level = 4;

                                const dateObj = new Date(dateStr);
                                const formattedDate = dateObj.toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric' });
                                const tooltip = `${count} ครั้ง on ${formattedDate}`;

                                html += `<div class="heatmap-day level-${level}" data-count="${count}" style="animation:none; opacity:1;">
                                            <div class="heatmap-tooltip">${tooltip}</div>
                                        </div>`;
                            }
                            html += '</div>';
                            container.innerHTML = html;
                        }

                        function renderMasteryTrendChart() {
                            const masteryData = service.getMasteryTrendData();
                            const chartWrapper = ui.analytics.masteryTrendChart.closest('.chart-wrapper');

                            if (masteryData && masteryData.labels.length > 1) {
                                createChart('mastery-trend-chart', 'line', masteryData, {
                                    responsive: true, maintainAspectRatio: false,
                                    scales: {
                                        x: { type: 'time', time: { unit: 'month', tooltipFormat: 'MMM yyyy' }, ticks: { color: getComputedStyle(document.documentElement).getPropertyValue('--secondary-text') } },
                                        y: { beginAtZero: true, title: { display: true, text: 'ค่าความคงทนเฉลี่ย (วัน)' }, ticks: { color: getComputedStyle(document.documentElement).getPropertyValue('--secondary-text') } }
                                    },
                                    plugins: { legend: { display: false } }
                                });
                            } else {
                                destroyChart('mastery-trend-chart');
                                chartWrapper.innerHTML = '<canvas id="mastery-trend-chart"></canvas><div class="empty-state" style="padding-top: 5rem;">ข้อมูลไม่เพียงพอ<br>ทบทวนเพิ่มเติมเพื่อสร้างกราฟ</div>';
                            }
                        }

                        function renderSubjectRankings() {
                            const rankings = service.getSubjectRankings();
                            const list = ui.analytics.subjectRankingsList;
                            if (!list) return;

                            if (rankings.length === 0 || rankings.every(r => r.score === 0)) {
                                list.innerHTML = createEmptyState("ยังไม่มีข้อมูลเพียงพอสำหรับการจัดอันดับ");
                                return;
                            }

                            const maxScore = Math.max(...rankings.map(r => r.score), 0);

                            list.innerHTML = rankings.map((s, index) => {
                                const barWidth = maxScore > 0 ? (s.score / maxScore) * 100 : 0;
                                return `
                                    <li class="list-item" style="--animation-order: ${index};">
                                       <div class="subject-ranking-item">
                                            <span class="rank">#${index + 1}</span>
                                            <div class="details">
                                                <div class="name">${s.name}</div>
                                                <div class="score">Score: ${s.score.toFixed(2)}</div>
                                            </div>
                                            <div class="score-bar" title="Score: ${s.score.toFixed(2)}">
                                                <div class="score-bar-fill" style="width: ${barWidth}%;"></div>
                                            </div>
                                       </div>
                                    </li>
                                `;
                            }).join('');
                        }

                        function renderAchievementsModal() {
                            const unlocked = service.getUnlockedAchievements();
                            const html = Object.keys(ACHIEVEMENT_DEFINITIONS).map((id, index) => {
                                const def = ACHIEVEMENT_DEFINITIONS[id];
                                const isUnlocked = !!unlocked[id];
                                const unlockedDate = isUnlocked ? new Date(unlocked[id].unlockedAt).toLocaleDateString('th-TH', { year: 'numeric', month: 'short', day: 'numeric'}) : '';
                                return `
                                    <li class="list-item" style="--animation-order: ${index};">
                                        <div class="achievement-item ${isUnlocked ? 'unlocked' : ''}">
                                            <div class="icon"><i class="fas ${def.icon}"></i></div>
                                            <div class="details">
                                                <h4>${def.name}</h4>
                                                <p>${def.description}</p>
                                            </div>
                                            ${isUnlocked ? `<div class="date">${unlockedDate}</div>` : ''}
                                        </div>
                                    </li>
                                `;
                            }).join('');
                            ui.modals.achievementsList.innerHTML = html || createEmptyState("ยังไม่มีเหรียญตรา... เริ่มใช้งานเพื่อปลดล็อก!");
                            openModal(ui.modals.achievements);
                        }

                        function renderCustomStudyModal() {
                            const subjects = service.getAllSubjects();
                            ui.modals.customStudySubjects.innerHTML = subjects.map((s, index) => `
                                   <li class="list-item" style="--animation-order: ${index};">
                                       <label class="item-info" for="cs-subject-${s.id}" style="width: 100%;">
                                           <input type="checkbox" id="cs-subject-${s.id}" value="${s.id}" class="custom-study-subject-checkbox">
                                           <span class="name">${s.name}</span>
                                       </label>
                                   </li>
                            `).join('');
                            openModal(ui.modals.customStudy);
                        }

                        function renderSearchResultsDropdown(query) {
                            const results = service.searchTopics(query);
                            const dropdown = ui.searchDropdown;
                            if (results.length > 0) {
                                dropdown.innerHTML = results.map(topic => `
                                    <div class="search-dropdown-item" data-topic-id="${topic.id}">
                                        <span class="name">${topic.name}</span>
                                        <span class="context">${topic.subjectName}</span>
                                    </div>
                                `).join('');
                            } else {
                                dropdown.innerHTML = '<div class="search-dropdown-item empty-state">ไม่พบผลลัพธ์</div>';
                            }
                            dropdown.classList.add('active');
                        }
    // ในฟังก์ชัน runFullAppLogic
    // ในฟังก์ชัน runFullAppLogic
    // ในฟังก์ชัน runFullAppLogic
    // ในฟังก์ชัน runFullAppLogic

    // ⭐ START: ฟังก์ชันที่แก้ไขใหม่ทั้งหมด (คัดลอกทั้งหมดนี้ไปแทนที่ของเดิม)
    // ในฟังก์ชัน runFullAppLogic
    function openTopicDetailsModal(topicId) {
        const topic = service.getTopicById(topicId);
        if (!topic) return;

        // --- 1. ล้างปุ่ม Action และปุ่มทบทวนเก่า (ป้องกันการซ้อน) ---
        const existingReviewBtn = document.getElementById('details-review-now-btn');
        if (existingReviewBtn) existingReviewBtn.remove();
        const mainActionsContainer = document.getElementById('details-main-actions');
        if(mainActionsContainer) mainActionsContainer.innerHTML = '';


        // --- 2. ตั้งค่าข้อมูลพื้นฐานและสถานะการแก้ไข ---
        ui.modals.detailsEditContentBtn.style.display = 'inline-flex';
        ui.modals.detailsSaveContentBtn.style.display = 'none';

        const topicNameElement = ui.modals.detailsTopicName;
        topicNameElement.textContent = topic.name;
        topicNameElement.title = 'คลิกเพื่อแก้ไขชื่อ';
        topicNameElement.style.cursor = 'pointer';

        ui.modals.detailsState.textContent = topic.state || 'New';
        ui.modals.detailsNextReview.textContent = formatDate(topic.nextReview);
        ui.modals.detailsStability.textContent = (topic.stability || 0).toFixed(2);
        ui.modals.detailsDifficulty.textContent = (topic.difficulty || 0).toFixed(2);

        // --- 3. จัดการการแสดงผลเนื้อหา (Normal vs Flashcard) ---
        const normalContainer = ui.modals.detailsContentNormalContainer;
        const flashcardContainer = ui.modals.detailsContentFlashcardContainer;

        if (topic.type === 'flashcard') {
            normalContainer.style.display = 'none';
            flashcardContainer.style.display = 'block';
            ui.modals.detailsFlashcardDisplay.style.display = 'block';
            ui.modals.detailsFlashcardDisplay.innerHTML = `
                <div class="flashcard-display">
                    <div class="flashcard-front"><strong>Front</strong><div class="content-text">${topic.front || '<i>- ว่าง -</i>'}</div></div>
                    <div class="flashcard-back"><strong>Back</strong><div class="content-text">${topic.back || '<i>- ว่าง -</i>'}</div></div>
                </div>`;
            ui.modals.detailsFlashcardEdit.style.display = 'none';
            document.getElementById('details-flashcard-front-edit').value = topic.front || '';
            document.getElementById('details-flashcard-back-edit').value = topic.back || '';
        } else {
            flashcardContainer.style.display = 'none';
            normalContainer.style.display = 'block';
            const content = topic.content || '';
            ui.modals.detailsContentDisplay.style.display = 'block';
            if (content.trim() === '') {
                ui.modals.detailsContentDisplay.innerHTML = `<span style="color: var(--secondary-text);"><i>ยังไม่มีเนื้อหา... คลิก 'แก้ไข' เพื่อเพิ่ม</i></span>`;
            } else {
                ui.modals.detailsContentDisplay.textContent = content;
            }
            ui.modals.detailsContentEdit.style.display = 'none';
            ui.modals.detailsContentEdit.value = content;
        }

        // --- 4. แสดงสถานะ Leech และประวัติการทบทวน ---
        const isLeech = service.getLeeches().some(leech => leech.id === topic.id);
        const aiCoachButton = ui.modals.topicDetails.querySelector('#ai-coach-btn');
        if (aiCoachButton) {
            aiCoachButton.style.display = isLeech ? 'inline-flex' : 'none';
            aiCoachButton.dataset.topicId = topicId;
        }
        ui.modals.aiAnalysisOutput.style.display = 'none';
        ui.modals.aiAnalysisOutput.innerHTML = '';
        const history = topic.reviewHistory || [];
        const ratingMap = { again: 'จำไม่ได้', hard: 'ยาก', good: 'จำได้ดี', easy: 'ง่ายมาก' };
        ui.modals.detailsHistoryList.innerHTML = history.length > 0 ? [...history].reverse().map(h => {
            const reflection = (topic.reflectionHistory || []).find(refl => refl.date === h.date);
            let notesTooltip = '';
            if (reflection && reflection.notes && reflection.notes.trim() !== '') {
                const sanitizedNotes = reflection.notes.replace(/"/g, '&quot;').replace(/\n/g, ' | ');
                notesTooltip = `<span class="tooltip" data-tooltip="${sanitizedNotes}"><i class="fas fa-file-alt"></i></span>`;
            }
            return `<li class="rating-${h.rating}"><div><span class="history-item-rating">${ratingMap[h.rating] || h.rating}</span>${notesTooltip}<div class="history-item-details">S: ${(h.stability || 0).toFixed(2)} | D: ${(h.difficulty || 0).toFixed(2)}</div></div><span class="history-item-date">${new Date(h.date).toLocaleString('th-TH', { dateStyle: 'short', timeStyle: 'medium' })}</span></li>`;
        }).join('') : '<li class="empty-state" style="padding: 1rem 0;">ไม่มีประวัติการทบทวน</li>';

        // --- 5. สร้างปุ่ม Action ทั้งหมด ---
        const modalPrimaryActionsContainer = ui.modals.topicDetails.querySelector('.modal-header-actions');
        const now = new Date();
        if (topic.nextReview && new Date(topic.nextReview) <= now && topic.state !== 'Pending') {
            const reviewButton = document.createElement('button');
            reviewButton.id = 'details-review-now-btn';
            reviewButton.className = 'btn';
            reviewButton.dataset.topicId = topic.id;
            reviewButton.innerHTML = `<i class="fas fa-star"></i> ทบทวนตอนนี้`;
            reviewButton.addEventListener('click', (e) => {
                closeModal(ui.modals.topicDetails);
                initiateReview(e.currentTarget.dataset.topicId);
            });
            modalPrimaryActionsContainer.prepend(reviewButton);
        }

        if (mainActionsContainer) {
            const stateButton = document.createElement('button');
            if (topic.state === 'Pending') {
                stateButton.className = 'btn btn-success';
                stateButton.innerHTML = '<i class="fas fa-play"></i> เริ่มเรียน';
                stateButton.addEventListener('click', async () => {
                    await service.startLearningTopic(topicId);
                    showToast('หัวข้อถูกเพิ่มเข้าคิวทบทวนแล้ว', 'success');
                    closeModal();
                    refreshAllUI();
                });
            } else {
                stateButton.className = 'btn btn-warning';
                stateButton.innerHTML = '<i class="fas fa-pause"></i> หยุดพัก';
                stateButton.addEventListener('click', () => {
                    showConfirmationModal({
                        title: '<i class="fas fa-pause-circle"></i> ยืนยันการหยุดพัก',
                        message: `คุณต้องการหยุดพักหัวข้อ "<strong>${topic.name}</strong>" และย้ายกลับไปสถานะ 'รอดำเนินการ' หรือไม่?`,
                        onConfirm: async () => {
                            await service.pauseTopic(topicId);
                            showToast('หัวข้อถูกย้ายไปรอดำเนินการแล้ว', 'info');
                            closeModal();
                            refreshAllUI();
                        }
                    });
                });
            }
            mainActionsContainer.appendChild(stateButton);

            const moveButton = document.createElement('button');
            moveButton.className = 'btn btn-secondary';
            moveButton.innerHTML = '<i class="fas fa-right-left"></i> ย้าย';
            moveButton.addEventListener('click', () => {
                const subjects = service.getAllSubjects().filter(s => s.id !== topic.subjectId);
                ui.modals.moveTopicName.textContent = `ย้ายหัวข้อ: "${topic.name}"`;
                ui.modals.moveTopicSelect.innerHTML = subjects.length > 0 ? subjects.map(s => `<option value="${s.id}">${s.name}</option>`).join('') : '<option disabled>ไม่มีบทเรียนอื่นให้ย้ายไป</option>';
                ui.modals.moveTopic.dataset.topicId = topic.id;
                openModal(ui.modals.moveTopic);
            });
            mainActionsContainer.appendChild(moveButton);

            const deleteButton = document.createElement('button');
            deleteButton.className = 'btn btn-danger';
            deleteButton.innerHTML = '<i class="fas fa-trash-alt"></i> ลบ';
            deleteButton.addEventListener('click', () => {
                 ui.modals.deleteTopicWarning.innerHTML = `คุณกำลังจะลบหัวข้อ: "<strong>${topic.name}</strong>"<br><br>การกระทำนี้จะลบข้อมูลทั้งหมดที่เกี่ยวข้อง และ <strong>ไม่สามารถย้อนกลับได้</strong>`;
                 ui.modals.deleteTopic.dataset.topicId = topic.id;
                 ui.modals.deleteTopic.dataset.topicName = topic.name;
                 ui.modals.deleteTopicInput.value = "";
                 ui.modals.deleteTopicConfirmBtn.disabled = true;
                 openModal(ui.modals.deleteTopic);
            });
            mainActionsContainer.appendChild(deleteButton);
        }


        // --- 6. จัดการปุ่มดูกราฟ และเปิด Modal ---
        const curveContainer = ui.modals.historyChartContainer;
        const curveBtn = ui.modals.viewHistoryChartBtn;
        destroyChart('topic-history-chart');
        curveContainer.style.display = 'none';
        curveBtn.innerHTML = '<i class="fas fa-chart-line"></i> ดูประวัติความจำ';
        curveBtn.dataset.toggled = 'false';

        if (!topic.reviewHistory || topic.reviewHistory.length < 2) {
            curveBtn.style.display = 'none';
        } else {
            curveBtn.style.display = 'inline-flex';
            // ⭐ START: ส่วนของโค้ดที่ขาดไปและได้เติมให้สมบูรณ์แล้ว
            curveBtn.onclick = () => {
                const isToggled = curveBtn.dataset.toggled === 'true';
                if (isToggled) {
                    curveContainer.style.display = 'none';
                    curveBtn.innerHTML = '<i class="fas fa-chart-line"></i> ดูประวัติความจำ';
                    curveBtn.dataset.toggled = 'false';
                    destroyChart('topic-history-chart');
                } else {
                    const historyData = service.getHistoricalPerformanceData(topicId);
                    if (historyData) {
                        createChart('topic-history-chart', 'line', historyData, {
                            responsive: true, maintainAspectRatio: false,
                            scales: {
                                x: { type: 'time', time: { unit: 'day', tooltipFormat: 'dd MMM yyyy', displayFormats: { day: 'dd MMM' } }, title: { display: true, text: 'วันที่ทบทวน' }, ticks: { color: getComputedStyle(document.documentElement).getPropertyValue('--secondary-text') }},
                                y: { beginAtZero: true, title: { display: true, text: 'ค่าความคงทน (Stability)' }, ticks: { color: getComputedStyle(document.documentElement).getPropertyValue('--secondary-text') } }
                            },
                            plugins: { legend: { display: false }, tooltip: { callbacks: { label: (ctx) => `Stability: ${ctx.parsed.y.toFixed(2)} วัน` } } }
                        });
                        curveContainer.style.display = 'block';
                        curveBtn.innerHTML = '<i class="fas fa-eye-slash"></i> ซ่อนกราฟ';
                        curveBtn.dataset.toggled = 'true';
                    } else {
                        showToast('มีข้อมูลไม่เพียงพอสำหรับสร้างกราฟ', 'info');
                    }
                }
            };
            // ⭐ END: ส่วนของโค้ดที่เติมให้สมบูรณ์แล้ว
        }

        ui.modals.topicDetails.dataset.currentTopicId = topicId;
        openModal(ui.modals.topicDetails);
    }
    // ⭐ END: ฟังก์ชันที่แก้ไขใหม่ทั้งหมด

    // ภายใน openTopicDetailsModal ต้องเรียกใช้ฟังก์ชันย่อยสำหรับการแก้ไขชื่อ
    // อาจจะต้องเพิ่มฟังก์ชันนี้เข้าไปใน runFullAppLogic ด้วย
    function enableTitleEditing(topicId, nameElement) {
        const originalName = nameElement.textContent;
        const input = document.createElement('input');
        input.type = 'text';
        input.value = originalName;
        input.className = 'form-control';
        input.style.fontSize = '1.5rem';
        input.style.fontWeight = '700';
        input.style.height = 'auto';

        nameElement.replaceWith(input);
        input.focus();

        const saveChanges = async () => {
            const newName = input.value.trim();
            if (newName && newName !== originalName) {
                const result = await service.editTopic(topicId, newName);
                if (result.success) {
                    nameElement.textContent = newName;
                    showToast('เปลี่ยนชื่อหัวข้อแล้ว', 'success');
                } else {
                    nameElement.textContent = originalName;
                    showToast(result.message, 'error');
                }
            } else {
                nameElement.textContent = originalName;
            }
            input.replaceWith(nameElement);
            refreshAllUI(); // รีเฟรชเพื่อให้รายการอื่นอัปเดต
        };

        input.addEventListener('blur', saveChanges);
        input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                input.blur();
            } else if (e.key === 'Escape') {
                input.value = originalName;
                input.blur();
            }
        });
    }

    // แก้ไข Event Listener หลักเล็กน้อย เพื่อเรียกใช้ฟังก์ชันแก้ไขชื่อ
    // ใน `runFullAppLogic` หา event listener ของ `document.body`
    // และเพิ่ม case สำหรับการคลิกที่ชื่อหัวข้อใน modal
    ui.modals.detailsTopicName.addEventListener('click', (e) => {
        const topicId = ui.modals.topicDetails.dataset.currentTopicId;
        if(topicId && e.target.tagName === 'H3') { // ตรวจสอบว่าเป็น h3 ก่อนเปลี่ยนเป็น input
            enableTitleEditing(topicId, e.target);
        }
    });
                        function handleItemEdit(target) { const listItem = target.closest('.list-item'); if (!listItem || listItem.classList.contains('editing')) return; document.querySelectorAll('.list-item.editing').forEach(el => el.classList.remove('editing')); listItem.classList.add('editing'); const input = listItem.querySelector('.edit-input'); input.select(); input.focus(); }
                        async function handleItemEditEnd(event) { const input = event.target; if (!input.classList.contains('edit-input')) return; const listItem = input.closest('.list-item'); if (!listItem || !listItem.classList.contains('editing')) return; const itemId = listItem.dataset.itemId, itemType = listItem.dataset.itemType, newName = input.value.trim(), oldName = listItem.querySelector('.name').textContent; listItem.classList.remove('editing'); input.value = oldName; if (newName === oldName || newName === "") return; let result = itemType === 'subject' ? await service.editSubject(itemId, newName) : await service.editTopic(itemId, newName); if (result && !result.success) { showToast(result.message, 'error'); } else { showToast(`${itemType === 'subject' ? 'บทเรียน' : 'หัวข้อ'}ถูกเปลี่ยนชื่อแล้ว`); refreshAllUI(document.querySelector('.view-content.active')?.id.replace('-view','')); } }
                        function renderCountdowns() { const countdowns = service.getCustomCountdowns(); const container = document.getElementById('countdown-container'); if (!container) return; if(countdowns && countdowns.length > 0) { container.innerHTML = countdowns.map((cd, index) => `<div class="countdown-item" style="--animation-order: ${index};"><span class="countdown-title">${cd.name || 'N/A'}</span><div class="countdown-timer" id="countdown-${cd.id}"><div><span data-unit="days">0</span><label>Days</label></div><div><span data-unit="hours">00</span><label>Hours</label></div><div><span data-unit="mins">00</span><label>Mins</label></div><div><span data-unit="secs">00</span><label>Secs</label></div></div></div>`).join(''); } else { container.innerHTML = `<div class="empty-state" style="grid-column: 1 / -1;">ไม่มีรายการนับถอยหลัง<br>คลิก 'แก้ไข' เพื่อเพิ่มรายการใหม่</div>`; } }

    // ในฟังก์ชัน runFullAppLogic

    document.body.addEventListener('click', async (event) => { 
        const target = event.target; 
        if (!target.closest('.search-container')) { 
            ui.searchDropdown.classList.remove('active'); 
        } 
        if (!target.closest('.fab-container')) {
            ui.fab.container.classList.remove('active');
        }
        const searchItem = target.closest('.search-dropdown-item[data-topic-id]');
        if (searchItem) {
            openTopicDetailsModal(searchItem.dataset.topicId);
            ui.searchDropdown.classList.remove('active');
            ui.globalSearchInput.value = '';
            return;
        }

        // --- ⭐ START: โค้ดที่อัปเดตเพื่อบันทึกทันทีที่ปิด ---
        const modalContainer = target.closest('.modal-container');
        if (target.closest('.modal-close-btn') || (modalContainer && !modalContainer.querySelector('.modal-content').contains(event.target) )) { 
            const activeModal = document.querySelector('.modal-container.active');

            // ตรวจสอบว่าเป็นการปิดหน้าต่าง "ทบทวนต่อเนื่อง" หรือไม่
            if (activeModal && activeModal.id === 'review-session-modal' && bulkReviewQueue.length > 0) {
                // ถ้าใช่ ให้เคลียร์คิวและรีเฟรชหน้าจอทันที
                bulkReviewQueue = []; 
                currentBulkReviewIndex = 0;
                showToast('หยุดทบทวนต่อเนื่อง กลับสู่หน้าหลัก', 'info');
                refreshAllUI(); 
            }

            closeModal(); 
            return; 
        } 
        // --- ⭐ END: สิ้นสุดโค้ดที่อัปเดต ---

        const reviewBtn = target.closest('.review-now-btn'); 
        if (reviewBtn) { 
            const topicId = reviewBtn.dataset.topicId; 
            initiateReview(topicId);
            return; 
        } 
        const actionTarget = target.closest('[data-action]'); 
        if (!actionTarget) return; 
        const action = actionTarget.dataset.action; 
        if (action === 'close-modal') { 
            closeModal(); 
            return; 
        } 
        const listItem = actionTarget.closest('.list-item'); 
        const itemId = listItem?.dataset.itemId || listItem?.dataset.topicId || actionTarget.dataset.topicId; 
        switch (action) { 
            case 'logout': auth.signOut(); break; 
            case 'open-topic-details': if (itemId) openTopicDetailsModal(itemId); break; 
            case 'select-subject': if (listItem && !listItem.classList.contains('editing')) { selectedSubjectId = itemId; renderSubjectsPage(); } break; 
            case 'edit-item': handleItemEdit(actionTarget); break; 
            case 'start-learning': {
                if (itemId) {
                    await service.startLearningTopic(itemId);
                    showToast('หัวข้อถูกเพิ่มเข้าคิวทบทวนแล้ว', 'success');
                    refreshAllUI(document.querySelector('.view-content.active')?.id.replace('-view',''));
                }
                break;
            }
            case 'pause-topic': {
                if (itemId) {
                    const topic = service.getTopicById(itemId);
                    if (topic) {
                        showConfirmationModal({
                            title: '<i class="fas fa-pause-circle"></i> ยืนยันการหยุดพัก',
                            message: `คุณต้องการหยุดพักหัวข้อ "<strong>${topic.name}</strong>" และย้ายกลับไปสถานะ 'รอดำเนินการ' หรือไม่?`,
                            confirmClass: 'btn-warning',
                            onConfirm: async () => {
                                await service.pauseTopic(itemId);
                                showToast('หัวข้อถูกย้ายไปรอดำเนินการแล้ว', 'info');
                                refreshAllUI('subjects');
                            }
                        });
                    }
                }
                break;
            }
            case 'pause-all-in-subject': {
                if (selectedSubjectId) {
                    const subject = service.getSubjectById(selectedSubjectId);
                    if(subject) {
                        showConfirmationModal({
                            title: '<i class="fas fa-pause"></i> ยืนยันการหยุดพักทั้งหมด',
                            message: `คุณต้องการหยุดพักหัวข้อที่กำลังเรียนรู้ทั้งหมดในบทเรียน "<strong>${subject.name}</strong>" หรือไม่? การกระทำนี้จะรีเซ็ตสถานะและความคืบหน้าของหัวข้อเหล่านั้น`,
                            confirmClass: 'btn-danger',
                            confirmText: 'ใช่, หยุดพักทั้งหมด',
                            onConfirm: async () => {
                                await service.pauseAllActiveTopicsInSubject(selectedSubjectId);
                                showToast('หัวข้อทั้งหมดในบทเรียนถูกหยุดพักแล้ว', 'success');
                                refreshAllUI('subjects');
                            }
                        });
                    }
                }
                break;
            }
            case 'delete-subject': { const subject = service.getSubjectById(itemId); if (!subject) return; const topicCount = service.getAllTopics().filter(t => t.subjectId === itemId).length; ui.modals.deleteSubjectWarning.innerHTML = `คุณกำลังจะลบบทเรียน <strong>"${subject.name}"</strong> ซึ่งจะทำให้ <strong>หัวข้อทั้งหมด ${topicCount} หัวข้อ</strong> ถูกลบอย่างถาวร<br><br>การกระทำนี้ไม่สามารถย้อนกลับได้`; ui.modals.deleteSubject.dataset.subjectId = subject.id; ui.modals.deleteSubject.dataset.subjectName = subject.name; ui.modals.deleteSubjectInput.value = ""; ui.modals.deleteSubjectConfirmBtn.disabled = true; openModal(ui.modals.deleteSubject); break; } 
            case 'delete-topic': { const topic = service.getTopicById(itemId); if (!topic) return; ui.modals.deleteTopicWarning.innerHTML = `คุณกำลังจะลบหัวข้อ: "<strong>${topic.name}</strong>"<br><br>การกระทำนี้จะลบข้อมูลทั้งหมดที่เกี่ยวข้อง และ <strong>ไม่สามารถย้อนกลับได้</strong>`; ui.modals.deleteTopic.dataset.topicId = topic.id; ui.modals.deleteTopic.dataset.topicName = topic.name; ui.modals.deleteTopicInput.value = ""; ui.modals.deleteTopicConfirmBtn.disabled = true; openModal(ui.modals.deleteTopic); break; } 
            case 'move-topic': { const topic = service.getTopicById(itemId); if (!topic) return; const subjects = service.getAllSubjects().filter(s => s.id !== topic.subjectId); ui.modals.moveTopicName.textContent = `ย้ายหัวข้อ: "${topic.name}"`; ui.modals.moveTopicSelect.innerHTML = subjects.length > 0 ? subjects.map(s => `<option value="${s.id}">${s.name}</option>`).join('') : '<option disabled>ไม่มีบทเรียนอื่นให้ย้ายไป</option>'; ui.modals.moveTopic.dataset.topicId = topic.id; openModal(ui.modals.moveTopic); break; } 
            case 'welcome-add-subject': closeModal(); openModal(ui.modals.addSubject); ui.modals.addSubjectForm.reset(); break; 
        } 
    });
ui.subjects.list.addEventListener('focusout', handleItemEditEnd); ui.subjects.list.addEventListener('keydown', e => { if (e.key === 'Enter') handleItemEditEnd(e); if (e.key === 'Escape') { e.target.closest('.list-item')?.classList.remove('editing'); e.target.value = e.target.closest('.list-item').querySelector('.name').textContent;} });
                        ui.subjects.topicsList.addEventListener('focusout', handleItemEditEnd); ui.subjects.topicsList.addEventListener('keydown', e => { if (e.key === 'Enter') handleItemEditEnd(e); if (e.key === 'Escape') { e.target.closest('.list-item')?.classList.remove('editing'); e.target.value = e.target.closest('.list-item').querySelector('.name').textContent;} });
                        ui.navButtons.forEach(button => button.addEventListener('click', () => switchView(button.dataset.view)));
                        ui.themeToggleBtn.addEventListener('click', () => { document.documentElement.classList.toggle('dark-mode'); localStorage.setItem('theme', document.documentElement.classList.contains('dark-mode') ? 'dark' : 'light'); refreshAllUI(); });
                        ui.globalSearchInput.addEventListener('input', debounce(e => { const query = e.target.value.trim(); if (query) { renderSearchResultsDropdown(query); } else { ui.searchDropdown.classList.remove('active'); } }, 250));
                        ui.fab.mainBtn.addEventListener('click', () => ui.fab.container.classList.toggle('active'));
                        ui.fab.addSubjectBtn.addEventListener('click', () => { ui.modals.addSubjectForm.reset(); openModal(ui.modals.addSubject); ui.fab.container.classList.remove('active'); });
                        ui.fab.addTopicBtn.addEventListener('click', () => { const subjects = service.getAllSubjects(); if (subjects.length === 0) { showToast('กรุณาสร้างบทเรียนก่อน', 'error'); switchView('subjects'); ui.fab.container.classList.remove('active'); return; } ui.modals.addTopicSelect.innerHTML = subjects.map(s => `<option value="${s.id}">${s.name}</option>`).join(''); if (selectedSubjectId) { ui.modals.addTopicSelect.value = selectedSubjectId; } ui.modals.addTopicForm.reset(); ui.modals.addTopicInput.value = ''; openModal(ui.modals.addTopic); ui.fab.container.classList.remove('active'); });

                        ui.modals.addTopicForm.addEventListener('change', e => {
                            if (e.target.name === 'topic-type') {
                                const normalContent = document.getElementById('add-topic-content-normal');
                                const flashcardContent = document.getElementById('add-topic-content-flashcard');
                                if (e.target.value === 'flashcard') {
                                    normalContent.style.display = 'none';
                                    flashcardContent.style.display = 'block';
                                } else {
                                    normalContent.style.display = 'block';
                                    flashcardContent.style.display = 'none';
                                }
                            }
                        });

                        ui.modals.addTopicForm.addEventListener('submit', async (e) => {
                            e.preventDefault();
                            const name = ui.modals.addTopicInput.value.trim();
                            const subjectId = ui.modals.addTopicSelect.value;
                            const type = ui.modals.addTopicForm.querySelector('input[name="topic-type"]:checked').value;

                            const topicData = { name, subjectId, type };
                            if (type === 'flashcard') {
                                topicData.front = document.getElementById('new-topic-front').value.trim();
                                topicData.back = document.getElementById('new-topic-back').value.trim();
                            } else {
                                topicData.content = document.getElementById('new-topic-content').value.trim();
                            }

                            if (name && subjectId) {
                                const result = await service.addTopic(topicData);
                                if (result.success) {
                                    closeModal();
                                    await checkAllAchievements('ADD_TOPIC', {});
                                    refreshAllUI(document.querySelector('.view-content.active')?.id.replace('-view',''));
                                    showToast(`เพิ่มหัวข้อ "${result.topic.name}" แล้ว`);
                                } else {
                                    showToast(result.message, 'error');
                                }
                            }
                        });

                        ui.modals.addSubjectForm.addEventListener('submit', async (e) => { e.preventDefault(); const name = ui.modals.addSubjectInput.value.trim(); if (name) { const result = await service.addSubject(name); if(result.success) { showToast(`เพิ่มบทเรียน "${name}" แล้ว`); closeModal(); refreshAllUI('subjects'); } else { showToast(result.message, 'error'); } } });

                        ui.modals.reviewSession.addEventListener('click', async (e) => {
                            const ratingBtn = e.target.closest('.btn-rate');
                            const showAnswerBtn = e.target.closest('#review-show-answer-btn');

                            if (showAnswerBtn) {
                                const topic = service.getTopicById(currentTopicIdForModal);
                                if (topic) {
                                    ui.modals.reviewContentArea.innerHTML = topic.back || '<i>- ว่าง -</i>';
                                    ui.modals.reviewShowAnswerBtn.style.display = 'none';
                                    ui.modals.reviewRatingButtons.style.display = 'grid';
                                }
                            }

                            if (ratingBtn) {
                                const rating = ratingBtn.dataset.rating;
                                const topicId = currentTopicIdForModal;
                                const wasLeech = service.getLeeches().some(l => l.id === topicId);

                                const result = await service.updateTopicRating(topicId, rating);

                                const isInBulkReview = bulkReviewQueue.length > 0;

                                // Always check for achievements after a review
                                await checkAllAchievements('REVIEW_COMPLETE', { topicId, wasLeech });

                                if (rating === 'again' || rating === 'hard') {
                                    currentReflectionData = { topicId, date: result.date, rating };
                                    const topic = service.getTopicById(topicId);
                                    ui.modals.reflectionName.textContent = `สะท้อนผล: ${topic.name}`;
                                    ui.modals.reflectionForm.reset();

                                    if(!isInBulkReview) closeModal(ui.modals.reviewSession);
                                    openModal(ui.modals.reflection);

                                } else if (isInBulkReview) {
                                    // Don't close modal, just advance
                                } else {
                                    closeModal(ui.modals.reviewSession);
                                    refreshAllUI();
                                    showToast('บันทึกการทบทวนแล้ว!');
                                }

                                if(isInBulkReview) {
                                    advanceBulkReview();
                                }
                            }
                        });

                        ui.modals.reflectionForm.addEventListener('submit', async (e) => { e.preventDefault(); const reasons = [...e.target.querySelectorAll('input[name="reason"]:checked')].map(cb => cb.value.trim()); const notes = ui.modals.reflectionNotes.value.trim(); if (reasons.length === 0) { showToast('กรุณาเลือกเหตุผลอย่างน้อย 1 ข้อ', 'error'); return; } await service.logReflection(currentReflectionData.topicId, currentReflectionData.date, currentReflectionData.rating, reasons, notes); closeModal(); refreshAllUI(); showToast('บันทึกการสะท้อนผลแล้ว'); });

                        ui.modals.detailsEditContentBtn.addEventListener('click', () => {
                            const topicId = ui.modals.topicDetails.dataset.currentTopicId;
                            const topic = service.getTopicById(topicId);
                            if (!topic) return;

                            if (topic.type === 'flashcard') {
                                ui.modals.detailsFlashcardDisplay.style.display = 'none';
                                ui.modals.detailsFlashcardEdit.style.display = 'block';
                            } else {
                                ui.modals.detailsContentDisplay.style.display = 'none';
                                ui.modals.detailsContentEdit.style.display = 'block';
                                ui.modals.detailsContentEdit.focus();
                            }

                            ui.modals.detailsEditContentBtn.style.display = 'none';
                            ui.modals.detailsSaveContentBtn.style.display = 'inline-flex';
                        });

                        ui.modals.detailsSaveContentBtn.addEventListener('click', async () => {
                            const topicId = ui.modals.topicDetails.dataset.currentTopicId;
                            if (!topicId) return;

                            const topic = service.getTopicById(topicId);
                            let updates = {};
                            if (topic.type === 'flashcard') {
                                updates.front = document.getElementById('details-flashcard-front-edit').value;
                                updates.back = document.getElementById('details-flashcard-back-edit').value;
                            } else {
                                updates.content = ui.modals.detailsContentEdit.value;
                            }

                            const result = await service.updateTopicData(topicId, updates);
                            if (result.success) {
                                showToast('บันทึกเนื้อหาเรียบร้อยแล้ว', 'success');
                                // Re-render the modal with fresh data instead of just hiding/showing
                                openTopicDetailsModal(topicId); 
                            } else {
                                showToast(result.message, 'error');
                            }
                        });

                        ui.dashboard.sortQueueBtn.addEventListener('click', () => { isSortedByPriority = !isSortedByPriority; ui.dashboard.sortQueueBtn.innerHTML = isSortedByPriority ? `<i class="fa-solid fa-clock"></i> เรียงตามเวลา` : `<i class="fa-solid fa-sort-amount-down"></i> เรียงตามความสำคัญ`; ui.dashboard.sortQueueBtn.classList.toggle('btn-primary', isSortedByPriority); ui.dashboard.sortQueueBtn.classList.toggle('btn-secondary', !isSortedByPriority); renderDashboardQueue(); });
                        ui.dashboard.viewForecastBtn.addEventListener('click', () => { const forecastData = service.getFutureReviewForecast(30); createChart('forecast-chart', 'bar', forecastData, { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top', labels: {color: getComputedStyle(document.documentElement).getPropertyValue('--primary-text')}}, tooltip: { mode: 'index', intersect: false } }, scales: { x: { stacked: true, ticks: {color: getComputedStyle(document.documentElement).getPropertyValue('--secondary-text')} }, y: { stacked: true, beginAtZero: true, title: { display: true, text: 'จำนวนหัวข้อ' }, ticks: {color: getComputedStyle(document.documentElement).getPropertyValue('--secondary-text')} } } }); openModal(ui.modals.forecast); });
                        ui.modals.aiCoachBtn.addEventListener('click', (e) => { const topicId = e.target.dataset.topicId; const analysis = service.getAIAnalysisForLeech(topicId); ui.modals.aiAnalysisOutput.innerHTML = `<div class="ai-analysis-container"><h4><i class="fas fa-robot"></i> AI Coach's Diagnosis</h4><p style="white-space: pre-wrap;"></p></div>`; ui.modals.aiAnalysisOutput.style.display = 'block'; const p = ui.modals.aiAnalysisOutput.querySelector('p'); typewriterEffect(p, analysis, 10); });
                        document.getElementById('settings-btn').addEventListener('click', () => { const settings = service.getSettings(); document.getElementById('daily-goal-input').value = settings.dailyReviewGoal; document.getElementById('new-topics-per-day-input').value = settings.newTopicsPerDay || 0; const recContainer = document.getElementById('daily-goal-recommendation'); const recommendation = service.getRecommendedDailyGoal(); if(recommendation) { recContainer.innerHTML = `<i class="fas fa-lightbulb"></i> <strong>คำแนะนำ:</strong> ${recommendation.reason} <a href="#" data-action="apply-recommendation" data-value="${recommendation.value}" style="color: var(--accent-color); font-weight: bold;">[ใช้ค่านี้]</a>`; recContainer.style.display = 'block'; } else { recContainer.style.display = 'none'; } openModal(ui.modals.settings); });
                        ui.modals.settings.addEventListener('click', e => { if (e.target.dataset.action === 'apply-recommendation') { e.preventDefault(); const goalInput = document.getElementById('daily-goal-input'); goalInput.value = e.target.dataset.value; goalInput.focus(); goalInput.style.transition = 'none'; goalInput.style.backgroundColor = 'var(--accent-light)'; setTimeout(() => { goalInput.style.transition = 'all 0.2s ease'; goalInput.style.backgroundColor = ''; }, 500); }});
                        ui.modals.settingsForm.addEventListener('submit', async (e) => { e.preventDefault(); const goal = parseInt(document.getElementById('daily-goal-input').value, 10); const newTopics = parseInt(document.getElementById('new-topics-per-day-input').value, 10); if (goal > 0 && newTopics >= 0) { await service.saveSettings({ dailyReviewGoal: goal, newTopicsPerDay: newTopics }); showToast('บันทึกการตั้งค่าแล้ว', 'success'); closeModal(ui.modals.settings); refreshAllUI(); } else { showToast('ค่าไม่ถูกต้อง', 'error'); } });
                        ui.modals.deleteSubjectInput.addEventListener('input', (e) => { ui.modals.deleteSubjectConfirmBtn.disabled = e.target.value.trim() !== ui.modals.deleteSubject.dataset.subjectName; });
                        ui.modals.deleteSubjectConfirmBtn.addEventListener('click', async () => { const subjectId = ui.modals.deleteSubject.dataset.subjectId; await service.deleteSubject(subjectId); if (selectedSubjectId === subjectId) selectedSubjectId = null; closeModal(); refreshAllUI('subjects'); showToast('ลบบทเรียนแล้ว', 'success'); });
                        ui.modals.deleteTopicInput.addEventListener('input', (e) => { ui.modals.deleteTopicConfirmBtn.disabled = e.target.value.trim() !== ui.modals.deleteTopic.dataset.topicName; });
                        ui.modals.deleteTopicConfirmBtn.addEventListener('click', async () => { const topicId = ui.modals.deleteTopic.dataset.topicId; await service.deleteTopic(topicId); closeModal(); refreshAllUI(document.querySelector('.view-content.active')?.id.replace('-view', '')); showToast('ลบหัวข้อแล้ว', 'success'); });
                        ui.modals.moveTopicForm.addEventListener('submit', async (e) => { e.preventDefault(); const topicId = ui.modals.moveTopic.dataset.topicId; const newSubjectId = ui.modals.moveTopicSelect.value; if(topicId && newSubjectId) { const result = await service.moveTopic(topicId, newSubjectId); if(result.success) { closeModal(); refreshAllUI('subjects'); showToast('ย้ายหัวข้อสำเร็จแล้ว', 'success'); } else { showToast(result.message, 'error'); } } else if (!newSubjectId) { showToast('ไม่มีบทเรียนปลายทางให้เลือก', 'error'); } });
    const renderCountdownEditor = () => {
        const countdowns = service.getCustomCountdowns();
        const listContainer = document.getElementById('countdown-editor-list');
        listContainer.innerHTML = countdowns.map((cd, index) => {
            let dateValue = '';
            if (cd.targetDate) {
                const d = new Date(cd.targetDate);
                if (!isNaN(d.getTime())) {
                    // --- START: นี่คือส่วนที่แก้ไขปัญหา Timezone ---
                    const pad = (num) => String(num).padStart(2, '0');
                    const year = d.getFullYear();
                    const month = pad(d.getMonth() + 1);
                    const day = pad(d.getDate());
                    const hours = pad(d.getHours());
                    const minutes = pad(d.getMinutes());
                    dateValue = `${year}-${month}-${day}T${hours}:${minutes}`;
                    // --- END: สิ้นสุดส่วนที่แก้ไข ---
                }
            }
            const nameValue = cd.name || '';
            return `
                <div class="countdown-editor-item" data-id="${cd.id}" style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 1rem; align-items: flex-end; padding-bottom: 1rem; margin-bottom: 1rem; border-bottom: 1px solid var(--border-color);">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="cd-name-${index}">ชื่อรายการ</label>
                        <input type="text" class="cd-name-input" value="${nameValue}" required>
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="cd-date-${index}">วันและเวลาสิ้นสุด</label>
                        <input type="datetime-local" class="cd-date-input" value="${dateValue}" required>
                    </div>
                    <button type="button" class="btn btn-danger btn-icon delete-countdown-btn"><i class="fas fa-trash-alt"></i></button>
                </div>
            `;
        }).join('');
    };
                        const addNewCountdownToEditor = () => { const listContainer = document.getElementById('countdown-editor-list'); const newId = `new-${Date.now()}`; const newItemHTML = ` <div class="countdown-editor-item" data-id="${newId}" style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 1rem; align-items: flex-end; padding-bottom: 1rem; margin-bottom: 1rem; border-bottom: 1px solid var(--border-color);"> <div class="form-group" style="margin-bottom: 0;"> <label>ชื่อรายการใหม่</label> <input type="text" class="cd-name-input" placeholder="เช่น สอบ PAT1" required> </div> <div class="form-group" style="margin-bottom: 0;"> <label>วันและเวลาสิ้นสุด</label> <input type="datetime-local" class="cd-date-input" required> </div> <button type="button" class="btn btn-danger btn-icon delete-countdown-btn"><i class="fas fa-trash-alt"></i></button> </div>`; listContainer.insertAdjacentHTML('beforeend', newItemHTML); };
                        ui.dashboard.editCountdownBtn.addEventListener('click', () => { renderCountdownEditor(); openModal(ui.modals.editCountdown); });
                        document.getElementById('add-new-countdown-btn').addEventListener('click', addNewCountdownToEditor);
                        ui.modals.editCountdownForm.addEventListener('click', (e) => { if (e.target.closest('.delete-countdown-btn')) { e.target.closest('.countdown-editor-item').remove(); } });
                        ui.modals.editCountdownForm.addEventListener('submit', async (e) => { e.preventDefault(); const newCountdowns = []; const items = document.querySelectorAll('.countdown-editor-item'); let isValid = true; items.forEach(item => { const id = item.dataset.id; const nameInput = item.querySelector('.cd-name-input'); const dateInput = item.querySelector('.cd-date-input'); if (!nameInput.value || !dateInput.value) { isValid = false; } newCountdowns.push({ id: id.startsWith('new-') ? Date.now().toString() : id, name: nameInput.value.trim(), targetDate: dateInput.value }); }); if (!isValid) { showToast('กรุณากรอกข้อมูลให้ครบทุกช่อง', 'error'); return; } const result = await service.saveCustomCountdowns(newCountdowns); if (result.success) { closeModal(); renderCountdowns(); showToast('บันทึกเวลานับถอยหลังแล้ว', 'success'); } else { showToast(result.message, 'error'); } });
    // ในฟังก์ชัน runFullAppLogic

    ui.dashboard.bulkReviewBtn.addEventListener('click', () => {
        // --- START: ตรรกะใหม่ในการดึงและเรียงลำดับข้อมูล ---
        let dueTopics = service.getDueTopics();
        const isSubjectFilter = service.getSubjectById(currentReviewFilter);

        if (isSubjectFilter) {
            dueTopics = dueTopics.filter(t => t.subjectId === currentReviewFilter);
        } else {
            switch (currentReviewFilter) {
                case 'urgent':
                    const urgentStates = ['Learning', 'Relearning'];
                    dueTopics = dueTopics.filter(t => urgentStates.includes(t.state));
                    break;
                case 'leech':
                    const leechIds = service.getLeeches().map(l => l.id);
                    dueTopics = dueTopics.filter(t => leechIds.includes(t.id));
                    break;
                case 'overdue':
                    dueTopics = dueTopics.filter(t => t.isOverdue);
                    break;
            }
        }

        // ใช้การจัดเรียงปัจจุบัน (isSortedByPriority)
        dueTopics.sort((a, b) => {
            if (a.isOverdue !== b.isOverdue) return a.isOverdue ? -1 : 1;
            if (isSortedByPriority) {
                const priorityA = service.getTopicPriority(a).level;
                const priorityB = service.getTopicPriority(b).level;
                if (priorityA !== priorityB) return priorityA - priorityB;
            }
            return new Date(a.nextReview) - new Date(b.nextReview);
        });

        // กรองเอาเฉพาะ Flashcard จากรายการที่จัดเรียงแล้ว
        const sortedFlashcards = dueTopics.filter(t => t.type === 'flashcard');

        if (sortedFlashcards.length > 0) {
            startBulkReview(sortedFlashcards);
        } else {
            showToast('ไม่พบ Flashcard ที่ต้องทบทวนในมุมมองนี้', 'info');
        }
        // --- END: สิ้นสุดตรรกะใหม่ ---
    });
                        ui.headerActions.achievementsBtn.addEventListener('click', renderAchievementsModal);
                        ui.headerActions.customStudyBtn.addEventListener('click', renderCustomStudyModal);
                        ui.modals.customStudyForm.addEventListener('submit', (e) => {
                            e.preventDefault();
                            const selectedSubjectIds = [...ui.modals.customStudySubjects.querySelectorAll('input:checked')].map(cb => cb.value);
                            const filterType = ui.modals.customStudyFilterType.value;
                            const topicsToReview = service.getCustomStudyTopics({ subjectIds: selectedSubjectIds, filterType });

                            if (topicsToReview.length === 0) {
                                showToast('ไม่พบหัวข้อที่ตรงตามเงื่อนไขที่คุณเลือก', 'info');
                                return;
                            }

                            closeModal(ui.modals.customStudy);
                            startBulkReview(topicsToReview);
                        });


                        (function initialize() {
                            const savedTheme = localStorage.getItem('theme'); if (savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches)) { document.documentElement.classList.add('dark-mode'); } else { document.documentElement.classList.remove('dark-mode'); }
                            const updateCountdown = () => { service.getCustomCountdowns().forEach(cd => { const el = document.getElementById(`countdown-${cd.id}`); if (!el) return; const diff = (new Date(cd.targetDate).getTime() - Date.now()) / 1000; if(diff < 0) { el.innerHTML = `<span style="font-size: 1.2rem; color: var(--secondary-text);">การนับถอยหลังสิ้นสุดแล้ว</span>`; return; } const d = Math.floor(diff / 86400), h = Math.floor(diff % 86400 / 3600), m = Math.floor(diff % 3600 / 60), s = Math.floor(diff % 60); el.querySelector('[data-unit="days"]').textContent = d; el.querySelector('[data-unit="hours"]').textContent = h.toString().padStart(2, '0'); el.querySelector('[data-unit="mins"]').textContent = m.toString().padStart(2, '0'); el.querySelector('[data-unit="secs"]').textContent = s.toString().padStart(2, '0'); }); };
                            renderCountdowns();
                            updateCountdown();
                            setInterval(updateCountdown, 1000);

                            const runAndNotifyDailyTasks = async () => { const { startedCount } = await service.runDailyTasks(); if (startedCount > 0) { showToast(`${startedCount} หัวข้อใหม่ถูกเริ่มเรียนให้อัตโนมัติ`, 'success'); refreshAllUI(); } };
                            runAndNotifyDailyTasks();

                            refreshAllUI('dashboard');
                            document.getElementById('start-onboarding-btn')?.addEventListener('click', () => { closeModal(ui.modals.welcome); setTimeout(() => { ui.fab.addSubjectBtn.click(); }, 350); });
                            if (service.getAllSubjects().length === 0 && service.getAllTopics().length === 0) { setTimeout(() => openModal(ui.modals.welcome), 500); }

                            initializeLayout();

                            const todaysReviewCard = document.getElementById('todays-review');
                            if (todaysReviewCard) {
                                todaysReviewCard.addEventListener('click', (e) => {
                                    const clickedButton = e.target.closest('.review-cat-btn');
                                    if (!clickedButton) return;

                                    currentReviewFilter = clickedButton.dataset.filter;

                                    todaysReviewCard.querySelectorAll('.review-cat-btn').forEach(btn => btn.classList.remove('active'));
                                    todaysReviewCard.querySelectorAll(`[data-filter="${currentReviewFilter}"]`).forEach(btn => btn.classList.add('active'));

                                    if (clickedButton.dataset.action === 'reset-view') {
                                        isSortedByPriority = true; // Reset to default true
                                        ui.dashboard.sortQueueBtn.innerHTML = `<i class="fa-solid fa-clock"></i> เรียงตามเวลา`;
                                        ui.dashboard.sortQueueBtn.classList.add('btn-secondary');
                                        ui.dashboard.sortQueueBtn.classList.remove('btn-primary');
                                    }

                                    renderDashboardQueue();
                                });
                            }
    // --- NEW: Calendar Event Listeners ---
    ui.calendar.prevBtn.addEventListener('click', () => {
        calendarDate.setMonth(calendarDate.getMonth() - 1);
        renderCalendarView();
    });

    ui.calendar.nextBtn.addEventListener('click', () => {
        calendarDate.setMonth(calendarDate.getMonth() + 1);
        renderCalendarView();
    });

    document.getElementById('calendar-today-btn').addEventListener('click', () => {
        calendarDate = new Date();
        renderCalendarView();
    });

    document.getElementById('calendar-month-select').addEventListener('change', (e) => {
        calendarDate.setMonth(parseInt(e.target.value, 10));
        renderCalendarView();
    });

    document.getElementById('calendar-year-select').addEventListener('change', (e) => {
        calendarDate.setFullYear(parseInt(e.target.value, 10));
        renderCalendarView();
    });

    ui.calendar.grid.addEventListener('click', (e) => {
        const dayCell = e.target.closest('.calendar-day:not(.other-month)');
        if (dayCell) {
            const dateString = dayCell.dataset.date;
            renderDailyDetailModal(dateString);
        }
    });

    document.getElementById('daily-detail-modal-list').addEventListener('click', (e) => {
        const listItem = e.target.closest('.list-item[data-topic-id]');
        if (listItem) {
            closeModal(document.getElementById('daily-detail-modal'));
            openTopicDetailsModal(listItem.dataset.topicId);
        }
    });
                        })();
                    }
        });
    </script>
    </body>
    </html>
